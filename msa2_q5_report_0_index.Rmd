---
title: "MSA Quarterly Report"
output:
  word_document:
    fig_height: 5
    fig_width: 7
    reference_docx: msa2_Q2_reference.docx
    toc: yes
  html_document:
    number_sections: no
    toc: yes
  pdf_document:
    toc: yes
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  end_date: !r as.Date("2019-03-31")
  start_date: !r as.Date("2019-01-01")
---

---
subtitle: "Reporting period `r format(params$start_date, '%m/%d/%Y')` to `r format(params$end_date, '%m/%d/%Y')`"
---

```{r libraries, include=FALSE}
#Note: Change the end_date and start_date parameters above to the start and end date of the current reporting quarter;
# For Q1 2019, this will be "2019-01-01" and "2019-03-31"

#library(mdcpsde2)
library(magrittr)
library(feather)
library(lubridate)
library(Cairo)
library(readxl)
library(dplyr)
library(stringr)
library(odbc)
library(knitr)
library(fuzzyjoin)
library(zoo)
tn = local({
  i = 0
  function(x) {
    i <<- i + 1
    paste('\n\n:Table ', i, ': ', x, sep = '')
    # The : before Table tells pandoc to wrap your caption in <caption></caption>
  }
})
knit_hooks$set(tab.cap = function(before, options, envir) {
  if(!before)
    tn(options$tab.cap)
})
default_output_hook = knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  if (is.null(options$tab.cap) == F)  
    x
  else
    default_output_hook(x,options)
})

# This code establishes the connection to the sql database used for reporting; Usually a reporting snapshot of EDW is taken on the 15th or 16th of the month following the end of the quarter. To test or run drafts of the report change nDatabase=EDW or to teh next reporting snapshot taken
con <- dbConnect(odbc::odbc(), .connection_string = "Driver={SQL Server};Server=10.160.96.35;\nDatabase=EDW_APR_16_2019;\nUID=fcsadmin;\nPWD=Welcome1;\nPort=1433;")

oldw <- getOption("warn")
 options(warn = -1)

 options(warn = oldw)

 
 # Generic function created to save all .csv files with the same format:
 # The format is run_date, start_date of the date, end date of the data, file name, sub-folder name
 save_files <- function(data, date1, date2, date3, filename, sub_dir = NA){
   dir.create(sub_dir, showWarnings = F)

   file_path <- if(!is.na(sub_dir)){
     paste(
       sub_dir,
       paste(
         format(date1, '%Y%m%d'),
         format(date2, '%Y%m%d'),
         format(date3, '%Y%m%d'),
         filename,
         sep = '_'
       ),
       sep = '/'
     )
   } else {
    paste(
     format(date1, '%Y%m%d'),
       format(date2, '%Y%m%d'),
       format(date3, '%Y%m%d'),
       filename,
       sep = '_'
     )
    }
   readr::write_csv(data, paste0(file_path, '.csv'))
   return(data)
 }
```

```{r timeframes, include=FALSE}
quarter_frame <- function(from = Sys.Date(), to = Sys.Date()) {
  data.frame(
    'Quarter' = zoo::as.yearqtr(seq.Date(from, to, by='quarters')),
    'Quarter Start' = seq.Date(from, to, by='quarter'),
    'Quarter End' = lubridate::ceiling_date(
      seq.Date(from, to, by='quarters')
      , unit = 'quarters'
    ) - lubridate::days(1),
    'Children in-care, Q Start' = "",
    'Entries into Care' = "",
    'Exits from Care' = "",
    'In-care, Q End' = "",
    check.names = F
  )
}

# Assign start date variable for beginning of 2nd MSA; this is hardcoded and does not need to change
msa_start <- as.Date("2018-01-01")

# Assign start and end date variables for current reporting period; params$start_start date and params$end_date are changed by changing the dates in the YAML header at the top of the RMD report
period_start_date <- as.Date(params$start_date)
currentq_start  <- as.Date(params$start_date)
period_end_date <- as.Date(params$end_date)

# Creates data frames for containing month/quarter name, month/quarter start date, and month quarter end date
msa_quarters <- quarter_frame(msa_start, period_end_date)
#msa_months  <- month_frame(msa_start, period_end_date)
# 127 commented by syed for trial and error

# Create current quarter variable
current_quarter <- max(msa_quarters$Quarter)

# Create expanded start date and cut-off date variables
period_censor_date <- as.Date("2019-04-15") # manually update to the reporting database; for q4 the snapshot was taken on 1/15/19, so that date was used here
expanded_start <- as.Date("2017-10-01") # static date that has been agreed upon between MDCPS and Kurt Heisler

expanded_end <- period_censor_date

# Create a start date variable for Section 7 of 2nd MSA. DO not have to change
msa_7.0_start <- as.Date("2018-07-01")

for (i in 1:nrow(msa_quarters)) {
  name_start <- paste("quarter", i, "_start", sep = "")
  name_end <- paste("quarter", i, "_end", sep = "")
  assign(name_start, as.Date(msa_quarters[i, 2], origin = "1970-01-01"))
  assign(name_end, as.Date(msa_quarters[i, 3], origin = "1970-01-01"))
}
# 148 to 147 Time being commented by syed
# for (i in 1:nrow(msa_months)) {
#   name_start <- paste("month", i, "_start", sep = "")
#   name_end <- paste("month", i, "_end", sep = "")
#   assign(name_start, as.Date(msa_months[i, 2], origin = "1970-01-01"))
#   assign(name_end, as.Date(msa_months[i, 3], origin = "1970-01-01"))
# }


# Create start and end date variables to be uased in sql queries 
sql_expanded_start <- gsub("-", "", expanded_start)
sql_period_censor_end <- gsub("-", "", period_censor_date)
sql_expanded_end <- gsub("-", "", period_censor_date)

#
prior_year_start <- params$end_date - years(1) + 1
prior_year_end <- params$end_date

# 
ec_year_start <- params$end_date - years(2) + 1
ec_year_end <- params$end_date - years(1)

#
tpr_msa_start <- params$end_date %m-% months(22)
tpr_period_end_date <- params$end_date
 
# Create arbitrary start date used for several functions in the MDCPSDE2 package
arbitrarystart <- params$end_date - years(23)
```

```{r pop_over, include=FALSE}
# This chunk creates the expanded population of children served between 2017-10-01 and the period censor date, the quarterly incare, entries, exits summary file for the report, and sets up some files for later use.

# Creates a file and object of all children in custody sometime betwen the two dates given and includes service outcome if they exited custody
expanded_pop_details <- custody_children(expanded_start, period_censor_date) %>%
  dplyr::left_join(custody_outcomes(expanded_start, period_censor_date)) %>%
  dplyr::distinct(`child_id`, custody_start,.keep_all = TRUE) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'expanded_population_details', 'population_overview')

# Creates an object for children that were in custody at some point during te current quarter
currentq_pop_details <- expanded_pop_details %>%
  filter(custody_start <= period_end_date,
        (is.na(custody_end)|custody_end >= currentq_start))
  

Quarters <- as.character(zoo::as.yearqtr(seq.Date(msa_start, period_end_date, by='quarters')))
summary_fields_tb1 <- c('Children in-care, Q Start','Entries into Care','Exits from Care','In-care, Q End')
df <- expanded_pop_details

# Cutsom function that calculates the children in custody at the start of the period, end of the period, entries into, and exits from custody during the period
incare_sum <- function(from, to) {
  a <- sum(expanded_pop_details$custody_start < from & (is.na(expanded_pop_details$custody_end)|expanded_pop_details$custody_end >= from))
  
  b <- sum(expanded_pop_details$custody_start >= from & expanded_pop_details$custody_start <= to)

  c <- sum(expanded_pop_details$custody_end <= to & expanded_pop_details$custody_end >= from & !is.na(expanded_pop_details$custody_end))

  d <- sum(expanded_pop_details$custody_start <= to & (is.na(expanded_pop_details$custody_end)|expanded_pop_details$custody_end > to))
  totals <- c(a,b,c,d)
  totals
}

# Uses the custom function above to calculate the four variables described for every quarter from msa_start until current quarter
population_summary <- as.data.frame(mapply(incare_sum, msa_quarters$`Quarter Start`,
             msa_quarters$`Quarter End`))
names(population_summary)[1:5] <- Quarters #The right number in 1:x needs to be increased by one each quarter.  Q1 2019 would be 1:5, q2 2019 1:6, etc
population_summary <- as.data.frame(tibble::add_column(population_summary, "variables" = summary_fields_tb1, .before = "2018 Q1"))

# Creates a csv file of the population summary 
save_files(population_summary, Sys.Date(), msa_start, period_end_date, 'overview_population_summary', 'population_overview')

# Creates a summary of children in custody by region on the last day of the quarter; send to LeaAnne Brandon to update the map in the preferred format
quarter_region_summary <- expanded_pop_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)) %>%
  dplyr::mutate(
   county = gsub('East |West ', '',county),
   county = gsub('Jefferson Davis', 'Jeff\'n Davis',county)
  ) %>%
  dplyr::group_by(region) %>%
  dplyr::summarise(`Children in Custody` = n()) %>%
  janitor::adorn_totals("row") %>%
  save_files(Sys.Date(),period_end_date, period_end_date, 'overview_region_totals', 'population_overview')


# Merges the ms county map data with children in custody on the last of the quarter to get the file ready for a charting
quarter_end_pop_map <- expanded_pop_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)) %>%
    dplyr::mutate(
   county = gsub('East |West ', '',county),
   county = gsub('Jefferson Davis', 'Jeff\'n Davis',county)
  ) %>%
  save_files(Sys.Date(), params$end_date, params$end_date, 'quarterend_custody_map', 'population_overview') %>%
  dplyr::group_by(county) %>%
  dplyr::summarise(`Children in Custody` = n()) %>%
  dplyr::ungroup() %>%
  dplyr::right_join((mdcpsde2::ms_map %>% dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower))) 

quarter_end_pop_map$`Children in Custody` <- ifelse(is.na(quarter_end_pop_map$`Children in Custody`), 0, quarter_end_pop_map$`Children in Custody`)
```

```{r outcomes_in_period, echo=FALSE}
# Create expanded dataset of service outcomces for all children exting custody between two dates
outcomes_expanded <- custody_outcomes(expanded_start, period_censor_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start,period_censor_date,'custody_outcomes_expanded_details', 'population_overview')

# Create dataset of service outcomes for all children exiting custody during the current period
outcomes_in_period <- outcomes_expanded %>%
  filter(custody_end <= period_end_date,
         custody_end >= period_start_date) %>%
  save_files(Sys.Date(), msa_start,params$end_date,'custody_outcomes_period_details', 'population_overview') %>%
  dplyr::mutate(quarter = lubridate::quarter(custody_end, with_year = T, fiscal_start = 1))

# Reassigns serivce outcomes of NA to 'No service documented'
levels(outcomes_in_period$service_outcome) <- c(levels(outcomes_in_period$service_outcome),"No Service Outcome Documented")
outcomes_in_period$service_outcome[is.na(outcomes_in_period$service_outcome)] <- 'No Service Outcome Documented'
levels(outcomes_in_period$quarter) <- c(levels(outcomes_in_period$quarter))

# Creates summary of outcomes in period by service type used to compare to chart
outcomes_period_total <-  outcomes_in_period %>% 
  dplyr::filter(quarter == "2019.1") %>%
  dplyr::group_by(service_outcome) %>%
  dplyr::summarise( count = n()) %>%
  save_files(Sys.Date(), params$start_date, params$end_date, 'custody_outcomes_period_summary', 'population_overview') 

# Creates Chart of Serivce outcomes by outcome type for the current quarter
x <- transform(outcomes_period_total, variable=reorder(service_outcome, count) )  
cbPalette <- c("#CC79A7","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#999997")
service_outcomes_period_chart <- ggplot2::ggplot(
    x,
    ggplot2::aes(x =reorder(variable, `count`), `count`, fill =service_outcome)) +
  ggplot2::geom_col() +
  ggplot2::scale_fill_manual(values=cbPalette, guide=FALSE) +
  ggplot2::geom_text(
    stat = 'identity',
    ggplot2::aes(label = count),
    vjust = 0,
    hjust = 0
  ) +
  ggplot2::coord_flip() +
  ggplot2::scale_y_continuous(expand = c(0, 0),
                              limits = c(0, max(x$count) * 1.3)) +
  ggplot2::theme_minimal() +
  ggplot2::xlab('Custody Outcome') +
  ggplot2::ylab('Count of Children') 

print(service_outcomes_period_chart)
ggplot2::ggsave("service_outcomes_period.png")
```
  
```{r perm_goals_pit, include=FALSE}
# Creates expanded dataset of all permplans for all kids in custody durign the expanded period; validaiton file
expanded_permplans_details <- permanency_plans(expanded_start, period_censor_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'permanency_plans_expanded', 'population_overview')

# creates object of one last perm plan approved in teh quarter per child
quarterend_permplans <- expanded_permplans_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)
                ) %>%
  dplyr::group_by(child_id, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::filter(fsp_approved <= params$end_date|is.na(fsp_approved)) %>%
  dplyr::arrange(child_id, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::filter(plan_type == "Permanency" |is.na(plan_type)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id ) %>%
  dplyr::filter(dplyr::row_number() == 1) 

# Renames old perm plan type of living independently to APPLA
quarterend_permplans$plan_name[quarterend_permplans$plan_name=="Living Independently"] <- "APPLA"

# Creates a dataset of all children in custody on last day of the period and the currrent apporved perm plan; if no perm plan then children are assigned into No plan Documented - less than 45 days in custody or no current fsp approved depending on cirsumstances
cust_children_with_permplan <- expanded_pop_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)
                ) %>%
  dplyr::left_join(quarterend_permplans %>% dplyr::select(-isn)) %>%
  dplyr::mutate(days_custody = as.integer(difftime(params$end_date, custody_start, unit = "days"))) %>%
  dplyr::mutate(permplan_chart = as.factor(case_when(
                  !is.na(plan_name) ~ as.character(plan_name),
                  is.na(plan_name) & days_custody <= 45 ~ "No Plan Documented - Less than 45 Days in Custody",
                  is.na(plan_name) & days_custody > 45 ~ "No Plan Documented - No current approved FSP",
                  TRUE ~ "Check"
                ))) %>%
  save_files(Sys.Date(), params$end_date, params$end_date, 'quarterend_custodychildren_permplan', 'population_overview') 
    
overview_permplan_graph <- cust_children_with_permplan %>% dplyr::group_by(permplan_chart) %>%
  dplyr::summarise(n()) 
  
permplan_qend_summary <- overview_permplan_graph %>% janitor::adorn_totals("row")

msa_6_3_E <- quarterend_permplans %>% 
 save_files(Sys.Date(), params$end_date, params$end_date, 'quarterend_permplans_details', 'population_overview')

qe_PP_unique <- quarterend_permplans %>%
  dplyr::distinct(`child_id`,.keep_all = TRUE)


``` 

```{r perm_goals_chart, echo=FALSE}

#creates chart of children in custody on last day of period by perm plan type
perm_goals_period_chart <- ggplot2::ggplot(
    overview_permplan_graph ,
    ggplot2::aes(reorder(`permplan_chart`, `n()`), `n()`, fill = `permplan_chart`)
  ) +
  ggplot2::geom_bar(stat= 'identity') +
  ggplot2::scale_fill_manual(values=cbPalette, guide= FALSE) +
  ggplot2::geom_text(
    stat = 'identity',
    ggplot2::aes(label = `n()`),
    vjust = 0,
    hjust = 0
  ) +
  ggplot2::scale_y_continuous(expand = c(0, 0),
                              limits = c(0, max(overview_permplan_graph $`n()`) * 1.3)) +
  ggplot2::coord_flip() +
  ggplot2::theme_minimal() +
  ggplot2::xlab('Plan Type') +
  ggplot2::ylab('Children with Plan') 

print(perm_goals_period_chart)
ggplot2::ggsave("perm_plans_periodend.png") 
```

```{r pop_by_county_chart, echo=FALSE, fig.height=10}
# Creates map of children in custody on last day of period by county
custody_bycounty_map <- ggplot2::ggplot(
    quarter_end_pop_map, ggplot2::aes(long, lat, group =county, fill =region)
   ) +
  ggplot2::geom_polygon() +
  ggplot2::geom_path(color = 'gray30') +
  ggplot2::coord_equal() +
  ggplot2::theme_void() +
  ggplot2::geom_text(
    data = quarter_end_pop_map %>%
      dplyr::select(label_x, label_y,county,region) %>%
      unique(),
    size = 3,
    vjust = -.5, 
    ggplot2::aes(x = label_x, y = label_y, label =county)
  ) +
  ggplot2::geom_text(
    data = quarter_end_pop_map %>%
      dplyr::select(
        label_x, 
        label_y, 
        `Children in Custody`, 
       region, 
       county
      ) %>%
      unique(),
    size = 3.5, 
    vjust = 1, 
    ggplot2::aes(label_x, label_y, label = `Children in Custody`)
  ) +
  ggplot2::scale_fill_manual(
    values = c(
      rainbow(7, s = .5, v = .95, end = .9),
      rainbow(7, s = .5, v = .95, start = .1)
  )) 

ggplot2::ggsave("cust_map_periodend.jpeg",plot = custody_bycounty_map, device = "jpeg", width = 7, height = 9, units = "in")

print(custody_bycounty_map)
```


```{r expedited_placements, include=FALSE}
library(readxl)
library(readr)

# Creates an object that contains all expedited placements captured since 7/2017
db_con <- con
  expedited_placements_master_list <- dplyr::tbl(db_con, 'dru_expedited_placements') %>%
       dplyr::collect()

# creates the expanded dataset of all expedited placements due to be approved from 2017-10-01 until the period_censor_date
expedited_placements_expanded_details <- expedited_placements_master_list %>%
  dplyr::mutate(`90thDay` = as.Date(`Placement Start Date`) + lubridate::days(90)) %>%
  dplyr::filter(`90thDay` >= expanded_start, is.na(`90thDay`)|`90thDay` <= expanded_end) %>%
  dplyr::arrange(`Resource ID`, `Child ID`, `Placement Start Date`) %>%
  save_files(Sys.Date(),
              expanded_start, 
              period_censor_date, 
             'expanded_expedited_details',
             'expedited_placements')
  
expedited_placements_expanded_details$`Placement Start Date` <-as.Date(expedited_placements_expanded_details$`Placement Start Date`)

# This file is a manual tracking file maintained at I:\Evaluation and Monitoring\LICENSURE TRACKING and REVIEW; if you copy the file to the same location as the .Rmd document for the quarterly report, then the below script will import the data; the name in quotes below much match the name of the excel file. The excel must be cleaned up before import
emu_tracking_master <- read_excel("20190331_expedited_tracking_master.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "numeric", "text", 
        "date", "date", "date", "date", "numeric", 
        "text", "text", "text", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "date", "date", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text"))

save_files(emu_tracking_master,Sys.Date(), expanded_start, period_censor_date, 'master_emu_expedited_details', 'expedited_placements')

# Creates object that contains unique expedited placements by child and resource id 
emu_tracking_unique <- emu_tracking_master %>%
 dplyr::mutate(`90thDay` = as.Date(`Placement Start Date`) + lubridate::days(90)) %>%
 dplyr::filter(`90thDay` >= currentq_start, `90thDay` <= period_end_date) %>%
 dplyr::arrange(`Resource ID`, `Placement Start Date`) %>%
 dplyr::distinct(`Resource ID`, `Child ID`, .keep_all = TRUE) 

# Creates a data set that contains a unique list of children placed into expedited placements with an approval due date in the period. This file was used for previous versions of the quarterly report to get the number of children placed in expedited placements

expedited_placements_quarter_uniquechildren <- expedited_placements_expanded_details %>%
  dplyr::filter(`90thDay` >= currentq_start, `90thDay` <= period_end_date)  %>% 
  dplyr::distinct(`Child ID`,  .keep_all = TRUE) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'unique_children', 'expedited_placements')
    
expedited_placements_quarter_details <- expedited_placements_expanded_details %>%
   dplyr::filter(`90thDay` >= currentq_start, `90thDay` <= period_end_date)  %>%
   dplyr::distinct(`Resource ID`, .keep_all = TRUE) 

expedited_placements_quarter_details$Tracked_EMU <- "No"
 
 expedited_placements_quarter_details$Tracked_EMU[expedited_placements_quarter_details$`Resource ID` %in% `emu_tracking_master`$`Resource ID`] <- "Yes" 
 
   save_files(expedited_placements_quarter_details,Sys.Date(), currentq_start, period_end_date, 'quarter_expedited_details', 'expedited_placements')
  
 exp_plac_quarter <- expedited_placements_quarter_details %>%
   dplyr::distinct(`Resource ID`, .keep_all = TRUE) %>%
   dplyr::left_join(emu_tracking_unique, by = "Resource ID") %>%
   dplyr::filter(`90thDay.x` >= currentq_start & `90thDay.x` <= period_end_date) %>%
   dplyr::distinct(`Resource ID`, .keep_all = TRUE) %>%
   save_files(Sys.Date(), currentq_start, period_end_date, 'quarter_merged_details', 'expedited_placements') %>%
   dplyr::ungroup() %>%
   dplyr::mutate(quarter = lubridate::quarter(`90thDay.x`, with_year = T, fiscal_start = 1))

 exp_plac_quarter$`Action Taken` <- as.factor(exp_plac_quarter$`Action Taken`)
 
unique_child_placements <- summarise(expedited_placements_quarter_uniquechildren, n())                      
  
exp_place_quater_summary <-  exp_plac_quarter %>%
   dplyr::group_by(`Was Action Timely`, `Action Taken`) %>%
   dplyr::summarise(`Total Child Placements` = unique_child_placements$`n()`,
                    `Total Expedited Homes` = n()) %>%
                    # `Total Homes With Timely Action` = sum(`Was Action Timely` %in% c("Yes", "YES"), na.rm = TRUE), 
                    # `Total Homes With Untimely Action` = sum(`Was Action Timely` %in% c("NO","NA", na.rm = TRUE))) %>%
   save_files(Sys.Date(), currentq_start,period_end_date, 'expedited_timeliness_summary', 'expedited_placements') %>%
  dplyr::ungroup() 

actions <- unique(exp_plac_quarter$`Was Action Timely`)

exp_palce_timely_decisions <- exp_plac_quarter %>%
  dplyr::filter(`Was Action Timely` == "Yes") %>%
  dplyr::group_by(`Action Taken`) %>%
  dplyr::summarise(`Number with Timely Decision`= n()) %>%
  janitor::adorn_totals("row")  %>%
  dplyr::ungroup()

exp_plac_untimely_decisions <- exp_plac_quarter %>%
   dplyr::filter(`Was Action Timely` == "No") %>%
  dplyr::group_by(`Action Taken`) %>%
  dplyr::summarise(`Number with Untimely Decision` = n()) %>%
  janitor::adorn_totals("row")  %>%
  dplyr::ungroup()
 
 #expedited_placements_quarter_merge <- expedited_placements_quarter_details %>%
  ## dplyr::inner_join(expedited_tracking_master, by= "Resource ID", "Child ID") 
   
 #expedited_placements_quarter_merged_reduced <- expedited_placements_quarter_merge[c(1:3,6,8:10, 15, 22:29)]
 


```






```{r msa_2_expanded_validation, include=FALSE}
#Creates an expanded dataset of all active/closed placements between the expanded start and expanded end date; used for validation
placements_expanded <- custody_placements(date_filter = T, from = expanded_start, to = expanded_end) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::distinct(.keep_all = TRUE) %>%
  save_files(Sys.Date(),expanded_start, expanded_end, 'msa_2.0_placements_expanded', 'mic_validation_files')
#Creates a dataset of all active/closed placements between the msa start and expanded end date; used for validation and end some further programming
placements_period <- placements_expanded %>%
    dplyr::filter(`placement_start` <= period_end_date,
                is.na(`placement_end`)|`placement_end` >= msa_start) %>%
    save_files(Sys.Date(), msa_start, period_end_date, 'msa_2.0_placements_period', 'mic_validation_files')
#Creates an expanded dataset of all custody episodes between the expanded start and expanded end date; used for validation
custody_expanded <- custody_children(from = expanded_start, to = expanded_end) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::distinct(.keep_all = TRUE) %>%
  dplyr::ungroup() %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'msa_2.0_custodyepisodes_expanded', 'mic_validation_files')
#Creates an object of all custody episodes between the period start and period end date
custody_period <- custody_expanded %>%
  filter(custody_start <= period_end_date, is.na(custody_end)|custody_end >= msa_start)

```

```{r msa_2.0_datasets, include=FALSE}
#Creates aan object dataset of all investigations, allegations, and initiation with an intake date between the expanded start and expanded end date; used for validation and all msa reporting related to maltreatment reporting
ane_reports_base <- allegations(expanded_start, period_censor_date) %>%
  dplyr::left_join(investigation_initiations()) %>% 
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>% 
  dplyr::rename_all(funs(make.names(.)))

#Creates a dataset from the ane_reports_base object that adds additional variables used for various provisions or filtering
ane_reports_expanded_variables <- ane_reports_base %>%
  tidyr::unite(perp, perp_last_name, perp_first_name, sep = ", ", remove = TRUE) %>%
  tidyr::unite(vic, vic_last_name, vic_first_name, sep = ", ", remove = TRUE) %>%
  dplyr::select(intake_id:county, report_level, inti_siu_owner, ints_siu_ane_owner, incident_date:custody_child, screen_out_reason, initiation_datetime) %>%
  dplyr::mutate(intake_date = as.Date(intake_datetime),
                initiation_indicator = case_when(#adds an indicator for whether the investigation was initiated timely: Y,N,null
      report_level == 3 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) <= 24 ~ "Y",
      report_level == 2 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) <= 72 ~ "Y",
      report_level == 3 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) > 24 ~ "N",
      report_level == 2 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) > 72 ~ "N",
      intake_status %in% c("20INV", "25INV", "30INV", "35INV", "40INV") & is.na(initiation_datetime) ~ "N",
      TRUE ~ "null"
    ),
    approval_indicator = case_when(#adds and indicator for whether the investigation was approved timely: Y,N,PEND,null
      report_level %in% c("2","3") & round(difftime(`findings_approved_date`,`intake_date`, units = 'days')) <= 30 ~ "Y",
      report_level %in% c("2","3") & round(difftime(`findings_approved_date`,`intake_date`, units = 'days')) > 30 ~ "N",
      report_level %in% c("2","3") & intake_status %in% c("20INV", "25INV", "30INV") ~ "Pend",
      TRUE ~ "null")) %>%
  dplyr::group_by(intake_id) %>%
  dplyr::mutate(investigation_finding = {if (any(finding == "S" & !is.na(finding))) "substantiated" else "unsubstantiated"}
                 ) %>% # adds an indicator for whether any allegation within an investigation was substantiated
  dplyr::ungroup() %>%
  dplyr::mutate(quarter_intake = zoo::as.yearqtr(intake_datetime, by='quarters',format= "%Y Quarter"),#quarter of intake datetime
                quarter_approval_due = zoo::as.yearqtr(intake_datetime %m+% days(30), by='quarters'),#quarter investiation should have been approved
                month = lubridate::month(intake_datetime, label = TRUE, abbr = TRUE)) %>% #month of intake datetime
  dplyr::mutate(mic_report = 
                  dplyr::case_when(custody_child == "A" & ints_siu_ane_owner %in%  c("S","R") ~ "Y", TRUE ~ "N"),#creates an indicator for whether report was a mic report using definition agreed upon for 2.1, 2.2, and 2.8a reporting
                mic_investigation = 
                  dplyr::case_when(custody_child == "A" & inti_siu_owner %in% c("S", "R") ~ "Y", TRUE ~ "N" )) %>% #creates an indicator for whether report was a mic investigation using definition agreed upon for 2.1, 2.2, and 2.8a reporting
   save_files(Sys.Date(), expanded_start, period_censor_date,'ane_reportsreceived_expanded_details','msa_2.1')


dupe_test <- ane_reports_expanded_variables %>%
  group_by(intake_id, perpetrator_id, victim_id, allegation) %>%
  distinct() %>%
  summarise(n())
```

```{r msa_2.1_reports_screenouts, include=FALSE}

#Function to summarize reports received by grouping variables
ane_reportsreceived_period_summary <- function(data, filename){
  data %>%
  dplyr::summarise(`MIC Reports Received` = n(),
                  `MIC Reports in Screening` = sum(`intake_status` == "05SCR"),
                  `MIC Reports Screened Out` = sum(`intake_status` == "10SCO"),
                  `MIC Reports Assigned for Investigation` = sum(`intake_status` %in% c("15SCI", "20INV", "25INV", "30INV", "35INV", "40INV")),
                  `MIC Reports Assigned and Investigation Completed` = #sum(intake_status %in% c("35INV", "40INV"))
                    sum(!is.na(findings_approved_date)),
                  `MIC Reports Assigned and Still in Investigation` = sum(intake_status %in% c("15SCI", "20INV", "25INV", "30INV") & is.na(findings_approved_date))) %>%
        save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_2.1')
}

#Creates dataset of all reports/investigation received during msa period through current quarter
ane_reports_received_msa <- ane_reports_expanded_variables %>%
  dplyr::filter(`intake_date` >= msa_start, 
                # `intake_datetime` <= period_end_date
                # ,`child_custody_indicator` %in% c("Y", "check")
                intake_date <= (period_end_date)
                ) %>%
  save_files(Sys.Date(), msa_start, period_end_date,'ane_reportsreceived_msa_details', 'msa_2.1')

#Creates dataset of all reports/investigation received during current quarter
ane_reports_received_current_q <- ane_reports_expanded_variables %>%
  dplyr::filter(intake_date >= params$start_date, intake_date <= params$end_date) %>%
  save_files(Sys.Date(), msa_start, period_end_date,'ane_reportsreceived_currentq_details', 'msa_2.1')

#Creates summary dataset for 2.1 that counts reports by quarter, whether the report was considered MIC or not, and county, region, or statewide. Relies on the summary function above
ane_reports_received_county_summary <- ane_reports_received_msa %>%
  dplyr::distinct(intake_id, .keep_all = TRUE) %>% 
  dplyr::group_by(quarter_intake, mic_report, region, county) %>%
  ane_reportsreceived_period_summary('ane_reportsreceived_county_summary')

ane_reports_received_region_summary <- ane_reports_received_msa %>%
  dplyr::distinct(intake_id, .keep_all = TRUE) %>% 
  dplyr::group_by(quarter_intake, mic_report, region) %>%
  ane_reportsreceived_period_summary('ane_reportsreceived_region_summary')

ane_reports_received_statewide_summary <- ane_reports_received_msa %>%
  dplyr::distinct(intake_id, .keep_all = TRUE) %>% 
  dplyr::group_by(quarter_intake, mic_report) %>%
  ane_reportsreceived_period_summary('ane_reportsreceived_statewide_summary') 
  

mic_reports_order <- c("MIC Reports Received", "MIC Reports in Screening", "MIC Reports Screened Out", "MIC Reports Assigned for Investigation", "MIC Reports Assigned and Still in Investigation", "MIC Reports Assigned and Investigation Completed")
```

```{r msa_2.2_2.8_investigation_timeliness, include=FALSE}
# Summary function for investigation initiation and approval timeliness
mic_investigations_timeliness_period_summary <- function(data, filename) {
  data %>%
   dplyr::summarise(
      `Total Investigations Due` = n(), #total investigations due for approval in the period
      `Initiated Timely` = sum(initiation_indicator == "Y",na.rm = T), #number of investigations initiated timely 
      `Approved Timely` = sum(approval_indicator == "Y", na.rm = T),#number of investigations approved timely
      `Initiated and Approved Timely` = sum(initiation_indicator == "Y" & approval_indicator == "Y", na.rm = T),#number of investiations initiated and approved timely
      `With At Least 1 Substantiated Allegation` = sum(investigation_finding == "substantiated", na.rm = T),
      `% Total Investigations` = round((`Total Investigations Due`/`Total Investigations Due`)*100,2),
      `% Initiated Timely` = round((`Initiated Timely`/`Total Investigations Due`)*100,2),
      `% Approved Timely` = round((`Approved Timely`/`Total Investigations Due`)*100,2),
      `% Initiated and Approved Timely` = round((`Initiated and Approved Timely`/`Total Investigations Due`)*100,2),
      `% With At Least 1 Substantiated Allegation` = round((`With At Least 1 Substantiated Allegation`/`Total Investigations Due`)*100,2)
    ) %>%
     save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_2.8')
}

# Creates dataset of all mic investigation with an intake betwen msa start and period end date that were due to be approved within the same time period. 
mic_investigations_timeliness <- ane_reports_expanded_variables %>% 
   dplyr::filter(intake_date >= msa_start, 
                # `intake_datetime` <= period_end_date
                # ,`child_custody_indicator` %in% c("Y", "check")
                intake_date <= period_end_date,
                mic_investigation == "Y",
                intake_status %in% c("15SCI", "20INV", "25INV", "30INV", "35INV", "40INV"),
                as.Date(intake_date) + 30 <= period_end_date) %>%
  dplyr::mutate(origin = "original") %>%
  dplyr::distinct(`intake_id`, .keep_all = TRUE) %>%
  save_files(Sys.Date(), msa_start,period_end_date,'mic_investigation_timeliness_msa_details','msa_2.8')

# IN Q3, monitor asked for a manual review of a set of allegations; based on that review the following 8 investiations should have been mic but were excluded; This code section identifies these investigations and processes them the same way as above
mic_investigations_timeliness_manual <- ane_reports_expanded_variables %>% 
   dplyr::filter(intake_date >= msa_start, 
                intake_date <= period_end_date,
                intake_id %in% c("8545391","8563616","8581398","8645086","8801711","8826498","8863644","8884552"),
                intake_status %in% c("15SCI", "20INV", "25INV", "30INV", "35INV", "40INV"),
                as.Date(intake_datetime) + 30 <= period_end_date) %>%
  dplyr::mutate(origin = "manual") %>%
  dplyr::distinct(`intake_id`, .keep_all = TRUE) %>%
  save_files(Sys.Date(), msa_start,period_end_date,'mic_investigation_timeliness_msa_manual','msa_2.8')

# Creates a dataset that combines the normal dataset with the manual review dataset, so aggregation can still be completed programatically
mic_investigations_timeliness_combined <- mic_investigations_timeliness %>% dplyr::bind_rows(mic_investigations_timeliness_manual) %>%
  save_files(Sys.Date(), msa_start,period_end_date,'mic_investigation_timeliness_msa_combined','msa_2.8')

 mic_investigations_timeliness_statewide_summary_combined <- mic_investigations_timeliness_combined %>%
   dplyr::group_by(quarter_approval_due) %>%
   mic_investigations_timeliness_period_summary('mic_investigation_timeliness_statewide_summary_combined')  %>%
  dplyr::ungroup()
 
# Creates a dataset for just investiation due to be approved in the current quareter
mic_investigations_current_period <- mic_investigations_timeliness %>%
  dplyr::filter(quarter_approval_due == current_quarter) %>%
  save_files(Sys.Date(), msa_start, period_end_date,'mic_investigation_timeliness_currentq_details','msa_2.8')

# Creates a summary dataset by quarter approval due for 2.2 and 2.8.a
 mic_investigations_timeliness_statewide_summary <- mic_investigations_timeliness %>%
   dplyr::group_by(quarter_approval_due) %>%
   mic_investigations_timeliness_period_summary('mic_investigation_timeliness_statewide_summary')  %>%
  dplyr::ungroup()
 
```

```{r msa_2.4}
# Creates a base data set of all potential mic investigations and allegations where children were in custody at the time of incident/inatke date and there placement at that time. A manual review is conducted to of this popualtion to determine which reports involved mic and either licensed resource homes or facilitites and should have had a licensure investigation or review conducteed separately. This list is then forwarded to the licensure/congregate care unit to pull documentaion of that review and submitted to public catalyst.
mic_investigations_children <- ane_reports_base %>% 
  tidyr::unite(perp, perp_last_name, perp_first_name, sep = ", ", remove = TRUE) %>% #combines perp last anme and first name into one column
  tidyr::unite(vic, vic_last_name, vic_first_name, sep = ", ", remove = TRUE) %>% #combines vic last name and first name into one column
  dplyr::mutate(intake_date = as.Date(intake_datetime),#add column that turns intake date_time into a date
                initiation_indicator = case_when(# adds indicator for whether investigation was initiated timely: Y,N, null
      report_level == 3 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) <= 24 ~ "Y",
      report_level == 2 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) <= 72 ~ "Y",
      report_level == 3 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) > 24 ~ "N",
      report_level == 2 & as.numeric(difftime(initiation_datetime, intake_datetime, units="hours")) > 72 ~ "N",
      intake_status %in% c("20INV", "25INV", "30INV", "35INV", "40INV") & is.na(initiation_datetime) ~ "N",
      TRUE ~ "null"
    ),
    approval_indicator = case_when(# adds column for wether or not investigation was approved timely: Y, N, pend, null
      report_level %in% c("2","3") & round(difftime(`findings_approved_date`,`intake_date`, units = 'days')) <= 30 ~ "Y",
      report_level %in% c("2","3") & round(difftime(`findings_approved_date`,`intake_date`, units = 'days')) > 30 ~ "N",
      report_level %in% c("2","3") & intake_status %in% c("20INV", "25INV", "30INV") ~ "Pend",
      TRUE ~ "null")) %>%
  dplyr::group_by(intake_id) %>%
  dplyr::mutate(investigation_finding = {if (any(finding == "S" & !is.na(finding))) "substantiated" else "unsubstantiated"}
                 ) %>% # adds column that shows if any alleagtion in the investiation was substantiated
  dplyr::ungroup() %>%
  dplyr::mutate(quarter_intake = zoo::as.yearqtr(intake_datetime, by='quarters',format= "%Y Quarter"),# add column with quarter of intake
                quarter_approval_due = zoo::as.yearqtr(intake_datetime %m+% days(30), by='quarters'),# adds colun with quarter of investigation was due to be approved
                month = lubridate::month(intake_datetime, label = TRUE, abbr = TRUE)) %>% 
  dplyr::mutate(mic_report = # add column that shows if screening met rules for mic: cusotdy child attached and investigation owned by SIU
                  dplyr::case_when(custody_child == "A" & ints_siu_ane_owner %in%  c("S","R") ~ "Y", TRUE ~ "N"),
                mic_investigation = # add column that shows if investigation met rules for mic: cusotdy child attached and investigation owned by SIU
                  dplyr::case_when(custody_child == "A" & inti_siu_owner %in% c("S", "R") ~ "Y", TRUE ~ "N" )) %>%
  dplyr::filter(findings_approved_date >= currentq_start, # filter for findings approved date in current quarter
                findings_approved_date <= period_end_date,
                intake_status %in% c("15SCI", "20INV", "25INV", "30INV", "35INV", "40INV")
                 #mic_investigation == "N",
                 #investigation_finding == "substantiated"
                ) %>%
  dplyr::group_by(intake_id, victim_id) %>%
  dplyr::mutate(child_id = victim_id) %>%
  dplyr::left_join(placements_period, by = "child_id") %>%
   dplyr::filter(intake_date >= placement_start & (intake_date <= placement_end|is.na(placement_end))) %>% # filter to keep only victim/allegations where child was in a placement at teh time of intake
  # dplyr::distinct(intake_id, child_id, .keep_all = TRUE) %>%
  # dplyr::select(intake_id, victim_id, intake_date, intake_status, child_id, placement_id, placement_start, placement_end, placement_sequence_per_episode, facility_type) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_2.4&2.5_mic_investigations_with_placement', 'msa_2.4&2.5')

mic_investigations_placements_summary <- mic_investigations_children %>%
  dplyr::group_by(facility_type) %>%
  dplyr::summarise(n())  %>%
  dplyr::ungroup()
mdsa_2.4dqc_1 <- mic_investigations_timeliness %>%
  dplyr::anti_join(mic_investigations_children, by = "intake_id") %>%
  dplyr::distinct(intake_id, victim_id, intake_date) %>%
  dplyr::left_join(placements_period, by = c("victim_id" = "child_id"))
```

```{r msa_2.8.b}

# Reads the results of the 2.9a_mic_rate_details_withmr file into r for use in this section. Note: the file must be located in the same folder as the .Rmd document for the quarter. HC- Change the dates in the file name as necessary 
library(readr)
X20190510_20180101_20190331_mic_rate_details_withmr <- read_csv("20190510_20180101_20190331_mic_rate_details_withmr.csv")
 
# Creates a base population object of all children with substantitated mic allegations who were were in a placement at the time incident/intake and who remained in that placement at 7 days after the findings were approved. The starting data are the result of the manual review conducted of all potential mic allegations for 2.9a
msa_2.8b_base_pop <- X20190510_20180101_20190331_mic_rate_details_withmr %>% 
  # keep only records where the manual review determined the investigation was mic
  filter(mr_mic == 'Yes') %>%
  group_by(child_id, intake_id) %>%
  # keep one record per child per intake
  distinct(child_id, intake_id, .keep_all = T) %>% 
  #keep only the specified columns
  select(intake_id, child_id, vic, intake_date, incident_date, findings_approved_date, mr_mic) %>% 
  #add placements for chidl victims
  left_join(placements_expanded %>% select(child_id, placement_start, placement_end, placement_id), by = "child_id") %>% 
  mutate(incident_date = as.Date(incident_date,origin = "1900-01-01")) %>%
  # keep only placements where placement start occurred before incident/intake date and placement end occurred after findings approved date + 7 days 
  filter(incident_date > placement_start|is.na(incident_date),
         intake_date > placement_start,
         placement_end >= findings_approved_date %m+% days(7)|is.na(placement_end)) %>%
  group_by(child_id) %>%
  distinct(child_id,.keep_all = T) %>% # keep one record per child   # this section adds new columns for the start date of each contact time period as outlined by the 2nd msa
  mutate(week_1 = findings_approved_date,
         week_2 = findings_approved_date %m+% days(7),
         week_3 = findings_approved_date %m+% days(14),
         week_4 = findings_approved_date %m+% days(21),
         month_1 = findings_approved_date %m+% days(28),
         month_2 = findings_approved_date %m+% days(58),
         month_3 = findings_approved_date %m+% days(88)) %>%
  save_files(Sys.Date(), msa_start, period_end_date,'msa_2.8.b_population', 'msa_2.8.b') %>%
  # transform file from wide to long so each row represents one child/contact period combination
  tidyr::gather(key = "time_period", value = "time_period_start", week_1:month_3) %>% 
  # add the end date of each contact period
  mutate(time_period_end = if_else(time_period %in% c("week_1", "week_2", "week_3", "week_4"), time_period_start %m+% days(6),time_period_start %m+% days(29))) %>% 
  #filter to only include time periods occuring before the plcaement end date and ending before the end of the reporting period
  filter(time_period_end <= placement_end|is.na(placement_end), time_period_end <= period_end_date) 
# Creates an object that contains all face-to-face, in-home contacts with the children identified in the step above 


msa_2.8b_contacts <- msa_2.8b_base_pop %>%
         left_join(
     custody_child_contacts(msa_start, as.Date(period_end_date +1)) %>%
      dplyr::filter(
        `owner_job_code` %in% valid_contact_job_codes(),
        `contact_method` == 'Face-to-Face',
        narrative_location == 'Home'
      ))

# Creates a dataset of all contacts with children who were the victims of mic and remained in the same placement filtered to keep only contacts that occurred during one of the time periods proscribed by the 2nd msa.
new2 <- msa_2.8b_contacts %>% mutate(narrative_datetime = as.Date(narrative_datetime)) %>%
  filter(narrative_datetime <= time_period_end|is.na(narrative_datetime),
         narrative_datetime >= time_period_start|is.na(narrative_datetime)) %>%
  select(1:14,25, 27, 29:33) %>%
  save_files(Sys.Date(), msa_start,period_end_date,'msa_2.8b_msa_details', 'msa_2.8.b') %>%
  group_by(child_id, time_period) %>%
  summarize(number_contacts = n()) 

#Creates a dataset that merges all children that should have received teh required contacts with the actual contacts received for each time period indicated by the 2nd msa. Each row corresposnds to a child/time period and number of qualifying contacts received in that time period
new_3 <- msa_2.8b_base_pop %>% left_join(new2) %>%
  group_by(time_period, child_id)
new_3$number_contacts[is.na(new_3$number_contacts)] <- 0
new_3 %>% 
save_files(Sys.Date(), msa_start, period_end_date,'msa_2.8b_msa_child_summary', 'msa_2.8.b')

# Creates a dataset that summrises performance for the first year of the msa
msa_2.8b_final <- msa_2.8b_base_pop %>% left_join(new2) %>%
  ungroup() %>%
  group_by(time_period) %>%
  summarize(total_children = n(),
            children_receiving_contact = sum(number_contacts > 0,na.rm=TRUE),
            `%_children_receiving_contact` = round((children_receiving_contact/total_children)*100,4)) %>%
  save_files(Sys.Date(), msa_start, period_end_date,'msa_2.8b_msa_summary', 'msa_2.8.b')

# Old region, county, statewide sumamry datasets
# sub_mic_contacts_county_summary <- sub_mic_contacts_msa %>%
#   dplyr::group_by(region, county) %>%
#   sub_mic_summary('Child_Contacts_Post_MIC_County_Summary')
# 
# sub_mic_contacts_region_summary <- sub_mic_contacts_msa %>%
#   dplyr::group_by(region) %>%
#   sub_mic_summary('Child_Contacts_Post_MIC_Region_Summary')
# 
# sub_mic_contacts_state_summary <- sub_mic_contacts_msa %>%
#   dplyr::group_by() %>%
#   sub_mic_summary('Child_Contacts_Post_MIC_State_Summary')  %>%
#   dplyr::ungroup()
# 
# sub_mic_contacts_county_summary_q <- sub_mic_contacts_q %>%
#   dplyr::group_by(region, county) %>%
#   sub_mic_summary('Child_Contacts_Post_MIC_County_Summary')
# 
# sub_mic_contacts_region_summary_q <- sub_mic_contacts_q %>%
#   dplyr::group_by(region) %>%
#   sub_mic_summary('Child_Contacts_Post_MIC_Region_Summary')
# 
# sub_mic_contacts_state_summary_q <- sub_mic_contacts_q %>%
#   dplyr::group_by() %>%
#   sub_mic_summary('Child_Contacts_Post_MIC_State_Summary')  %>%
#   dplyr::ungroup()
```

```{r msa_2.9a}

# Creates an object that contains the unique list of children served during the one year mic rate period. This is the denominator for teh mic rate calculation
unique_custody_list <- custody_period %>%
  distinct(child_id)

# Creates an object that contains all investigations with intake and findings approved date within the 1 year mic rate period
mic_rate_investigations <- ane_reports_received_msa %>%
  # filter the ane_reports_received_msa to ensure only inlcuding investigations within the first one year period, investiations with a findings approved date, and allegations that were substantitated
  filter(intake_date >= msa_start, 
         intake_date <= period_end_date,
         !is.na(findings_approved_date),
         finding %in% c( "S", "E"))

# creates a dataset of children in custody during the one year period with any substantiated allegations from investiations occurring within the same period
mic_custody_withinv <- custody_period %>%
  left_join(mic_rate_investigations, by = c("child_id" = "victim_id")) %>%
  #after combining custody children with allegations, filter to only keep rows where the child was a victim, the incident occurred after teh custody start date(if incident is filled out), the intake date was at least 7 days after the custody start date and the findings wer approved prior to the period end date
  filter(!is.na(intake_id),
         intake_date > custody_start,
         is.na(incident_date)|incident_date > custody_start,
         intake_date  > custody_start %m+% days(7),
         findings_approved_date <= period_end_date
         ) %>%
  #remove duplicates based on the below fields
  group_by(child_id, custody_sequence_number, intake_id, perpetrator_id, allegation, finding) %>%
  distinct(.keep_all = TRUE) %>%
  # adds a calcualted column that shows the difference between incident date and custody end date
  mutate(incident_indicator = sum(incident_date - custody_end, na.rm = T)) %>%
  # keeps records where incident date occurred before custody end date
  filter(incident_indicator <= 0) %>%
  # output of all substantitaed allegations that could potentially be mic 
  save_files(Sys.Date(), msa_start, period_end_date, '2.9_all_investigations_2', 'msa_2.9a')

# read in results of the manual review. For this section to work, you must place the excel file containing the manual review results into the same folder as the .Rmd document and chnage the name of the excel file below to match name of file you want to upload
library(readxl)
msa_2.9a_post_mr <- read_excel("20190510_20180101_20190331_2.9_all_investigations_2.xlsx", 
    sheet = "20190510_20180101_20190331_2.9_")

# creates object that contains the unique child victims and the number allegations substantiated

# adds indicator if the manual review determined the allegation involved mic and the corrected allegation was realitve or non realtive foster parent or residentital facility staff
msa_2.9a_post_mr2 <- msa_2.9a_post_mr %>% 
    group_by(child_id) %>%
    mutate(mic_rate_ind = 
            case_when(mr_mic == "Yes" & calc_relationship %in% 
                        c( 'Relative Foster Parent', 
                           'Residential Facility Staff', 
                           'Non Relative Foster Parent') ~ "Y",
                      TRUE ~ "N")) %>% 
  group_by(child_id) %>%
  summarise('num' = sum(mic_rate_ind == "Y")) %>%
  filter(num > 0) %>%


# read in results of the manual review with public catalyst adjustments. For this section to work, you must place the excel file containing the manual review results into the same folder as the .Rmd document and chnage the name of the excel file below to match name of file you want to upload
  
library(readr)
X20190510_20180101_20190331_mic_rate_details_withmr_pcadjustments <- read_csv("20190510_20180101_20190331_mic_rate_details_withmr_pcadjustments.csv")

# Create new data set using results of pc review of our manual review that only includes children who were substantitated victims and the relationship between perp and victim was one of the 3 listed and mic was indicated by the manual review and pc review(mic_rate_ind) 
msa_2.9a_post_mr_new <- X_mic_rate_details_withmr_pcadjustments %>%
  group_by(child_id) %>%
  filter(mic_rate_ind == "Y", calc_relationship %in% c("Relative Foster Parent", "Non Relative Foster Parent", "Residential Facility Staff")) %>%
  save_files(Sys.Date(), currentq_start, period_end_date, 'mic_rate_details_withmr_pcadjustments', 'msa_2.9a') %>%
  summarise('num' = sum(mic_rate_ind == "Y")) %>%
  filter(num > 0)

# creates an object of the mic rate calculation by using the mdcsp manual review results; takes a unique list of custody children adn left joins the unique mic victims identified, then summarises
mic_rate_calc_old <- unique_custody_list %>% mutate(mic = if_else(child_id %in% msa_2.9a_post_mr2$child_id,1,0)) %>%
  summarise(`Total Custody Children` = n(), # total children in custody
            `Total MIC Victims` = sum(mic == 1), # total unique child mic victims
            `MIC Rate` = (`Total MIC Victims`/`Total Custody Children`*100))
# creates an object of the mic rate calculation by using the pc review results; takes a unique list of custody children adn left joins the unique mic victims identified, then summarises
mic_rate_calc_adj <- unique_custody_list %>% mutate(mic = if_else(child_id %in% msa_2.9a_post_mr_new$child_id,1,0)) %>%
  summarise(`Total Custody Children` = n(), # total children in custody
            `Total MIC Victims` = sum(mic == 1), # total unique child mic victims
            `MIC Rate` = (`Total MIC Victims`/`Total Custody Children`*100)) %>%
  save_files(Sys.Date(), currentq_start, period_end_date, 'mic_rate_summary', 'msa_2.9a')
  

```

```{r age, include=FALSE}
# custom function to calculate age given two dates
age <- function(dob, age.day = today(), units = "years", floor = TRUE) {
  calc.age = interval(dob, age.day) / duration(num = 1, units = units)
  if (floor) return(as.integer(floor(calc.age)))
  return(calc.age)
}
```

```{r msa_4_population_overview, include=FALSE}

all_placements_expanded <- custody_placements(date_filter = T, from = expanded_start, to = period_censor_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) 
# creates an expanded dataset of all placements within the expanded period; used for validation
placements_expanded <- all_placements_expanded %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  # remove duplicates
  dplyr::distinct(.keep_all = TRUE) %>%
    dplyr::mutate(exclusions = ifelse(placement_id == "110728","Exclude","")) %>% # exclude one placement where the end date year was 3077
  dplyr::filter(exclusions == "") %>%
  dplyr::mutate(
    cong_care_reasons = purrr::map_chr(
      cong_care_reasons,
       paste,
       collapse = '; '),
     emer_plac_reasons = purrr::map_chr(
       emer_plac_reasons,
       paste,
       collapse = '; ')
  ) %>% save_files(Sys.Date(),expanded_start, period_censor_date, 'placements_expanded', 'msa_4.0_validation_files')
 
# creates dataset for all placements during the current period
 all_placements_period <- all_placements_expanded %>%
     dplyr::filter(placement_start <= period_end_date,
                 (is.na(placement_end)|placement_end >= msa_start))

 save_files(all_placements_period,Sys.Date(), msa_start, period_end_date, 'placements_period', 'msa_4.0_validation_files')
# expanded dataset of all custody children during expanded period that includes dob
 all_custody_expanded <- custody_child_demographics(date_filter = T, from = expanded_start, to = period_censor_date) %>%  
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::select(1:11) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::distinct(.keep_all = TRUE) %>%
  save_files(Sys.Date(),expanded_start, period_censor_date, 'custody_expanded', 'msa_4.0_validation_files')
```

```{sql msa_basefiles_expanded_case_relationships,  connection=con, include=FALSE, output.var="msa_basefiles_expanded_case_relationships"}
-- SQL query that creates expanded dataset of all relationships of case members for a given period of time
	select distinct child_case.CASP_CASE_ID as 'Case ID'
		,PERR_PERS_ID as 'Child ID'
		,PERR_START_DT as 'Child Relationship Start'
		,CUST_IN_CUSTODY_DT as 'Child Chustody Start'
		,CUST_CUSTODY_RELEASE_DT as 'Child Custody End'
		,child_case.CASP_START_DATE as 'Child Case Start'
		,child_case.CASP_END_DATE as 'Child Case End'
		,PERR_RELATED_ID as 'Related Person ID'
		,CODE_SHORT_DESC as 'Relationship'
		,rel_case.CASP_START_DATE as 'Related Case Start'
		,rel_case.CASP_END_DATE as 'Related Case End'
	from MW_PERS_REL
		,MW_CUSTODY_PER
		,MW_CASE_PERS rel_case
		,MW_CASE_PERS child_case
		,MW_CODE_TABLE
	where ISNULL(PERR_REASON_CHANGED, '0') <> '150'
		and PERR_START_DT <= ?sql_period_censor_end
		and ISNULL(PERR_END_DT, GETDATE()) >= ?sql_expanded_start
		and PERR_PERS_ID = CUST_CHILD_PERS_ID
		and CUST_IN_CUSTODY_DT <= ?sql_period_censor_end
		and ISNULL(CUST_CUSTODY_RELEASE_DT, GETDATE()) >= ?sql_expanded_start
		and PERR_RELATED_ID = rel_case.CASP_PERS_ID
		and rel_case.CASP_START_DATE <= ?sql_period_censor_end
		and ISNULL(rel_case.CASP_END_DATE, GETDATE()) >= ?sql_expanded_start
		and ISNULL(rel_case.CASP_RSN_CHANGE, '0') <> '150'
		and PERR_PERS_ID = child_case.CASP_PERS_ID
		and child_case.CASP_START_DATE <= ?sql_period_censor_end
		and ISNULL(child_case.CASP_END_DATE, GETDATE()) >= ?sql_expanded_start
		and ISNULL(child_case.CASP_RSN_CHANGE, '0') <> '150'
		and rel_case.CASP_CASE_ID = child_case.CASP_CASE_ID
		and CODE_TABLE_NAME = 'RELTNSHP'
		and PERR_RELATIONSHIP = CODE_TABLE_VaLUE

```

```{sql msa_4_1_other_children, connection=con, include=FALSE, output.var="msa_4_1_hm"}
-- creates an expanded data set of all household membbers of all resource homes
select distinct plac.PLAC_RESOURCE_ID as 'Resource ID'
		,rrhm_pers_id
		,ct.CODE_SHORT_DESC AS 'Facility Type'
		,p.pers_dob
		,RRHM_ROLE as 'Role'
		,RRHM_PART_START_DT
		,RRHM_PART_END_DT
	from MW_PLACEMENT plac
	join MW_RES_RSP_HOME_MEMB on plac.PLAC_RESOURCE_ID = RRHM_RESOURCE_ID
	join MW_PERS p on  rrhm_pers_id = p.PERS_PERS_ID
	join MW_CODE_TABLE ct on ct.CODE_TABLE_NAME = 'EXPCODE'
		AND ct.CODE_TABLE_VALUE = PLAC_FACILITY_TYPE
	where  --RRHM_ROLE = 'MEM'
			plac.PLAC_RQ_START_DT <= ?sql_period_censor_end
			and ISNULL(plac.PLAC_RQ_END_DT, GETDATE()) >=  ?sql_expanded_start
			and RRHM_RESOURCE_ID is not NULL
			and RRHM_PART_START_DT <= ?sql_period_censor_end
			and ISNULL(RRHM_PART_END_DT, GETDATE()) >=  ?sql_expanded_start
order by [Resource ID],[rrhm_pers_id]
```

```{r msa_4_1_validation_files, include=FALSE}
# saves the output of teh above sql queries to csv files

msa_4.1_hm <- msa_4_1_hm %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start,
             period_censor_date,'msa_4.1_validation_householdmembers','msa_4.1')

msa_4.1_case_relationships <- msa_basefiles_expanded_case_relationships %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>% 
  save_files(Sys.Date(),expanded_start,
             period_censor_date,'msa_4.1_validation_caserelationships', 'msa_4.1')
```

```{r msa_4_1, include=FALSE}
#  summary function. Comments added by Haritha Chekuru: If the executed chunk is giving last quarter's data instead of this quarter. Goto stored procedure mdcpsde_gen_resource_home_limits_supervisor_test and execute the following two lines.
# IF OBJECT_ID('dbo.mdcpsde_resource_home_limits_supervisor_test', 'U') IS NOT NULL 
# 	  DROP TABLE dbo.mdcpsde_resource_home_limits_supervisor_test; 
# Once it is done execute the stored procedure using the following command in the database 
# exec mdcpsde_gen_resource_home_limits_supervisor_test '20190331'  THis updates the table mdcpsde_resource_home_limits_supervisor_test with March 31 as Data date. Repeat the same process for January and February. which should be done automatically but not working.


home_limits_summary <- function(data, filename){
  data %>%
    dplyr::summarise(
      `Total Homes` = n(),
      `>5 Children` = sum(`total_children_in_home` > 5),
      `>3 Foster Children` = sum(`custody_children_placed` > 3),
      `>2 Children Under 2 or Therapeutic` = sum(
        (total_children_under_2 + therapeutic_children_placed) > 2),
      `# Meeting Standards` = sum(`meets_standards` == 'Yes'),
      `% Meeting Standards` = round((`# Meeting Standards`/`Total Homes`)*100,2),
      `# Not Meeting Standards` = sum(`meets_standards` == 'No'),
      `# Not Meeting Standards with Sibling Group Only` = sum(`meets_standards` == 'No' & `siblings_only` == 'Yes'),
      `% Not Meeting Standards with Sibling Group Only` = round((`# Not Meeting Standards with Sibling Group Only`/sum(`meets_standards` == 'No'))*100,2),
      `# Not Meeting Standards or Sibling Group Only Exception` = sum(`meets_standards` == 'No' & `siblings_only` == 'No'),
      `# Homes with more than 3 and less than 5 Custody Children, with Approval (Non-Sibling Group)` = sum(`custody_children_placed` > 3 & `custody_children_placed` <= 5 & `resd_app_both_nmbr` >= `custody_children_placed` & `siblings_only` == 'No'),
      `% of Homes with more than 3 and less than 5 Custody Children, with Approval` = round((`# Homes with more than 3 and less than 5 Custody Children, with Approval (Non-Sibling Group)`/ `# Not Meeting Standards or Sibling Group Only Exception`)*100,2),
      `# of Homes Meeting Standard or an Exception` = (`# Meeting Standards` + `# Not Meeting Standards with Sibling Group Only` + `# Homes with more than 3 and less than 5 Custody Children, with Approval (Non-Sibling Group)`),
      `% of Homes Meeting Standard or Exception` = round((`# of Homes Meeting Standard or an Exception`/`Total Homes`)*100,2)) %>% 
        save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_4.1')
  
}

# function that creates a dataframe of all rsource homes with children placed on a particular day 
resource_home_limits <- function(pit = Sys.Date()) {
  db_con <- con
  paste(
      'exec mdcpsde_gen_resource_home_limits_supervisor_test',
      paste0('\'', gsub('-', '', pit), '\'')
    ) %>%
    DBI::dbExecute(db_con, .)
  result <- dplyr::tbl(db_con, 'mdcpsde_resource_home_limits_supervisor_test') %>%
    dplyr::collect() %>%
    dplyr::mutate(
      `Data Date` = as.Date(`Data Date`)
      #Region = factor(Region, levels = region_vector()),
      #County = factor(County, levels = unique(sort(County)))
    ) %>%
    dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower)

  result
}
# creates at list of all end of month dates for teh entire msa period
msa_month_ends <- as.list((unique(msa_months$`month_end`)))

# Cretaes an object that conatins one record for each resource home with children placed on the last day of the month for each month in the msa period
home_limits_over_quarter <- lapply(
    msa_month_ends, 
    resource_home_limits
  ) %>%
  dplyr::bind_rows() %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::group_by(resource_id, data_date)


# creates a dataset of all homes for each month in the msa with some calculated columns for total children under 2 or with therapeutic needs, and homes with between 3 and 5 custody children where the number of children placed was less than or equal to the number of beds the home was approved for
home_limits_over_quarter_a <- home_limits_over_quarter %>%
  dplyr::arrange(resource_id, data_date) %>%
  dplyr::distinct(resource_id, data_date, .keep_all = T) %>%
  dplyr::mutate(children_under_2_with_therapeutic_needs = sum(total_children_under_2 + therapeutic_children_placed,na.rm = T),
                `3_5_with_approval` = case_when(`custody_children_placed` > 3 & `custody_children_placed` <= 5 & `resd_app_both_nmbr` >= `custody_children_placed` & `siblings_only` == 'No' ~ "Yes",
                                                TRUE ~ "No")) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_4_1_resourcehomelimits_new_details', 'msa_4.1')

# dplyr::anti_join(all_plac_pit, a, by = "Child ID")
# 
# custody_children_no_active_placement <- dplyr::anti_join(a, all_plac_pit, by = "Child ID")

# home_limits_over_quarter_county_summary <- home_limits_over_quarter %>%
#   dplyr::group_by(data_date, region, county) %>%
#   home_limits_summary('msa_4.1Resource_Home_Limits_County_Summary')
# 
# home_limits_over_quarter_region_summary <- home_limits_over_quarter %>%
#   dplyr::group_by(data_date, region) %>%
#   home_limits_summary('msa_4.1_Resource_Home_Limits_Region_Summary')

# uses summary function to create a dataset that counts only homes that are licensed by mdcps by month uisng the criteria in teh summary function
home_limits_over_quarter_state_summary <- home_limits_over_quarter_a %>%
  # groups data by month
  dplyr::group_by(data_date) %>%
  # keeps only mdcps homes
  dplyr::filter(is.na(`umbrella_type`)) %>%
  # rolls up details into summary file
  home_limits_summary('msa_4.1_Resource_Home_Limits_new_State_Summary')  %>%
  dplyr::ungroup()

```


```{r msa_4_2, include = FALSE}
# creates a dataset that provides a population of children in one of listed family based settings on the last day of the period and creates a summary file that counts by placement type and rate
msa_4_2_specialneeds_summary <- all_placements_period %>% 
   dplyr::filter(`facility_type` %in% c("Foster Home", "Therapeutic Foster Home", "Adoptive Home (Domestic)", "Teenage Parent Foster Home", "Emergency Foster Home","Relative Foster Home", "Foster/Adopt Foster Home", "Adoption Unit Foster Home", "Respite Foster Home", "Expedited Pending Relative Res", "ICPC - Incoming")) %>%
  dplyr::filter(`placement_start` <= period_end_date & (is.na(`placement_end`)|`placement_end` > period_end_date)) %>% 
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_4.2_placements_familybased_pit', 'msa_4.2') %>%
  dplyr::select(1:14) %>%
  dplyr::group_by(`facility_type`, `rate`) %>%
  dplyr::summarise(n()) %>%
  janitor::adorn_totals("row") %>%
  # tidyr::spread(key = `rate`, value = `n()`) %>%
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_4.2_placements_familybased_summary', 'msa_4.2')  %>%
  dplyr::ungroup()
 
 
```

```{r msa_4_3, include = FALSE}
# Creates a detail and summary file of custody children on the last day of the period in placement groupings established in the 2nd msa
msa_4_3_leastrestrictive <- all_placements_period %>%
  dplyr::filter(placement_start <= period_end_date & (is.na(placement_end)|placement_end > period_end_date)) %>%
  dplyr::mutate(`grouping` = ifelse(`facility_type` %in% c("Own Home", "Own Home - Mother", "Own Home- Father", "Own Home- Other Caretaker", "Own Home- Parents", "Expedited Pending Relative Res", "Relative Foster Home", "CO Non Licensed Relative"), "0",
                                    ifelse(`facility_type` %in% c("Adoption (International)", "Adoption Unit Foster Home", "Adoptive Home (Domestic)", "Emergency Foster Home", "Foster Home", "Foster/Adopt Foster Home", "ICPC - Incoming", "ICPC - Outgoing", "Medical/Treatment Foster Home", "Respite Foster Home","Teenage Parent Foster Home", "Therapeutic Foster Home", "Maternity Home", "Child Placing Agency"), ifelse(`child_placed_in_proximity?` == "Y","1","2"), 
                                           ifelse(`facility_type`%in% c("Therapeutic Group Home", "Supervised Indep. Living", "Residential Child Caring Facil", "Medical Treatment Group Home", "Licensed Facility", "Institution", "Group Home", "Emergency Shelter", "CO NonLicensed Shelter", "Specialized Residential School"), "3", 
                                                  ifelse(`facility_type` %in% c("Acute Care", "Chemically Dependent Group", "CO NonLicensed Det/Trng School", "Contract Facility - Non MDHS", "ICFMR", "Nursing Home", "Placement Services", "Residential Treatment"), "4",
                                                         ifelse(`facility_type` %in% c("Runaway"), "5", "None" )))))) %>%
  dplyr::arrange(`grouping`) %>%
  dplyr::distinct(placement_id, .keep_all = TRUE) %>%
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_4.3_placements_leastrestrictive_pit_details', 'msa_4.3') 
  
  msa_4_3_leastrestrictive_qend <- msa_4_3_leastrestrictive %>%
  dplyr::group_by(`grouping`, facility_type) %>%
  dplyr::summarise(
    `Total Children Placed` = n()
     ) %>%
  janitor::adorn_totals("row") %>%
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_4.3_placements_leastrestrictive_summary', 'msa_4.3')  %>%
  dplyr::ungroup()

  
```

```{r msa_4_4_50mileRadius, include = FALSE}
# summary function that takes a list fo placements and counts the number of placements, the number where teh 50 mile radius button was selected, the number where it was not but a reason was selected, and the number where neither is true
msa_4_4_summary <- function(data, filename){
  data %>%
    dplyr::summarise(
      `Total PIT Placements` = n(),
      `Placments within 50 Mile Radius` = sum(`child_placed_in_proximity?` == "Y",na.rm = T),
      `Placements not within 50 mile radius` = sum(`Total PIT Placements` - `Placments within 50 Mile Radius`),
      `Placements not within 50 mile radius, with exception noted` = sum(`child_placed_in_proximity?` == "N" & !is.na(`reason_not_placed_in_proximity`)),
      `Placements not within 50 miles and no exception` = sum( `Total PIT Placements`- `Placments within 50 Mile Radius`-`Placements not within 50 mile radius, with exception noted`),
      `Placements within 50 Mile Radius or Exception Noted` = sum(`Placments within 50 Mile Radius` + `Placements not within 50 mile radius, with exception noted`),
      `% TOTAL PIT PLACEMENTS` = round((`Total PIT Placements`/ `Total PIT Placements`)*100, 2),
      `% of Placements within 50 Mile Radius` = round((`Placments within 50 Mile Radius`/`Total PIT Placements`)*100, 2),
      `% of Placements not within 50 Mile Radius` = round(( `Placements not within 50 mile radius`/`Total PIT Placements`)*100, 2),
      `% of Placements not within 50 miles, with exception noted` = round((`Placements not within 50 mile radius, with exception noted`/`Placements not within 50 mile radius`)*100, 2),
      `% Placements not within 50 mile radius and no exception noted` = round((`Placements not within 50 miles and no exception`/`Placements not within 50 mile radius`)*100, 2),
      `% Placements within 50 miles radius or exception noted` = round((sum(`Placments within 50 Mile Radius` + `Placements not within 50 mile radius, with exception noted`)/ `Total PIT Placements`)*100, 2)) %>%
    save_files(Sys.Date(),period_end_date,period_end_date, filename, 'msa_4.4')
}

msa_4.4 <- all_placements_period %>%
  dplyr::select(1:18) %>%
  dplyr::filter(placement_start <= period_end_date & (is.na(placement_end)|placement_end > period_end_date)) %>%
  dplyr::left_join(select(all_custody_expanded,`region`, child_id), by = "child_id") %>% 
  dplyr::ungroup() %>%
  dplyr::distinct(child_id, placement_id, .keep_all = TRUE) %>%
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_4.4_placement_50mileradius_pit','msa_4.4')

msa_4_4_50mileRadius_county_summary <- msa_4.4 %>%
  dplyr::group_by(`region`, `county`) %>%
  msa_4_4_summary('msa_4.4_placement_50mileradius_county_summary')

msa_4_4_50MileRadius_region_summary <- msa_4.4 %>%
  dplyr::group_by(`region`) %>%
  msa_4_4_summary('msa_4.4_placement_50mileradius_region_summary')

msa_4_4_50MileRadius_statewide_summary <- msa_4.4 %>%
  msa_4_4_summary('msa_4.4_placement_50mileradius_statewide_summary')  %>%
  dplyr::ungroup()

unique_4.3 <- duplicated(msa_4_3_leastrestrictive$child_id)
compare_4.3_4.4 <- msa_4_3_leastrestrictive %>%
  dplyr::anti_join(msa_4.4)

compare_4.4_4.3 <- msa_4.4 %>%
  dplyr::anti_join(msa_4_3_leastrestrictive)
```

```{sql first_placements_expanded, connection=con, include=FALSE, output.var="msa_4.6_first_placements_expanded"}
select distinct Region
		,mce.County
		,CASP_CASE_ID as 'Case ID'
		,mce.[Child ID]
		,mce.[Custody Start]
		,mce.[Custody End]
		,mce.[Custody Sequence Number]
		,mp.[Resource ID]
		,mp.[Placement Start]
		,mp.[Placement End]
		,mp.[Placement Sequence Per Episode]
		,mp.[Placed Together]
		,mp.[Reason Not Placed Together]
	from mdcpsde_custody_episodes mce
		,mdcpsde_placements mp
		,MW_CASE_PERS casp
	where mce.[Child ID] = mp.[Child ID]
		and mce.[Custody Sequence Number] = mp.[Custody Sequence Number]
		and mp.[Placement Sequence Per Episode] = 1
		and CASP_PERS_ID = mce.[Child ID]
		and ISNULL(CASP_RSN_CHANGE, '0') <> '150'
		and mp.[Placement Start] >= ?sql_expanded_start
		and mp.[Placement Start] <= ?sql_period_censor_end
		and mp.[Placement Start] >= CASP_START_DATE
		and mp.[Placement Start] < ISNULL(CASP_END_DATE, GETDATE())
		and ISNULL(mp.[Placement End], GETDATE()) <= ISNULL(CASP_END_DATE, GETDATE())
```

```{sql relationships_expanded, connection=con, include=FALSE, output.var="msa_4.6_relationships_expanded"}
set nocount on

---------------------------------------------------------------------------
	--- Table Definitions +++++++++++++++++++++++++++++++++++++++++++++++++++++
	---------------------------------------------------------------------------

declare @first_placements table (
		[Region] varchar(9)
		,[County] varchar(20)
		,[Case ID] int
		,[Child ID] int
		,[Custody Start] date
		,[Custody End] date
		,[Custody Sequence Number] int
		,[Resource ID] int
		,[Placement Start] date
		,[Placement End] date
		,[Placed Together] nchar(1)
		,[Reason Not Placed Together] varchar(30)
		,primary key([Child ID], [Custody Sequence Number], [Case ID])
	)
	
insert into @first_placements
	select distinct Region
		,mce.County
		,CASP_CASE_ID as 'Case ID'
		,mce.[Child ID]
		,mce.[Custody Start]
		,mce.[Custody End]
		,mce.[Custody Sequence Number]
		,mp.[Resource ID]
		,mp.[Placement Start]
		,mp.[Placement End]
		,mp.[Placed Together]
		,mp.[Reason Not Placed Together]
	from mdcpsde_custody_episodes mce
		,mdcpsde_placements mp
		,MW_CASE_PERS casp
	where mce.[Child ID] = mp.[Child ID]
		and mce.[Custody Sequence Number] = mp.[Custody Sequence Number]
		and mp.[Placement Sequence Per Episode] = 1
		and CASP_PERS_ID = mce.[Child ID]
		and ISNULL(CASP_RSN_CHANGE, '0') <> '150'
		and mp.[Placement Start] >= ?sql_expanded_start
		and mp.[Placement Start] <= ?sql_period_censor_end
		and mp.[Placement Start] >= CASP_START_DATE
		and mp.[Placement Start] < ISNULL(CASP_END_DATE, GETDATE())
		and ISNULL(mp.[Placement End], GETDATE()) <= ISNULL(CASP_END_DATE, GETDATE())
		
select [Case ID]
		,[Child ID] as 'Person ID'
		,PERR_RELATED_ID as 'Relative ID'
		,PERR_START_DT as 'Relationship Start'
		,PERR_END_DT as 'Relationship End'
		,RTRIM(rel.CODE_SHORT_DESC) as 'Relationship'
		,ROW_NUMBER() over (
			partition by PERR_PERS_ID, PERR_RELATED_ID
			order by PERR_START_DT, PERR_END_DT, PERR_TIMESTAMP
		) as 'Relationship Sequence'
	from @first_placements fp
	inner join MW_PERS_REL
	 on fp.[Child ID] = PERR_PERS_ID
		 and ISNULL(PERR_REASON_CHANGED, '0') <> '150'
		 and PERR_START_DT <= fp.[Placement Start]
		 and ISNULL(PERR_END_DT, GETDATE()) >= fp.[Placement Start]
	inner join MW_CASE_PERS
	 on PERR_RELATED_ID = CASP_PERS_ID
		and [Case ID] = CASP_CASE_ID
	inner join MW_CODE_TABLE rel
	 on rel.CODE_TABLE_NAME = 'RELTNSHP'
		and rel.CODE_TABLE_VALUE = PERR_RELATIONSHIP
		and rel.CODE_SHORT_DESC like '%sibling%'
	inner join MW_CUSTODY_PER
	 on CUST_CHILD_PERS_ID = PERR_RELATED_ID
		and CUST_IN_CUSTODY_DT <= DATEADD(DD, 30, fp.[Placement Start])
		and ISNULL(CUST_CUSTODY_RELEASE_DT, GETDATE()) >= DATEADD(DD, -30, fp.[Placement Start])
```

```{sql sibling_groups_expanded, connection=con, include=FALSE, output.var="msa_4.6_siblings_expanded"}
set nocount on
---------------------------------------------------------------------------
	--- Table Definitions +++++++++++++++++++++++++++++++++++++++++++++++++++++
	---------------------------------------------------------------------------

	declare @first_placements table (
		[Region] varchar(9)
		,[County] varchar(20)
		,[Case ID] int
		,[Child ID] int
		,[Custody Start] date
		,[Custody End] date
		,[Custody Sequence Number] int
		,[Resource ID] int
		,[Placement Start] date
		,[Placement End] date
		,[Placed Together] nchar(1)
		,[Reason Not Placed Together] varchar(30)
		,primary key([Child ID], [Custody Sequence Number], [Case ID])
	)
	declare @relationships table (
		[Case ID] int
		,[Person ID] int
		,[Relative ID] int
		,[Relationship Start] date
		,[Relationship End] date
		,[Relationship] varchar(30)
		,[Relationship Sequence] int
		,primary key([Case ID], [Person ID], [Relative ID], [Relationship Sequence])
	)
	
	---------------------------------------------------------------------------
	--- Table Variable Queries ++++++++++++++++++++++++++++++++++++++++++++++++
	---------------------------------------------------------------------------

	insert into @first_placements
	select distinct Region
		,mce.County
		,CASP_CASE_ID as 'Case ID'
		,mce.[Child ID]
		,mce.[Custody Start]
		,mce.[Custody End]
		,mce.[Custody Sequence Number]
		,mp.[Resource ID]
		,mp.[Placement Start]
		,mp.[Placement End]
		,mp.[Placed Together]
		,mp.[Reason Not Placed Together]
	from mdcpsde_custody_episodes mce
		,mdcpsde_placements mp
		,MW_CASE_PERS casp
	where mce.[Child ID] = mp.[Child ID]
		and mce.[Custody Sequence Number] = mp.[Custody Sequence Number]
		and mp.[Placement Sequence Per Episode] = 1
		and CASP_PERS_ID = mce.[Child ID]
		and ISNULL(CASP_RSN_CHANGE, '0') <> '150'
		and mp.[Placement Start] >= ?sql_expanded_start
		and mp.[Placement Start] <= ?sql_period_censor_end
		and mp.[Placement Start] >= CASP_START_DATE
		and mp.[Placement Start] < ISNULL(CASP_END_DATE, GETDATE())
		and ISNULL(mp.[Placement End], GETDATE()) <= ISNULL(CASP_END_DATE, GETDATE())
		
insert into @relationships
	select [Case ID]
		,[Child ID] as 'Person ID'
		,PERR_RELATED_ID as 'Relative ID'
		,PERR_START_DT as 'Relationship Start'
		,PERR_END_DT as 'Relationship End'
		,RTRIM(rel.CODE_SHORT_DESC) as 'Relationship'
		,ROW_NUMBER() over (
			partition by PERR_PERS_ID, PERR_RELATED_ID
			order by PERR_START_DT, PERR_END_DT, PERR_TIMESTAMP
		) as 'Relationship Sequence'
	from @first_placements fp
	inner join MW_PERS_REL
	 on fp.[Child ID] = PERR_PERS_ID
		 and ISNULL(PERR_REASON_CHANGED, '0') <> '150'
		 --and PERR_START_DT <= fp.[Placement Start]
		 and ISNULL(PERR_END_DT, GETDATE()) >= fp.[Placement Start]
	inner join MW_CASE_PERS
	 on PERR_RELATED_ID = CASP_PERS_ID
		and [Case ID] = CASP_CASE_ID
	inner join MW_CODE_TABLE rel
	 on rel.CODE_TABLE_NAME = 'RELTNSHP'
		and rel.CODE_TABLE_VALUE = PERR_RELATIONSHIP
		and rel.CODE_SHORT_DESC like '%sibling%'
	inner join MW_CUSTODY_PER
	 on CUST_CHILD_PERS_ID = PERR_RELATED_ID
		and CUST_IN_CUSTODY_DT <= DATEADD(DD, 30, fp.[Placement Start])
		and ISNULL(CUST_CUSTODY_RELEASE_DT, GETDATE()) >= DATEADD(DD, -30, fp.[Placement Start])
		
select GETDATE() as 'Run Date'
		,'20171201' as 'Period Start'
		,?sql_period_censor_end as 'Period End'
		,Region
		,County
		,[Child ID]
		,[Case ID]
		,[Custody Start]
		,[Custody End]
		,[Custody Sequence Number]
		,[Resource ID]
		,[Placement Start]
		,[Placement End]
		,[Placed Together]
		,[Reason Not Placed Together]
		,Relationship
		,[Sibling ID]
		,[Sibling First Placement]
		,[Sibling First Placement Start]
		,[Siblings Placed Together]
	from (
		select fp.Region
			,fp.County
			,fp.[Child ID]
			,fp.[Case ID]
			,fp.[Custody Start]
			,fp.[Custody End]
			,fp.[Custody Sequence Number]
			,fp.[Resource ID]
			,fp.[Placement Start]
			,fp.[Placement End]
			,fp.[Placed Together]
			,fp.[Reason Not Placed Together]
			,rels.Relationship
			,rels.[Relative ID] as 'Sibling ID'
			,fp2.[Resource ID] as 'Sibling First Placement'
			,fp2.[Placement Start] as 'Sibling First Placement Start'
			,case
				when fp.[Resource ID] = fp2.[Resource ID] and DATEDIFF(DD, fp.[Placement Start], fp2.[Placement Start]) <= 30 then 1
				else 0
			end as 'Siblings Placed Together'
			,ROW_NUMBER() over (
				partition by fp.[Child ID], fp.[Case ID], fp.[Custody Sequence Number], rels.[Relative ID]
				order by fp2.[Custody Start], fp2.[Custody End]
			) 'SEQ' -- Keep only the first instance of a sibling entering custody with the target child's custody episode/case
		from @first_placements fp
		left join @relationships rels
		 on fp.[Child ID] = rels.[Person ID]
			and fp.[Case ID] = rels.[Case ID]
		left join @first_placements fp2
		 on fp2.[Child ID] = rels.[Relative ID]
			and fp2.[Case ID] = fp.[Case ID]
		where DATEDIFF(DD, fp.[Custody Start], fp2.[Custody Start]) <= 30
	) q
	where q.SEQ = 1
	

```

```{r msa_4_6_validationfiles, include=FALSE}
msa_4.6_siblings_expanded <- msa_4.6_siblings_expanded %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date,
             'msa_4.6_siblinggroups_expanded','msa_4.6')

msa_4.6_first_placements_expanded <- msa_4.6_first_placements_expanded %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date,
             'msa_4.6_firstplacements_expanded','msa_4.6')

msa_4.6_relationships_expanded <- msa_4.6_relationships_expanded %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start,
             period_censor_date,'msa_4.6_relationships_expanded','msa_4.6')
```

```{r msa_4_6, include=FALSE}
placed_together_summary <- function(data, filename) {
  data %>%
    dplyr::summarise(`Total Sibling Groups` = n(),
                       `Siblings Groups after Applying Exceptions` = sum(`exclude_sibling` != "Y"|is.na(`exclude_sibling`)),
                       `Sibling Groups with All Siblings Placed Together` = sum((`exclude_sibling` == "N"|is.na(`exclude_sibling`)) & `final_group_together` == "Y"|is.na(`final_group_together`)),
                      `% Total Sibling Groups` = round((`Total Sibling Groups`/`Total Sibling Groups`)*100,2),
                      `% Sibling Group after Applying Exceptions` = round((`Siblings Groups after Applying Exceptions`/`Total Sibling Groups`)*100,2),
                      `% Sibling Groups Placed Together` =  round((`Sibling Groups with All Siblings Placed Together`/`Siblings Groups after Applying Exceptions`)*100,2)) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_4.6')
}

expanded_siblings <- msa_4.6_siblings_expanded 

sibling_custody_ranges <- expanded_siblings %>% 
  dplyr::group_by(`case_id`) %>%
  dplyr::summarize(Max = max(`custody_start`), Min = min(`custody_start`)) %>%
  dplyr::filter_(~Max != Min)

number_Sibling_groups <- expanded_siblings %>% dplyr::group_by(`case_id`) %>% summarize(count = n_distinct(child_id))

a <- expanded_siblings %>%
  dplyr::summarise(`Total Sibling Groups` = n_distinct(`case_id`),
                   `Total Siblings in Groups` = n_distinct(child_id)) 

b <- expanded_siblings %>%
  dplyr::filter(`custody_start` >= msa_start & `custody_start` <= period_end_date) %>%
  dplyr::summarise(`Total Sibling Groups` = n_distinct(`case_id`),
                   `Total Siblings in Groups` = n_distinct(child_id)) 

siblings_placed_together <- expanded_siblings %>%
  dplyr::filter(`custody_start` >= msa_start & `custody_start` <= period_end_date) %>%
  dplyr::group_by(
      region, county, child_id, `case_id`,
      custody_sequence_number, `custody_start`,
      `placed_together`,
      `reason_not_placed_together`,resource_id) %>%
  dplyr::mutate(`exclude_sibling` = ifelse(
    resource_id == `sibling_first_placement`, "N",ifelse(`reason_not_placed_together` == "Size of siblings group", "N",ifelse(!is.na(`reason_not_placed_together`), "Y","N"))),
    `group_size_flag` = ifelse(`reason_not_placed_together` == "Size of siblings group", "Y","N"))

sibling_groups_withsizeflag <- siblings_placed_together %>%
  dplyr::group_by(`case_id`) %>%
  dplyr::filter(`group_size_flag` == "Y") %>%
  dplyr::distinct(`case_id`)

siblings_placed_together <- dplyr::mutate(siblings_placed_together,`case_group_flag` = ifelse(`case_id` %in% sibling_groups_withsizeflag$`case_id`,"Y","N"))
 

  siblings_1 <- siblings_placed_together %>%
  dplyr::ungroup() %>%
  dplyr::group_by(`case_id`) %>%
  dplyr::distinct(resource_id) %>%
  dplyr::summarise(n()) %>%
  dplyr::filter(`n()` == "1")
  
 siblings_placed_together <- dplyr::mutate(siblings_placed_together,`all_siblings_together` = ifelse(`case_id` %in% siblings_1$`case_id`, "Y","N"))
  
  siblings_2 <- siblings_placed_together %>%
    dplyr::filter(`all_siblings_together` == "N") %>%
    dplyr::filter(`exclude_sibling` =="N") %>%
    dplyr::ungroup() %>%
    dplyr::group_by(`case_id`) %>%
    dplyr::distinct(resource_id) %>%
    dplyr::summarise(n()) %>%
    dplyr::filter(`n()` == "1")
  
  siblings_placed_together <- dplyr::mutate(siblings_placed_together, `modified_siblings_together` = ifelse(`case_id` %in% siblings_2$`case_id`,"Y","N"))
    
  siblings_3<- siblings_placed_together %>%
    dplyr::filter(`exclude_sibling` == "N", `case_group_flag` == "Y", `modified_siblings_together` == "N") %>%
    dplyr::group_by(`case_id`) %>%
    dplyr::distinct(resource_id) %>%
    dplyr::summarise(n())
  
   siblings_placed_together <- dplyr::mutate(siblings_placed_together, `modified_group_size_together` = ifelse(`case_id` %in% siblings_3$`case_id`, "Y","N"))
   
   siblings_placed_together <- dplyr::mutate(siblings_placed_together, `final_group_together` = ifelse(`all_siblings_together` == "Y","Y",ifelse(`modified_siblings_together` == "Y","Y",ifelse(`modified_group_size_together` == "Y","Y","N")))) %>%
     dplyr::ungroup() %>%
     dplyr::mutate(Quarter = zoo::as.yearqtr(as.Date(custody_start), by='quarters')) %>%
     save_files(Sys.Date(), msa_start,period_end_date,'msa_4.6_placements_siblings_initially_placed_together_msa_details','msa_4.6') %>%
     dplyr::group_by(`case_id`) %>%
     dplyr::distinct(`case_id`,.keep_all = TRUE) %>%
     dplyr::ungroup()
    
siblings_placed_together_county_summary <- siblings_placed_together %>%
  dplyr::group_by(Quarter, region, county) %>%
  placed_together_summary('msa_4.6_siblings_initially_placed_together_county_summary')

siblings_placed_together_region_summary <- siblings_placed_together %>%
  dplyr::group_by(Quarter, region) %>%
  placed_together_summary('msa_4.6_siblings_initially_placed_together_region_summary')

siblings_placed_together_state_summary <- siblings_placed_together %>%
  dplyr::group_by(Quarter) %>%
  placed_together_summary('msa_4.6_siblings_initially_placed_together_state_summary')  %>%
  dplyr::ungroup()
```

```{r msa_4_7, include=FALSE}
placement_disruption_summary <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Any placement Change` = any(`placement_change`),
      `Placement Change Count` = sum(`placement_change`),
      `Any Placement Disruption` = any(`placement_disrupted`),
      `Placement Disruption Count` = sum(`placement_disrupted`)
    ) %>%
    dplyr::summarise(
      `Total Children` = n(),
      `Children with placement_changes` = sum(`Any placement Change`),
      `% Children with placement_changes` = round(
        (`Children with placement_changes`/n())*100, 2
      )
#       `Children with Multiple Changes` = sum(`Placement Change Count` > 1),
#       `Total placement_changes` = sum(`Placement Change Count`),
#       `Children with Placement Disruptions` = sum(`Any Placement Disruption`),
#       `% Children with Placement Disruptions` = round(
#         (`Children with Placement Disruptions`/n())*100, 2
#       ),
#       `Children with Multiple Disruptions` = sum(`Placement Disruption Count` > 1),
#       `Total Placement Disruptions` = sum(`Placement Disruption Count`)
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_4.7')
}
placement_changes <- placements_expanded %>%
  dplyr::mutate(placement_sequence_per_episode = as.integer(placement_sequence_per_episode)) %>%
  dplyr::filter(placement_start <= period_end_date, 
                is.na(placement_end)|placement_end >= params$start_date) %>%
  dplyr::group_by(child_id) %>%
  dplyr::mutate(change_in_period = case_when(
     placement_start >= params$start_date & placement_sequence_per_episode > 1 & (is.na(placement_end)|placement_end > period_end_date) ~ -1,
     placement_end >=params$start_date & placement_end <= period_end_date ~ 1,
    placement_start <= params$start_date & is.na(placement_end)|placement_end >= period_end_date ~ 0,
    placement_start >= params$start_date & placement_sequence_per_episode == 1 & (is.na(placement_end)|placement_end >= period_end_date) ~ 0,
    TRUE ~ 0)
  ) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_4.7_placement_disruptions_details',
    'msa_4.7'
  )  %>%
  dplyr::ungroup()

```

```{r 4_9 func, eval=FALSE, include=FALSE}
congregate_care_placements <- function(
  date_filter = F,
  from = Sys.Date(),
  to = SysDate()
) {
  custody_child_demographics(date_filter, from, to) %>%
    dplyr::left_join(
      custody_placements(date_filter, from, to) %>%
        dplyr::select(-county)
    ) %>%
    (function(data){
      if (date_filter) {
        data %>%
          dplyr::filter(
            `placement_start` <= to,
            `placement_start` >= from
          )
      } else {
        data
      }
    }) %>%
    dplyr::select(
      region:`date_of_birth`,
      `resource_id`:`facility_type`,
      `approval_for_congregate_care`,
      `cong_care_reasons`,
      `rd_approval_date`
    ) %>%
    dplyr::filter(
      `facility_type` %in% c(
        #'Residential Treatment',
        'Nursing Home',
        'Chemically Dependent Group',
        #3'Adoption Unit Foster Home',
        'Specialized Residential School',
        #'Medical Treatment Group Home',
        'Contract Facility - Non MDHS',
        'Group Home',
        'Therapeutic Group Home',
        'Licensed Facility',
        'CO NonLicensed Det/Trng School',
        'Residential Child Caring Facil',
        'Institution',
        'Emergency Shelter'
      )
    ) %>%
    dplyr::mutate(
      age = lubridate::as.period(
        lubridate::interval(
          `date_of_birth`,
          `placement_start`
        )
      )$year
    )
}
```

```{r msa_4_9, include=FALSE}
cc_placements_summarise <- function(data, filename){
  data %>%
    dplyr::summarise(`CC Placement Before Age 10` = sum(age < 10),
                     `RD Approval` = any(!is.na(`rd_approval_date`))) %>%
   dplyr::summarise(
      `Children Placed in Congregate Care` = n(),
      `Children Placed in CC Before Age 10` = sum(`CC Placement Before Age 10`),
      `Children Placed in CC Before Age 10, wtih RD Approval` = sum(`CC Placement Before Age 10` & `RD Approval`),
      `% Children Placed in Congergate Care` = round((`Children Placed in Congregate Care`/`Children Placed in Congregate Care`)*100, 2),
      `% CC Placements Before Age 10` = round((`Children Placed in CC Before Age 10`/n())*100, 2),
      `% Children Placed in CC Before Age 10, wtih RD Approval` = round(( `Children Placed in CC Before Age 10, wtih RD Approval`/`Children Placed in CC Before Age 10`)*100,2)) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_4.9')
}

cc_placements_expanded <- congregate_care_placements(T, expanded_start, period_censor_date) %>%
  dplyr::mutate(
    `cong_care_reasons` = purrr::map_chr(
      `cong_care_reasons`,
      paste,
      collapse = '; '
    )
      ) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'msa_4.9_placements_congregatecare_expanded_details', 'msa_4.9')

cc_placements <- cc_placements_expanded %>%
  dplyr::filter(placement_start <= period_end_date, placement_start >= currentq_start, is.na(placement_end)|placement_end >= currentq_start) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_4.9_placements_congregatecare_quarter_details', 'msa_4.9')

cc_placements_county_summary <- cc_placements %>%
  dplyr::group_by(region, county, child_id) %>%
  cc_placements_summarise('msa_4.9_placements_congregatecare_county_summary')

cc_placements_region_summary <- cc_placements %>%
  dplyr::group_by(region, child_id) %>%
  cc_placements_summarise('msa_4.9_placements_congregatecare_region_summary')

cc_placements_state_summary <- cc_placements %>%
  dplyr::group_by(child_id) %>%
  cc_placements_summarise('msa_4.9_placements_congregatecare_state_summary')  %>%
  dplyr::ungroup()

cc_placements_summarise <- function(data, filename){
  data %>%
    dplyr::summarise(`CC Placement Before Age 10` = sum(age < 10),
                     `Before Age 10 With Approval` = sum(age < 10 & !is.na(approval_for_congregate_care)))  %>%
    save_files(Sys.Date(), currentq_start, period_end_date, filename, 'msa_4_9')
}

cc_placements <- congregate_care_placements(T, currentq_start,period_end_date) %>%
  dplyr::mutate(
    `Reason(s) Approved for Cong Care` = purrr::map_chr(
      `cong_care_reasons`,
      paste,
      collapse = '; '
    )
  ) %>%
  
  save_files(
    Sys.Date(),
    currentq_start,
    period_end_date,
    'Congregate_Care_Placements_q',
    'msa_4_9'
  )

cc_placements_county_summary <- cc_placements %>%
  dplyr::group_by(region, county) %>%
  cc_placements_summarise('Congregate_Care_Placements_County_Summary')

cc_placements_region_summary <- cc_placements %>%
  dplyr::group_by(region) %>%
  cc_placements_summarise('Congregate_Care_Placements_Region_Summary')

cc_placements_state_summary <- cc_placements %>%
  cc_placements_summarise('Congregate_Care_Placements_State_Summary')

cc_sum_test <-  cc_placements %>% dplyr::summarise(`CC Placement Before Age 10` = sum(age < 10),
                     `Before Age 10 With Approval` = sum(age < 10 & !is.na(approval_for_congregate_care)))

```

```{r msa_4_11, include=FALSE}

emergency_placements_expanded  <- custody_child_demographics(date_filter = T, expanded_start, period_censor_date) %>%
    dplyr::left_join(
      custody_placements(date_filter = F) %>%
        dplyr::select(-county)
    ) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
    dplyr::filter(`facility_type` == 'Emergency Shelter') %>%
    dplyr::arrange(`placement_sequence_per_episode`) %>%
    dplyr::group_by(child_id, custody_sequence_number) %>%
    dplyr::mutate(`emergency_placement_sequence` = row_number()) %>%
    dplyr::select(
     region:custody_end,
      placement_id:placement_timestamp,
      worker_id,
      approved_for_emergency_placement,
      emer_plac_reasons,
      emergency_placement_sequence, rd_approval_date
    ) %>%
    dplyr::ungroup() %>%
   dplyr::mutate(
    `emer_plac_reasons` = purrr::map_chr(
      `emer_plac_reasons`,
      paste,
      collapse = '; '
    )
  ) %>% save_files(Sys.Date(), expanded_start, period_censor_date, 'msa_4.11_placements_emergencyshelter_expanded_details', 'msa_4.11') %>%
   dplyr::filter(placement_start <= period_end_date, placement_start >= currentq_start) %>%
  save_files(Sys.Date(),
    msa_start,
    period_end_date,
    'msa_4.11_placements_emergencyshelter_quarter_details',
    'msa_4.11'
  )
msa_4.11_sum_test <- emergency_placements_expanded %>%
 filter(emergency_placement_sequence > 1) %>% 
 summarise(subsequent_placements =n(),
           with_approval = sum(approved_for_emergency_placement == "Y" & !is.na(approved_for_emergency_placement))) %>%
  save_files(Sys.Date(), period_start_date, period_end_date,'msa_4.11_placements_q_summary', 'msa_4.11')
  

```

```{r msa_5_1_a, include=FALSE, cahe=TRUE}
monthly_child_contacts_summarise <- function(data, filename) {
  data %>%
      dplyr::summarise(
    `Total Children in care for full month` = n(),
    `Children w 2+ Visits in Month` = sum(`All Monthly Contacts` >= 2),
    `Children with at least 2 visits, at least one of which occurred in the home` = sum(`All Monthly Contacts` >= 2 & `In-Home Monthly Contacts` >= 1, na.rm = T), 
    `% Children w 2+ Visits in Month` = round(`Children w 2+ Visits in Month`/n(),4)*100,
   `% Children with at least 2 visits, at least one of which occurred in the home` = round(
      `Children with at least 2 visits, at least one of which occurred in the home`/`Children w 2+ Visits in Month`,
      4) * 100) %>%
  save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_5.1.a')
}

monthly_child_contacts_1st <- custody_children(msa_start, period_end_date) %>%
  tidyr::crossing(month_frame(msa_start, period_end_date)) %>%
  dplyr::filter(
    `custody_start` <= `month_start`,
    `custody_end` >= `month_end` | is.na(`custody_end`)
  ) %>%
  dplyr::mutate(`custody_sequence_number` = as.integer(`custody_sequence_number`)) %>%
  dplyr::left_join(
     custody_child_contacts(msa_start, as.Date(period_end_date +1)) %>%
      dplyr::filter(
        `owner_job_code` %in% valid_contact_job_codes(),
        `contact_method` == 'Face-to-Face'
      ))

monthly_child_contacts <- monthly_child_contacts_1st %>%
  dplyr::anti_join(
      custody_placements(date_filter = T, msa_start, period_end_date) %>%
      dplyr::filter(`facility_type` == 'ICPC - Outgoing') %>% 
      dplyr::mutate(`custody_sequence_number` = as.integer(`custody_sequence_number`)) %>%
      tidyr::crossing(month_frame(msa_start, period_end_date)) %>%
     dplyr::mutate(include = case_when( `placement_start` < `month_start` & `placement_end` > `month_end` ~ "Y",
                                        month(`placement_start`) == month(`month_start`) ~ "Y",
                                        month(`placement_end`) == month(`month_end`) ~ "Y",
                                        TRUE ~ "N")) %>%
     dplyr::filter(include == "Y"), by = c("child_id" = "child_id", "contact_month" = "contact_month")
      ) %>%
  dplyr::arrange(desc(`narrative_datetime`), desc(`narrative_timestamp`)) %>%
  dplyr::select(
    region:`contact_month`,
    `narrative_owner`,
    `narrative_location`,
    `narrative_datetime`
  ) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_5.1.a_Monthly_Child_Contacts_Details', 'msa_5.1.a') %>%
  dplyr::group_by(`contact_month`, region, county, `child_id`) %>%
    dplyr::summarise(
      `All Monthly Contacts` = sum(!is.na(`narrative_datetime`)),
      `In-Home Monthly Contacts` = sum(`narrative_location` == 'Home', na.rm = T)
    ) %>% save_files(
    period_censor_date,
    msa_start, 
    period_end_date, 
    'msa_5.1.a_Monthly_Child_Contacts_Child_Summary_MSA', 
    'msa_5_1_a'
  ) %>%
  dplyr::mutate(
    `Required Visits Conducted` = dplyr::if_else(
      `All Monthly Contacts` > 2,
      as.integer(2),
      `All Monthly Contacts`
    ),
    `Required Visits in Home` = dplyr::if_else(
      `In-Home Monthly Contacts` > 1,
      as.integer(1),
      `In-Home Monthly Contacts`
    )
  )


monthly_child_contacts$`contact_month` <- factor(monthly_child_contacts$`contact_month`, 
                                                 levels = c("January 2018", "February 2018", "March 2018", "April 2018", "May 2018", "June 2018", "July 2018", "August 2018", "September 2018", "October 2018", "November 2018", "December 2018", "January 2019", "February 2019", "March 2019"))

monthly_child_contacts_county_summary <- monthly_child_contacts %>%
  dplyr::group_by(`contact_month`, region, county) %>%
  monthly_child_contacts_summarise('msa_5.1.a_Monthly_Child_Contacts_County_Summary')

monthly_child_contacts_region_summary <- monthly_child_contacts %>%
  dplyr::group_by(`contact_month`, region) %>%
  monthly_child_contacts_summarise(',msa_5.1.a_Monthly_Child_Contacts_Region_Summary')

monthly_child_contacts_state_summary <- monthly_child_contacts %>%
  dplyr::group_by(`contact_month`) %>%
  monthly_child_contacts_summarise('msa_5.1.a_Monthly_Child_Contacts_State_Summary')  %>%
  dplyr::ungroup()
```

```{r msa_5_1_b, include=FALSE}
thv_contacts_summarise <- function(data, filename) {
  data %>%
    # dplyr::summarise(
    #   `Contact Count` = sum(`valid_contact`)
    # ) %>%
    dplyr::summarise(
        `Total Children in THV` = n(),
        `# Met Contact Requirements` = sum(`Contact Count` >= 2),
        `% Met Contact Requirements` = round(
          (`# Met Contact Requirements`/n())*100, 2
        )
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_5.1.b')
}

thv_contacts <- thv_placement_contacts(msa_start, period_end_date) %>%
  dplyr::mutate(
    `valid_contact` = case_when(`owner_job_code` %in% valid_contact_job_codes() &
      (`narrative_location` == 'Home' & !is.na(`narrative_location`)) &
      `contact_method` == 'Face-to-Face' ~ 1,
      TRUE ~ 0
  )) %>%
  save_files(
    period_censor_date,
    msa_start, 
    period_end_date, 
    'msa_5.1.b_Contacts_in_First_90_Days_THV_Details', 
    'msa_5.1.b'
  ) %>%
  
  #Commented out by Haritha Chekuru 
  
  #group_by(contact_month, child_id) %>%
  #Added by the below group_by by Haritha Chekuru
  
  group_by(contact_month, region, county, child_id) %>%
  
  dplyr::summarise(
      `Contact Count` = sum(`valid_contact`))


thv_contacts$`contact_month` <- factor(thv_contacts$`contact_month`, levels = c("January 2018", "February 2018", "March 2018", "April 2018", "May 2018", "June 2018", "July 2018", "August 2018", "September 2018", "October 2018", "November 2018", "December 2018", "January 2019", "February 2019", "March 2019"))

# Commented by Scott Swafford

# thv_contacts_county_summary <- thv_contacts %>%
#   dplyr::group_by(`contact_month`, region, county, `child_id`) %>%
#   thv_contacts_summarise('msa_5.1.b_Contacts_in_First_90_Days_THV_County_Summary')
# 
# thv_contacts_region_summary <- thv_contacts %>%
#   dplyr::group_by(`contact_month`, region, `child_id`) %>%
#   thv_contacts_summarise('msa_5.1.b_Contacts_in_First_90_Days_THV_Region_Summary')



# Uncommented by Haritha Chekuru to get region and county summaries

thv_contacts_county_summary <- thv_contacts %>%
  dplyr::group_by(`contact_month`, region, county, `child_id`) %>%
  thv_contacts_summarise('msa_5.1.b_Contacts_in_First_90_Days_THV_County_Summary')

thv_contacts_region_summary <- thv_contacts %>%
  dplyr::group_by(`contact_month`, region, `child_id`) %>%
  thv_contacts_summarise('msa_5.1.b_Contacts_in_First_90_Days_THV_Region_Summary')


thv_contacts_state_summary <- thv_contacts %>%
  dplyr::group_by(`contact_month`) %>%
  thv_contacts_summarise('msa_5.1.b_Contacts_in_First_90_Days_THV_State_Summary')  %>%
  dplyr::ungroup()

```

```{r msa_5_1_c, include=FALSE}
# mnthly_parent_contacts_summarise <- function(data, filename) {
#   data %>%
#     dplyr::summarise(
#       `Parent Contacts` = sum(!is.na(`Narrative DateTime`))
#     ) %>%
#     dplyr::summarise(
#       `Total Parents` = n(),
#       `Parents Contacted` = sum(`Parent Contacts` > 0, na.rm = T),
#       `% Parents Contacted` = round(
#         (`Parents Contacted`/`Total Parents`)*100, 2
#       )
#     ) %>%
#     save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_5.1.c')
# }
# 
# mnthly_parent_contacts <- custody_parent_monthly_contacts(
#     msa_start, 
#     period_end_date
#   ) %>%
#   save_files(
#     period_censor_date,
#     msa_start,
#     period_end_date,
#     'Monthly_Parent_Contacts_Details',
#     'msa_5_1_c'
#   )
# mnthly_parent_contacts$`Month Name` <- factor(mnthly_parent_contacts$`Month Name`, levels = c("January 2018", "February 2018", "March 2018", "April 2018", "May 2018", "June 2018"))
# 
# mnthly_parent_contacts_county_summary <- mnthly_parent_contacts %>%
#   dplyr::select(
#     `Month Name`, 
#     Region,
#     County, 
#     `Parent ID`, 
#     `Narrative DateTime`
#   ) %>%
#   unique() %>%
#   dplyr::group_by(`Month Name`, Region, County, `Parent ID`) %>%
#   mnthly_parent_contacts_summarise('Monthly_Parent_Contacts_County_Summary')
# 
# mnthly_parent_contacts_region_summary <- mnthly_parent_contacts %>%
#   dplyr::select(
#     `Month Name`, 
#     Region,
#     County, 
#     `Parent ID`, 
#     `Narrative DateTime`
#   ) %>%
#   unique() %>%
#   dplyr::group_by(`Month Name`, Region, `Parent ID`) %>%
#   mnthly_parent_contacts_summarise('Monthly_Parent_Contacts_Region_Summary')
# 
# mnthly_parent_contacts_state_summary <- mnthly_parent_contacts %>%
#   dplyr::select(
#     `Month Name`, 
#     Region,
#     County, 
#     `Parent ID`, 
#     `Narrative DateTime`
#   ) %>%
#   unique() %>%
#   dplyr::group_by(`Month Name`, `Parent ID`) %>%
#   mnthly_parent_contacts_summarise('Monthly_Parent_Contacts_State_Summary')
```

```{r msa.5.1.d_foster_parent_contact, include=FALSE}
foster_parent_contacts_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(`Monthly Contacts` = sum(!is.na(narrative_datetime))) %>%
    dplyr::summarise(
      `Total Resources` = n(),
      `Resources with Parent Contacted` = sum(`Monthly Contacts` > 0, na.rm = T),
      `% Resources with Parent Contacted` = round(
        (`Resources with Parent Contacted`/`Total Resources`)*100, 2
      )
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_5.1.d')
}

foster_parent_history(expanded_start, period_censor_date) %>% dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'msa_5.1.d_foster_parent_details_expanded', 'msa_5.1.d')
  
foster_parent_contacts <- foster_parent_history(msa_start, period_end_date) %>%
  tidyr::crossing(month_frame(msa_start, period_end_date)) %>%
  dplyr::filter(
    `placement_start` <= month_start,
    `placement_end` >=month_end | is.na(`placement_end`),
    foster_parent_start <=month_end | is.na(foster_parent_start),
    foster_parent_end >= month_start | is.na(foster_parent_end),
    `placement_type` %in% c("ICPC - Incoming","Foster Home",
                           "Emergency Foster Home",
                           "Therapeutic Foster Home",
                           "Foster/Adopt Foster Home",
                           "Adoption Unit Foster Home",
                           "Adoptive Home (Domestic)",
                           "Respite Foster Home",
                           "Relative Foster Home",
                           "Teenage Parent Foster Home")
  ) %>%
  dplyr::left_join(
    monthly_contacts(msa_start, period_end_date) %>%
      dplyr::filter(
        `owner_job_code` %in% valid_contact_job_codes(),
        `contact_method` == 'Face-to-Face',
        narrative_location == 'Home'
      ),
    by = c(
      'foster_parent_id' = 'participant_id',
      'contact_month' = 'contact_month',
      'month_start' = 'month_start',
      'month_end' = 'month_end'
    )
  ) %>%
  dplyr::left_join(
    resource_services(msa_start, period_end_date) %>%
      dplyr::select(`resource_id`, region, county) %>%
      unique()
  ) %>%
  dplyr::select(
    `contact_month`:`month_end`,
    region:`placement_end`,
    `narrative_owner`: `narrative_location`,
    `contact_type`
  ) %>%
  save_files(Sys.Date(),
    msa_start,
    period_end_date,
    'msa_5.1.d_Contacts_With_Foster_Parents_Details',
    'msa_5.1.d'
  ) %>%
  dplyr::filter()

# test1 <- foster_parent_contacts %>%
#   group_by(contact_month) %>%
#   dplyr::summarise(
#       `Total Resources` = n(),
#       `Resources with Parent Contacted` = sum(`monthly_contacts` > 0, na.rm = T),
#       `% Resources with Parent Contacted` = round(
#         (`Resources with Parent Contacted`/`Total Resources`)*100, 2
#       )
#     )
 # test1$`contact_month` <- factor(test1$`contact_month`, levels = c("January 2018", "February 2018", "March 2018", "April 2018", "May 2018", "June 2018", "July 2018", "August 2018", "September 2018", "October 2018", "November 2018", "December 2018")) 

foster_parent_contacts$`contact_month` <- factor(foster_parent_contacts$`contact_month`, levels = c("January 2018", "February 2018", "March 2018", "April 2018", "May 2018", "June 2018", "July 2018", "August 2018", "September 2018", "October 2018", "November 2018", "December 2018", "January 2019", "February 2019", "March 2019"))

# foster_parent_contacts_county_summary <- foster_parent_contacts %>%
#   dplyr::select(`Contact Month`, Region, County, `Resource ID`, `Narrative DateTime`) %>%
#   unique() %>%
#   dplyr::group_by(`Contact Month`, Region, County, `Resource ID`) %>%
#   foster_parent_contacts_summarise('msa_5.1.d_Contacts_With_Foster_Parents_County_Summary')
# 
# foster_parent_contacts_region_summary <- foster_parent_contacts %>%
#   dplyr::select(`Contact Month`, Region, County, `Resource ID`, `Narrative DateTime`) %>%
#   unique() %>%
#   dplyr::group_by(`Contact Month`, Region, `Resource ID`) %>%
#   foster_parent_contacts_summarise('msa_5.1.d_Contacts_With_Foster_Parents_Region_Summary')

foster_parent_contacts_state_summary <- foster_parent_contacts %>%
  dplyr::select(`contact_month`, region, county, `resource_id`, `narrative_datetime`) %>%
  unique() %>%
  dplyr::group_by(`contact_month`, `resource_id`) %>%
  foster_parent_contacts_summarise('msa_5.1.d_Contacts_With_Foster_Parents_State_Summary')  %>%
  dplyr::ungroup()

# foster_parent_contacts$`Contact Month` <- factor(foster_parent_contacts$`contact_month`, levels = c("January 2018", "February 2018", "March 2018", "April 2018", "May 2018", "June 2018", "July 2018", "August 2018", "September 2018"))
# 
# foster_parent_contacts_county_summary <- foster_parent_contacts %>%
#   dplyr::select(`Contact Month`, Region, County, `Resource ID`, narrative_datetime) %>%
#   unique() %>%
#   dplyr::group_by(`Contact Month`, Region, County, `Resource ID`) %>%
#   foster_parent_contacts_summarise('msa_5.1.d_Contacts_With_Foster_Parents_County_Summary')
# 
# foster_parent_contacts_region_summary <- foster_parent_contacts %>%
#   dplyr::select(`Contact Month`, Region, County, `Resource ID`, narrative_datetime) %>%
#   unique() %>%
#   dplyr::group_by(`Contact Month`, Region, `Resource ID`) %>%
#   foster_parent_contacts_summarise('msa_5.1.d_Contacts_With_Foster_Parents_Region_Summary')
# 
# foster_parent_contacts_state_summary <- foster_parent_contacts %>%
#   dplyr::select(`Contact Month`, Region, County, `Resource ID`, narrative_datetime) %>%
#   unique() %>%
#   dplyr::group_by(`Contact Month`, `Resource ID`) %>%
#   foster_parent_contacts_summarise('msa_5.1.d_Contacts_With_Foster_Parents_State_Summary')  %>%
#   dplyr::ungroup()
```

```{r msa_6.1.a_initial_fsp_timeliness, include=FALSE}
initial_fsp_submitted_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Children in Custody 45 Days` = n(),
      `FSP Submitted in 30 Days` = sum(submitted_days <= 30, na.rm = T),
      `FSP approved within 15 days` = sum(approved_days <= 15, na.rm = T),
      `FSP Submitted and Approved within 45 days` = sum(total_days <= 45, na.rm = T),
      `% Children in Custody 45 Days` = round((`Children in Custody 45 Days`/`Children in Custody 45 Days`)*100, 2),
      `% FSP Submitted in 30 Days` = round((`FSP Submitted in 30 Days`/`Children in Custody 45 Days`)*100,2),
      `% fsp_approved in 15 days` = round((`FSP approved within 15 days`/`Children in Custody 45 Days`)*100,2),
      `% FSP Submitted and Approved within 45 days` = round((`FSP Submitted and Approved within 45 days`/ `Children in Custody 45 Days`)*100, 2)
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_6.1.a')
}

custody_currentq <- custody_expanded %>%
  dplyr::filter(`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`),
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
    difftime(currentq_start, `custody_start`, unit = 'days') <= 45,
    `custody_start`  <= period_end_date,
    currentq_start <= `custody_end` | is.na(`custody_end`)) %>%
  distinct(child_id, custody_sequence_number, .keep_all = T)
  

expanded_fsp <- family_service_plans(expanded_start,Sys.Date()) %>% 
  dplyr::mutate(quarter = zoo::as.yearqtr(custody_start, by='quarters')) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'msa_6.1.a_fsp_expanded_details', 'msa_6.1.a')

initial_fsp_msa <- expanded_fsp %>%
  dplyr::filter( 
    (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
    `custody_start`  <= period_end_date
  ) %>%
  dplyr::group_by(`child_id`, `custody_sequence_number`) %>%
  dplyr::arrange(child_id, custody_sequence_number, fsp_id) %>%
  dplyr::mutate(fsp_indicator = {if (any(fsp_submitted >= custody_start & !is.na(fsp_submitted))) "Y" else "N"}) %>%
  dplyr::filter(fsp_submitted >= custody_start|is.na(fsp_submitted)) %>%
  dplyr::filter(dplyr::row_number() == 1) %>%
  dplyr::ungroup() %>%
  dplyr::select(`run_date`:member_type, quarter) %>%
  unique() %>%
  dplyr::mutate(submitted_days = difftime(fsp_submitted, custody_start, units = "days"),
                approved_days = difftime(fsp_approved, fsp_submitted, units = "days"),
                total_days = difftime(fsp_approved, custody_start, unit = "days")) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.1.a_initial_fsp_msa_details',
    'msa_6.1.a'
  )

initital_fsp_currentq <- expanded_fsp %>%
  dplyr::filter( 
    (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
    custody_start %m+% days(45) >= currentq_start
  ) %>%
  dplyr::group_by(`child_id`, `custody_sequence_number`) %>%
  dplyr::arrange(child_id, custody_sequence_number, fsp_id) %>%
  dplyr::mutate(fsp_indicator = {if (any(fsp_submitted >= custody_start & !is.na(fsp_submitted))) "Y" else "N"}) %>%
  dplyr::filter(fsp_submitted >= custody_start|is.na(fsp_submitted)) %>%
  dplyr::filter(dplyr::row_number() == 1) %>%
  dplyr::ungroup() %>%
  dplyr::select(`run_date`:member_type, quarter) %>%
  dplyr::distinct(child_id, custody_sequence_number, .keep_all = T) %>%
  dplyr::mutate(submitted_days = difftime(fsp_submitted, custody_start, units = "days"),
                approved_days = difftime(fsp_approved, fsp_submitted, units = "days"),
                total_days = difftime(fsp_approved, custody_start, unit = "days")) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.1.a_initial_fsp_currentq_details',
    'msa_6.1.a'
  )


 dqc_6.1.a <-  expanded_pop_details %>%
   dplyr::filter((`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
     difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
     `custody_start`  >= msa_start, 
     `custody_start`  <= period_end_date
   ) %>%
   dplyr::anti_join(initital_fsp_currentq, by = "child_id")
 dqc_6.1.a_2 <- initital_fsp_currentq %>%
   dplyr::anti_join((expanded_pop_details %>%
   dplyr::filter(difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
                (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
                `custody_start`  >= msa_start, 
                `custody_start`  <= period_end_date)),
   by = "child_id")
 dqc_6.1.a_3 <- initital_fsp_currentq %>%
   dplyr::filter(is.na(fsp_id))

initial_fsp_submitted_county_summary_currentq <- initital_fsp_currentq %>%
  dplyr::group_by(region, county) %>%
  initial_fsp_submitted_summarise('msa_6.1.a_initial_fsp_county_summary')

initial_fsp_submitted_region_summary_currentq <- initital_fsp_currentq %>%
  dplyr::group_by(region) %>%
  initial_fsp_submitted_summarise('msa_6.1.a_initial_fsp_region_summary')

initial_fsp_submitted_state_summary_currentq <- initital_fsp_currentq %>%
  dplyr::group_by() %>%
  initial_fsp_submitted_summarise('msa_6.1.a_initial_fsp_state_summary')  %>%
  dplyr::ungroup()

```

```{r msa_6.1.d_initial_permanency_planning, include=FALSE}


# For 6.1.d->expanded: Period Start date is always three months prior to Jan 1 of that year (In this case Oct 1st 2018) and period end date is the snapshot date.

initial_permplan_approved_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Children in Custody 45 Days` = n(),
      `Perm Plan Submitted in 30 Days` = sum(submitted_days <= 30 & !is.na(plan_type), na.rm = T),
      `Perm Plan approved within 15 days` = sum(approved_days <= 15 & !is.na(plan_type), na.rm = T),
      `Perm Plan Submitted and Approved within 45 days` = sum(total_days <= 45 & !is.na(plan_type), na.rm = T),
      `% Children in Custody 45 Days` = round((`Children in Custody 45 Days`/`Children in Custody 45 Days`)*100, 2),
      `% Perm Plan Submitted in 30 Days` = round((`Perm Plan Submitted in 30 Days`/`Children in Custody 45 Days`)*100,2),
      `% PErm Plan approved in 15 days` = round((`Perm Plan approved within 15 days`/`Children in Custody 45 Days`)*100,2),
      `% Perm Plan Submitted and Approved within 45 days` = round((`Perm Plan Submitted and Approved within 45 days`/ `Children in Custody 45 Days`)*100, 2)
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_6.1.d')
}

permplans_expanded_details_6.1.d.1 <- permanency_plans(expanded_start, expanded_end) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(),msa_start, period_end_date, 'msa_6.1.d_initial_permplan_expanded_details', 'msa_6.1.d') 


initial_permplan_approved_msa <- permplans_expanded_details_6.1.d.1 %>%
  dplyr::filter(
    (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
    `custody_start`  >= msa_start, 
    `custody_start`  <= period_end_date,
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45
  ) %>%
  dplyr::group_by(`child_id`, `custody_sequence_number`, `plan_type`) %>%
  dplyr::arrange(child_id, fsp_id, plan_id, plan_sequence_number ) %>%
  dplyr::distinct(child_id, .keep_all = T) %>%
  dplyr::filter(plan_type == "Permanency"|is.na(plan_id)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(submitted_days = difftime(fsp_submitted, custody_start, units = "days"),
                approved_days = difftime(fsp_approved, fsp_submitted, units = "days"),
                total_days = difftime(fsp_approved, custody_start, unit = "days")) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.1.d_initial_permplan_msa_details',
    'msa_6.1.d'
  )

initial_permplan_approved_currentq <-permplans_expanded_details_6.1.d.1 %>%
  dplyr::filter(
    (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
    custody_start %m+% days(45) >= currentq_start
  ) %>%
  dplyr::group_by(`child_id`, `custody_sequence_number`, `plan_type`) %>%
  dplyr::arrange(child_id, fsp_id, plan_id, plan_sequence_number ) %>%
  dplyr::distinct(child_id, .keep_all = T) %>%
  dplyr::filter(plan_type == "Permanency"|is.na(plan_id)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(submitted_days = difftime(fsp_submitted, custody_start, units = "days"),
                approved_days = difftime(fsp_approved, fsp_submitted, units = "days"),
                total_days = difftime(fsp_approved, custody_start, unit = "days")) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.1.d_initial_permplan_currentq_details','msa_6.1.d' )

initial_permplan_approval_currentq_test <- custody_currentq %>%
  dplyr::left_join(initial_permplan_approved_currentq, by = c("child_id", "custody_sequence_number"))
 
compare_6.1.a_6.1.d <- initital_fsp_currentq %>%
  dplyr::anti_join(initial_permplan_approved_currentq, by = ("child_id" = "child_id"))

comp_6.1.d_6.1.a <- initial_permplan_approved_currentq %>%
  dplyr::anti_join(initital_fsp_currentq, by = ("child_id" = "child_id"))
initial_permplan_approved_county_summary <- initial_permplan_approved_currentq %>%
  dplyr::group_by(region, county) %>%
  initial_permplan_approved_summarise('msa_6.1.d_initial_permplan_currentq_county_summary')

initial_permplan_approved_region_summary <- initial_permplan_approved_currentq %>%
  dplyr::group_by(region) %>%
  initial_permplan_approved_summarise('msa_6.1.d_initial_permplan_currentq_region_summary')

initial_permplan_approved_state_msa_summary <- initial_permplan_approved_msa %>%
  dplyr::group_by() %>%
  initial_permplan_approved_summarise('msa_6.1.d_initial_permplan_msa_state_summary')

initial_permplan_approved_state_currentq_summary <- initial_permplan_approval_currentq_test %>%
  dplyr::group_by() %>%
  initial_permplan_approved_summarise('msa_6.1.d_initial_permplan_curretnq_state_summary')  %>%
  dplyr::ungroup()
```

```{r msa_6.2.a_concurrent_planning, eval=FALSE, include=FALSE}
 concurrent_planning_summarise <- function(data, filename) {
   data %>%
     dplyr::summarise(
       `Children in Care Six Months` = n(),
       `# With Concurrent Plans at Six Months` = sum(
         `Evidence of Concurrent Planning`,
         na.rm = T
       ),
       `% With Concurrent Plans at Six Months` = round(
         (`# With Concurrent Plans at Six Months`/n())*100, 2
       ),
       `AVG Days to Start Concurrent Planning` = round(mean(
         `Days to Start First Concurrent Plan`,
         na.rm = T
       ), 2)
     ) %>%
     save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_6.2.a')
 }

 concurrent_planning <- permplans_expanded_details_6.1.d.1 %>%
   dplyr::filter(
     `custody_start` %m+% months(6) >= msa_start,
     `custody_start` %m+% months(6) <= period_end_date,
     (`custody_start` %m+% months(6) <= `custody_end` | is.na(`custody_end`))
   ) %>%
   dplyr::select(
     `run_date`:`custody_sequence_number`,
     `plan_id`:`plan_timestamp`
   ) %>%
   save_files(
     Sys.Date(),
     prior_year_start,
     prior_year_end,
     'Concurrent_Planning_Details',
     'msa_6.2.a'
   ) %>%
   dplyr::group_by(`child_id`, `custody_sequence_number`) %>%
   dplyr::filter(
     any(
       `plan_type` == 'Permanency' &
         `plan_name` == 'Reunif W/aPrim Caretkr Parents'
     )
   ) %>%
   dplyr::ungroup() %>%
   dplyr::group_by_at(.vars = c(1:14)) %>%
   dplyr::summarise(
     `Evidence of Concurrent Planning` = any(
       `plan_type` == 'Concurrent' &
         `plan_start` <= `custody_start` %m+% months(6) &
         (`plan_end` >= `custody_start` %m+% months(6) | is.na(`plan_end`)),
       na.rm = T
     ),
     `First Concurrent Plan Start` = min(
       `plan_start`[`plan_type` == 'Concurrent'],
       na.rm = T
     )
   ) %>%
   dplyr::mutate(
     `Days to Start First Concurrent Plan` = difftime(
       `First Concurrent Plan Start`,
       `custody_start`,
       unit = 'days'
     )
   ) %>%
   save_files(
     Sys.Date(),
     prior_year_start,
     prior_year_end,
     'Concurrent_Planning_Child_Summary',
     'msa_6.2.a'
   )

 concurrent_planning_county_summary <- concurrent_planning %>%
   dplyr::group_by(region, county) %>%
   concurrent_planning_summarise('Concurrent_Planning_county_Summary')

 concurrent_planning_region_summary <- concurrent_planning %>%
   dplyr::group_by(region) %>%
   concurrent_planning_summarise('Concurrent_Planning_region_Summary')

 concurrent_planning_state_summary <- concurrent_planning %>%
   dplyr::group_by() %>%
   concurrent_planning_summarise('Concurrent_Planning_State_Summary')
 
 initial_concplan_approved_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Children in Custody 45 Days` = n(),
      `Perm Plan Submitted in 30 Days` = sum(submitted_days <= 30 & !is.na(plan_type), na.rm = T),
      `Perm Plan approved within 15 days` = sum(approved_days <= 15 & !is.na(plan_type), na.rm = T),
      `Perm Plan Submitted and Approved within 45 days` = sum(total_days <= 45 & !is.na(plan_type), na.rm = T),
      `% Children in Custody 45 Days` = round((`Children in Custody 45 Days`/`Children in Custody 45 Days`)*100, 2),
      `% Perm Plan Submitted in 30 Days` = round((`Perm Plan Submitted in 30 Days`/`Children in Custody 45 Days`)*100,2),
      `% PErm Plan approved in 15 days` = round((`Perm Plan approved within 15 days`/`Children in Custody 45 Days`)*100,2),
      `% Perm Plan Submitted and Approved within 45 days` = round((`Perm Plan Submitted and Approved within 45 days`/ `Children in Custody 45 Days`)*100, 2)
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_6.2.a')
}

permplans_expanded_details_6.2.a <- permanency_plans(expanded_start, expanded_end) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(),msa_start, period_end_date, 'msa_6.2.a_concurplan_expanded_details', 'msa_6.2.a') 


initial_concplan_approved_msa <- permplans_expanded_details_6.2.a %>%
  dplyr::filter(
    (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
    `custody_start`  >= msa_start, 
    `custody_start`  <= period_end_date,
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45
  ) %>%
  dplyr::group_by(`child_id`, `custody_sequence_number`, `plan_type`) %>%
  dplyr::arrange(child_id, fsp_id, plan_id, plan_sequence_number ) %>%
  dplyr::distinct(child_id, .keep_all = T) %>%
  dplyr::filter(plan_type == "Permanency"|is.na(plan_id)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(submitted_days = difftime(fsp_submitted, custody_start, units = "days"),
                approved_days = difftime(fsp_approved, fsp_submitted, units = "days"),
                total_days = difftime(fsp_approved, custody_start, unit = "days")) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.1.d_initial_permplan_msa_details',
    'msa_6.1.d'
  )

initial_concplan_approved_currentq <-permplans_expanded_details_6.1.d.1 %>%
  dplyr::filter(
    (`custody_start` %m+% days(45) <= `custody_end` | is.na(`custody_end`)),
    difftime(period_end_date, `custody_start`, unit = 'days') >= 45,
    custody_start %m+% days(45) >= currentq_start
  ) %>%
  dplyr::group_by(`child_id`, `custody_sequence_number`, `plan_type`) %>%
  dplyr::arrange(child_id, fsp_id, plan_id, plan_sequence_number ) %>%
  dplyr::distinct(child_id, .keep_all = T) %>%
  dplyr::filter(plan_type == "Concurrent"|is.na(plan_id)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(submitted_days = difftime(fsp_submitted, custody_start, units = "days"),
                approved_days = difftime(fsp_approved, fsp_submitted, units = "days"),
                total_days = difftime(fsp_approved, custody_start, unit = "days")) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.1.d_initial_permplan_currentq_details',
    'msa_6.1.d'
  )

initial_concplan_approval_currentq_test <- custody_currentq %>%
  dplyr::left_join(initial_permplan_approved_currentq, by = c("child_id", "custody_sequence_number"))
 
compare_6.1.a_6.1.d <- initital_fsp_currentq %>%
  dplyr::anti_join(initial_permplan_approved_currentq, by = ("child_id" = "child_id"))

comp_6.1.d_6.1.a <- initial_permplan_approved_currentq %>%
  dplyr::anti_join(initital_fsp_currentq, by = ("child_id" = "child_id"))
initial_permplan_approved_county_summary <- initial_permplan_approved_currentq %>%
  dplyr::group_by(region, county) %>%
  initial_permplan_approved_summarise('msa_6.2.a_initial_permplan_currentq_county_summary')

initial_concplan_approved_region_summary <- initial_concplan_approved_currentq %>%
  dplyr::group_by(region) %>%
  initial_permplan_approved_summarise('msa_6.2.a_initial_permplan_currentq_region_summary')

initial_concplan_approved_state_msa_summary <- initial_concplan_approved_msa %>%
  dplyr::group_by() %>%
  initial_permplan_approved_summarise('msa_6.2.a_initial_permplan_msa_state_summary')

initial_concplan_approved_state_currentq_summary <- initial_concplan_approval_currentq_test %>%
  dplyr::group_by() %>%
  initial_permplan_approved_summarise('msa_6.2.a_initial_permplan_curretnq_state_summary')  %>%
  dplyr::ungroup()

```

```{r msa_6.3.a.1.a_period_end_permplans_reunificaiton, include=FALSE}
expanded_permplans_details <- permanency_plans(expanded_start, period_censor_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'permanency_plans_expanded', 'population_overview')

quarterend_permplans <- expanded_permplans_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)
                ) %>%
  dplyr::group_by(child_id, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::filter(fsp_approved <= params$end_date|is.na(fsp_approved)) %>%
  dplyr::arrange(child_id, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::filter(plan_type == "Permanency" |is.na(plan_type)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(dplyr::row_number() == 1)

cust_children_with_permplan <- expanded_pop_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)
                ) %>%
  dplyr::left_join(quarterend_permplans %>% dplyr::select(-isn)) %>%
  dplyr::mutate(days_custody = as.integer(difftime(params$end_date, custody_start, unit = "days"))) %>%
  dplyr::mutate(permplan_chart = as.factor(case_when(
                  !is.na(plan_name) ~ as.character(plan_name),
                  is.na(plan_name) & days_custody <= 45 ~ "No Plan Documented - Less than 45 Days in Custody",
                  is.na(plan_name) & days_custody > 45 ~ "No Plan Documented - No current approved FSP",
                  TRUE ~ "Check"
                )))


quarterend_concurrentplans <- expanded_permplans_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)
                ) %>%
  dplyr::group_by(child_id, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::filter(fsp_approved <= params$end_date|is.na(fsp_approved)) %>%
  dplyr::arrange(child_id, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::filter(plan_type == "Concurrent" |is.na(plan_type)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id ) %>%
  dplyr::filter(dplyr::row_number() == 1)

cust_children_with_concurrentplan <- expanded_pop_details  %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)) %>%
  dplyr::left_join(quarterend_concurrentplans %>% dplyr::select(-isn)) %>%
  dplyr::mutate(days_custody = as.integer(difftime(params$end_date, custody_start, unit = "days"))) %>%
  dplyr::mutate(permplan_chart = as.factor(case_when(
                  !is.na(plan_name) ~ as.character(plan_name),
                  is.na(plan_name) & days_custody <= 45 ~ "No Plan Documented - Less than 45 Days in Custody",
                  is.na(plan_name) & days_custody > 45 ~ "No Plan Documented - No current approved FSP",
                  TRUE ~ "Check"
                )))

msa_6.3.a.1_perm_plan <- cust_children_with_permplan %>%
  dplyr::filter(plan_name == "Reunif W/aPrim Caretkr Parents") %>%
  save_files(Sys.Date(), params$end_date, params$end_date, 'msa_6.3.a.1_reuni_permplan_detials', 'msa_6.3.a.1') 

msa_6.3.a.1_conc_plan <- cust_children_with_concurrentplan %>%
  dplyr::filter(plan_name == "Reunif W/aPrim Caretkr Parents") %>%
  save_files(Sys.Date(), params$end_date, params$end_date, 'msa_6.3.a.1_reuni_concurrentplan_details', 'msa_6.3.a.1') 

msa_6.3.d.1_perm_plan <- cust_children_with_permplan %>%
  dplyr::filter(plan_name %in% c("Custody W/ a Relative", "Rel Plc Durable Legal Custody", "Dur Legal Cust/Guardianship")) %>%
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_6.3.d.1_durablelegal_permplan_details', 'msa_6.3.d.1') 

msa_6.3.d.1_concurrent <- cust_children_with_concurrentplan %>%
  dplyr::filter(plan_name %in% c("Custody W/ a Relative", "Rel Plc Durable Legal Custody", "Dur Legal Cust/Guardianship")) %>%
  save_files(Sys.Date(), period_end_date, period_end_date, 'msa_6.3.d.1_durablelegal_concurrent_details', 'msa_6.3.d.1') 

```

```{r msa_6.3.a.2, include=FALSE}
reun_parent_contacts_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `# Parents` = n(),
      `Parents Contacted` = sum(`contacts_this_month` > 0)
      # `AVG Days Without Contact at Period End` = mean(
      #   `days_since_last_contact`)
    ) %>%
    dplyr::summarise(
      `# Number of Cases With Children Who are to be Reunified` = n(),
      `# Cases Where Each Parent Contacted` = sum(`# Parents` == `Parents Contacted`),
      `# Cases Where at least One Parent Contacted` = sum(`Parents Contacted` > 0),
      `% Each Parent Contacted` = round(( `# Cases Where Each Parent Contacted`/n())*100, 2),
      `% At least One Parent Contacted` = round((`# Cases Where at least One Parent Contacted`/`# Number of Cases With Children Who are to be Reunified`)*100, 2)
      # `AVG Days Without Contact at Period End` = mean(
      #   (`# Parents` * `AVG Days Without Contact at Period End`)/`# Parents`
      # )
    ) %>%
    save_files(Sys.Date(), prior_year_start, prior_year_end, filename, 'msa_6.3.a.2')
}

reun_parent_contacts <- fod_worker_cust_par_contacts_yearly() %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::filter(reunification == 'Y') %>%
  save_files(
   Sys.Date(),
    msa_start, 
   period_end_date, 
    'msa_6.3.a.2_custody_parent_contacts_expanded_details', 
    'msa_6.3.a.2'
  ) 

reun_parent_contacts_county_summary <- reun_parent_contacts %>%
  dplyr::group_by(period_name, region, county, `child_id`) %>%
  reun_parent_contacts_summarise('msa_6.3.a.2_custody_parent_contacts_county_summary')

reun_parent_contacts_region_summary <- reun_parent_contacts %>%
  dplyr::group_by(period_name, region, `child_id`) %>%
  reun_parent_contacts_summarise('msa_6.3.a.2_custody_parent_contacts_region_summary')

reun_parent_contacts_state_summary <- reun_parent_contacts %>%
  dplyr::group_by(period_name, `case_id`) %>%
  reun_parent_contacts_summarise('msa_6.3.a.2_custody_parent_contacts_state_summary')  %>%
  dplyr::ungroup()
  
```

```{r msa_6.3.a.3_reunification_outcomes, include=FALSE}
expanded_pop_details <- custody_children(expanded_start, period_censor_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::left_join(custody_outcomes(expanded_start, expanded_end) %>% dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower)) %>%
  dplyr::distinct(`child_id`, custody_start,.keep_all = TRUE) %>%
  save_files(Sys.Date(), expanded_start, period_censor_date, 'msa2_6.3.a.3_custody_outcomes_expanded_details', 'msa2_6.3.a.3')

period_reunification_details <- expanded_pop_details %>%
  dplyr::mutate() %>%
  dplyr::filter(
                service_outcome == "Reunify with parents/caretaker",
                custody_end >= params$start_date,
                custody_end <= period_end_date) %>%
  dplyr::arrange(custody_end) 

msa_6.3.a.3_unique_children <- period_reunification_details %>%
  dplyr::distinct(child_id) %>%
  dplyr::summarise(n())
  
closing_summary_narrative <- closing_summary_narratives()

period_case_members <- custody_case_members(msa_start,period_censor_date)

period_reuni_with_Case <- period_reunification_details %>%
  dplyr::left_join(period_case_members, by = c("child_id" = "person_id")) %>%
  dplyr::arrange(`child_id`, desc(`case_member_end`)) %>%
  dplyr::distinct(`child_id`, `custody_end`, .keep_all = TRUE) %>%
  dplyr::left_join((closing_summary_narrative %>%
                      dplyr::filter(`contact_type` == "Closing Summary") %>%
                      dplyr::distinct(`case_id`, .keep_all = TRUE))) %>%
  dplyr::select(1:11, 14, 24:32) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa2_6.3.a.4_custody_outcomes_reunification_closing_summary_msa_details', 'msa_6.3.a.4')

period_reuni_with_Case <- expanded_pop_details %>%
  dplyr::mutate() %>%
  dplyr::filter(
                service_outcome == "Reunify with parents/caretaker",
                custody_end >= currentq_start,
                custody_end <= period_end_date) %>%
  dplyr::arrange(custody_end)  %>%
  dplyr::left_join(period_case_members, by = c("child_id" = "person_id")) %>%
  dplyr::arrange(`child_id`, desc(`case_member_end`)) %>%
  dplyr::distinct(`child_id`, `custody_end`, .keep_all = TRUE) %>%
  dplyr::left_join((closing_summary_narrative %>%
                      dplyr::filter(`contact_type` == "Closing Summary") %>%
                      dplyr::distinct(`case_id`, .keep_all = TRUE))) %>%
  dplyr::select(1:11, 14, 24:32) %>%
  save_files(Sys.Date(), currentq_start, period_end_date, 'msa2_6.3.a.4_custody_outcomes_reunification_closing_summary_currentq_details', 'msa_6.3.a.4')

reunification_closing_summary <- period_reunification_details %>%
  dplyr::left_join(closing_summary_narrative, by = c("child_id" = "participant_id"))  %>%
  dplyr::ungroup()
```

```{sql thv_approval_indicator, connection=con, include=FALSE, output.var="expanded_thv_indicator"}
select [Child ID]
    ,[Custody Start]
    ,[Custody End]
		,[Custody Sequence Number]
		,[Court Type]
		,[Court Order Date]
		,[THV Indicator]
	from 
		[dbo].[mdcpsde_thv_approvals] 
		where [Court Order Date] <= ?sql_period_censor_end
		and [Custody Start] <= ?sql_period_censor_end
		and ISNUll([Custody End], GETDATE()) >= ?sql_expanded_start
```

```{r msa_6.3.a.5, include=FALSE}
thv_approval_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Children in Custody more than 90 days who Reunified During the Period` = n(),
      `Children Reunified with a Permanency Plan of Reunification` = sum(plan_name == "Reunif W/aPrim Caretkr Parents"),
      `# with THV` = sum(stringr::str_detect(`facility_type`, 'Own Home'), na.rm = T),
      `# with a THV wtih YC Approval` = sum(`thv_indicator_child_level` == 'Y', na.rm = T),
      `% with THV` = round((`# with THV`/n())*100, 2),
      `% with a THV wtih YC Approval` = round((`# with a THV wtih YC Approval`/n())*100, 2)
      ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_6.3.a.5')
}

quarter_thv_approval_indicator <- expanded_thv_indicator %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::mutate(custody_sequence_number = as.integer(custody_sequence_number)) %>%
  dplyr::filter(custody_start <= period_end_date, 
                custody_end >= currentq_start,
                court_order_date >= msa_start,
                court_order_date <= period_end_date)

thv_approval <- thv_yc_approval(currentq_start, period_end_date) %>%
   dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::mutate(quarter = zoo::as.yearqtr(custody_end, by='quarters')) %>%
  dplyr::group_by(child_id) %>%
  dplyr::arrange(child_id,desc(fsp_id), desc(plan_id)) %>%
  dplyr::filter(!is.na(plan_end)) %>%
  dplyr::distinct(child_id, .keep_all = TRUE) %>%
  dplyr::filter(
    difftime(`custody_end`, `custody_start`, unit = 'days') >= 90
  ) %>%
  dplyr::left_join(quarter_thv_approval_indicator, by = c("child_id" = "child_id", "custody_sequence_number" = "custody_sequence_number")) %>%
  dplyr::mutate(thv_indicator_child_level = {if (any(thv_indicator == "Y" & !is.na(thv_indicator))) "Y" else "N"}) %>%
  dplyr::ungroup() %>%
  dplyr::distinct(child_id, .keep_all = TRUE) %>%
  save_files(
    Sys.Date(),
    msa_start, 
    period_end_date,
    'THV_Prior_to_Reunification_Details',
    'msa_6.3.a.5'
  )
  

thv_approval_county_summary <- thv_approval %>%
  dplyr::group_by(quarter, region, county) %>%
  thv_approval_summarise('THV_Prior_to_Reunification_county_Summary')

thv_approval_region_summary <- thv_approval %>%
  dplyr::group_by(quarter, region) %>%
  thv_approval_summarise('THV_Prior_to_Reunification_region_Summary')

thv_approval_state_summary <- thv_approval %>%
  dplyr::group_by(quarter) %>%
  thv_approval_summarise('THV_Prior_to_Reunification_State_Summary')  %>%
  dplyr::ungroup()
```

```{r msa_6_3_b_1, include=FALSE}
adoption_assn_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Children with Perm Plan Adoption` = n(),
      `# with Adoption Worker Assigned` = sum(`adoption_worker_assigned`),
      `% with Adoption Worker Assigned` = round(
        (`# with Adoption Worker Assigned`/`Children with Perm Plan Adoption`)*100,
        2
      )
    ) %>%
    save_files(Sys.Date(), msa_start, period_end_date, filename, 'msa_6.3.b.1')
}

adoption_assn <- adoption_assignments(params$start_date, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  save_files(
    period_censor_date,
    msa_start,
    period_end_date,
    'msa_6.3.b.1_adoption_assignments_period_details',
    'msa_6.3.b.1'
  ) %>%
  dplyr::group_by_at(.vars = c(1:14)) %>%
  dplyr::summarise(
    `adoption_worker_assigned` = any(!is.na(adoption_worker_id))
  ) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.3.b.1_adoption_assignments_child_summary',
    'msa_6.3.b.1'
  )

z <- closing_summary_narrative %>% 
  dplyr::filter(`contact_type` == "Adoption Status Meeting") %>%
     dplyr::group_by(`case_id`) %>%
      dplyr::mutate(most_recent_status_meeting = max(`narrative_datetime`)) %>%
  dplyr::arrange(desc(`narrative_datetime`)) %>%
  dplyr::distinct(`case_id`, .keep_all = T)

adoption_assnstatusmeeting <- adoption_assn %>%
  dplyr::left_join(z, by = c("case_id" = "case_id")) %>%
  save_files(
    period_censor_date,
    msa_start,
    period_end_date,
    'msa_6.3.b.1_adoption_assignments_child_details',
    'msa_6.3.b.1'
  )
    

adoption_assn_county_summary <- adoption_assn %>%
  dplyr::group_by(region, county) %>%
  adoption_assn_summarise('msa_6.3.b.1_adoption_assignments_county_summary')

adoption_assn_region_summary <- adoption_assn %>%
  dplyr::group_by(region) %>%
  adoption_assn_summarise('msa_6.3.b.1_adoption_assignments_region_summary')

adoption_assn_state_summary <- adoption_assn %>%
  dplyr::group_by() %>%
  adoption_assn_summarise('msa_6.3.b.1_adoption_assignments_state_summary')  %>%
  dplyr::ungroup()
  
```

```{r msa_6_3_b_2, include=FALSE}

# Changed the Stored Procedure [mdcpsde_gen_tpr_timeframes] in database for period end date 
# --declare @last_day_of_period date = EOMONTH(DATEADD(MM, -1, @query_date)) -- Written by Scott Swafford
# --declare @last_day_of_period date = EOMONTH(DATEADD(MM, 0, @query_date)) -- Changed by Haritha Chekuru


tpr_17_of_22_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Total Children` = n(),
      `Children in Care 17/22 Months` = sum(
        `in_custody_17/22_months` == 'Yes' &
          `child_remains_in_custody` == 'Yes'
      ),
      `# In Care 17/22 Months,TPR Submitted` = sum(
        `in_custody_17/22_months` == 'Yes' &
          `child_remains_in_custody` == 'Yes' & `tpr_submitted_with_17_months` == 'Yes'),
      `% In Care 17/22 Months,TPR Submitted` = round(( `# In Care 17/22 Months,TPR Submitted`/`Children in Care 17/22 Months`) * 100,2),
      `# In Care 17/22 Months, TPR Referred` = sum(
        `in_custody_17/22_months` == 'Yes' &
          `child_remains_in_custody` == 'Yes' & `tpr_referred_to_ag_within_17_months` == 'Yes' & !is.na(`tpr_referred_to_ag_within_17_months`)),
      `% In Care 17/22 Months, TPR Referred` = round((`# In Care 17/22 Months, TPR Referred`/`Children in Care 17/22 Months`) * 100,2),
      `# in care 17/22 months with ASFA excpetion documented` = sum(`in_custody_17/22_months` == 'Yes' &
          `child_remains_in_custody` == 'Yes' &
          `asfa_exception_noted` == 'Yes'),
       `% in care 17/22 months with ASFA excpetion documented` =round((`# in care 17/22 months with ASFA excpetion documented`/`Children in Care 17/22 Months`) * 100,2),
        `# In Care 17/22 Months,TPR Submitted/exception noted within 17 months` = sum(
        `in_custody_17/22_months` == 'Yes' &
          `child_remains_in_custody` == 'Yes' &
          (`asfa_exception_noted` == 'Yes'|`tpr_submitted_with_17_months` == 'Yes')
      ),
       `% In Care 17/22 Months,TPR Submitted/exception noted within 17 months` = round(((`# In Care 17/22 Months,TPR Submitted`+ `# in care 17/22 months with ASFA excpetion documented`)/`Children in Care 17/22 Months`) * 100,2),
      `% In Care 17/22 Months, TPR Referred/exception noted within 17 months` =  round(((`% In Care 17/22 Months, TPR Referred` + `# in care 17/22 months with ASFA excpetion documented`)/`Children in Care 17/22 Months`) * 100,2)) %>% 
    save_files(Sys.Date(), tpr_msa_start, tpr_period_end_date, filename, 'msa_6.3.b.2')
}

tpr_17_of_22 <- tpr_timeframes(tpr_period_end_date) %>%
    save_files(
    period_censor_date, 
    tpr_msa_start, 
    expanded_end, 
    'TPR_Timeframes_Details', 
    'msa_6.3.b.2'
  )

tpr_17_of_22_fixed <- tpr_17_of_22 %>%
  dplyr::filter(`custody_end` >= period_end_date|is.na(`custody_end`)) %>%
   dplyr::group_by() %>%
  tpr_17_of_22_summarise('TPR_Timeframes_State_Summary')
  
 
tpr_17_of_22_county_summary <- tpr_17_of_22 %>%
  dplyr::group_by(region, county) %>%
  tpr_17_of_22_summarise('TPR_Timeframes_county_Summary')

tpr_17_of_22_cregion_summary <- tpr_17_of_22 %>%
  dplyr::group_by(region) %>%
  tpr_17_of_22_summarise('TPR_Timeframes_region_Summary')

tpr_17_of_22_state_summary <- tpr_17_of_22 %>%
  dplyr::group_by() %>%
  tpr_17_of_22_summarise('TPR_Timeframes_State_Summary')
  
```

```{r msa_6_3_b_3, include=FALSE}
referrals_and_petitions <- custody_child_demographics(
    msa_start, 
    period_end_date
  ) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::select(
    region, county, child_id, `custody_start`, `custody_end`, `person_name`
  ) %>%
  dplyr::left_join(
    tpr_17_of_22 %>%
      dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
      dplyr::select(`child_id`, `tpr_referred_to_ag`) %>%
      dplyr::filter(
        `tpr_referred_to_ag` >= msa_start,
        `tpr_referred_to_ag` <= period_end_date
      )
  ) %>%
  dplyr::left_join(
    court_events(msa_start, period_end_date) %>%
      dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
       dplyr::select_all(tolower) %>%
      dplyr::filter(
        `event_type` == 'TPR Petition Filed',
        `order_effective` >= msa_start,
        `order_effective` <= period_end_date
      ) %>%
      dplyr::select(
        child_id, `order_effective`
      ) %>%
      dplyr::rename(
        `tpr_petition_filed` = `order_effective`
      )
  ) %>%
  dplyr::filter(
    !is.na(tpr_referred_to_ag) | !is.na(`tpr_petition_filed`)
  ) %>%
  save_files(
    Sys.Date(),
    msa_start, 
    period_end_date, 
    'TPR_Referrals_and_Petitions_Details',
    'msa_6.3.b.3'
  )
```


```{r msa_6.3.e_appla_duringperiod}
dob <- custody_child_demographics(date_filter = T, msa_start, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::select(child_id, date_of_birth)

msa_6.3.e_appla_perm <- permplans_expanded_details_6.1.d.1 %>%
  dplyr::filter(fsp_approved >= params$start_date, fsp_approved <= period_end_date,
                plan_type == "Permanency",
                plan_name == "APPLA") %>%
  dplyr::group_by(child_id, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::arrange(child_id, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(dplyr::row_number() == 1) %>%
  dplyr::left_join(dob) %>%
  save_files(Sys.Date(), params$start_date, period_end_date, 'msa_6.3.e_appla_permplan_period_details', 'msa_6.3.e')

msa_6.3.e_appla_concurrent <- permplans_expanded_details_6.1.d.1 %>%
  dplyr::filter(fsp_approved >= params$start_date, fsp_approved <= period_end_date,
                plan_type == "Concurrent",
                plan_name == "APPLA") %>%
  dplyr::group_by(child_id, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::arrange(child_id, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(dplyr::row_number() == 1) %>%
  dplyr::left_join(dob) %>%
  save_files(Sys.Date(), params$start_date, period_end_date, 'msa_6.3.e_appla_concurrent_period_details', 'msa_6.3.e')



```

```{r msa_6_4_a, include=FALSE}
case_reviews_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Children Due for Foster Care Review During Period` = n(),
      `Children Receiving Timely Foster Care Review` = sum(review_timely_days <= 0, na.rm = T),
      `Children Not Receiving Timely Foster Care Review` = sum(review_timely_days > 0|is.na(review_timely_days)),
      `% Children Receiving Timely Foster Care Review` = round((`Children Receiving Timely Foster Care Review`/`Children Due for Foster Care Review During Period`)*100, 2),
      `% Children Not Receiving Timely Foster Care Review` = round(( `Children Not Receiving Timely Foster Care Review`/`Children Due for Foster Care Review During Period`)*100, 2)) %>%
    save_files(Sys.Date(), currentq_start, period_end_date, filename, 'msa_6.4.a')
}
a
case_reviews  <- all_fcr_children(expanded_start, period_end_date) %>%
  dplyr::ungroup() %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::filter(review_date >= custody_start) %>%
  dplyr::rename(`foster_care_review` = `review_date`) %>%
  save_files(
    Sys.Date(),
   msa_start,
    period_end_date,
    'msa_6.4.a_fostercarereviews_expanded_details',
    'msa_6.4.a'
  )
#case_reviews$foster_care_review <- as.Date(case_reviews$foster_care_review)
 
# case_reviews <- custody_children(msa_start, period_end_date) %>%
#   dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
#   dplyr::select_all(tolower) %>%
#   dplyr::left_join(all_fcr_reviews,  by = c("child_id" = "person_id")) %>%
#   dplyr::filter(review_date >= custody_start) %>%
#   dplyr::rename(`foster_care_review` = `review_date`) %>%
#   save_files(
#     Sys.Date(),
#    msa_start,
#     period_end_date,
#     'msa_6.4.a_fostercarereviews_expanded_details',
#     'msa_6.4.a'
#   )
case_reviews$foster_care_review <- as.Date(case_reviews$foster_care_review)


prior_period_reviews <- case_reviews %>% 
  dplyr::group_by(child_id) %>%
  dplyr::filter(foster_care_review < currentq_start) %>%
  dplyr::mutate(last_review_before_period = as.Date(max(foster_care_review))) %>%
  # dplyr::select(1:6, 18) %>%  Commented out by HC
  dplyr::distinct(child_id, last_review_before_period)

 # Added by Haritha Chekuru 4/8/2019 In order to get new column permanency_review_indicator in to the file 
permanency_review_indicator <- case_reviews %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(foster_care_review >= currentq_start, foster_care_review <= period_end_date) %>%
  dplyr::mutate(permanency_review_indicator = permanency_review_indicator)%>%
 dplyr::distinct(child_id, permanency_review_indicator)


conference_complete_date <- case_reviews %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(foster_care_review >= currentq_start, foster_care_review <= period_end_date) %>%
  dplyr::mutate(conference_complete_date = conference_complete_date)%>%
 dplyr::distinct(child_id, conference_complete_date)

# Changes ended - Haritha Chekuru

current_period_reviews <- case_reviews %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(foster_care_review >= currentq_start, foster_care_review <= period_end_date) %>%
  dplyr::mutate(first_review_in_period = as.Date(min(foster_care_review))) %>%
  dplyr::mutate(most_recent_review = as.Date(max(foster_care_review))) %>%
  dplyr::distinct(child_id, first_review_in_period, most_recent_review)

  
msa_6.4.a_population <- custody_children(currentq_start, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  
  dplyr::filter(`custody_start` %m+% months(6) <= period_end_date,
                (`custody_start` %m+% months(6) <= `custody_end` | is.na(`custody_end`))) %>%
  
  dplyr::left_join(prior_period_reviews, by = "child_id") %>%
  
  dplyr::mutate(next_review_due = if_else(is.na(last_review_before_period), custody_start %m+% months(6),last_review_before_period %m+% months(6))) %>%
  
  dplyr::filter(next_review_due <= period_end_date, 
                (is.na(custody_end)|custody_end >= next_review_due)) %>%
  
  dplyr::left_join(current_period_reviews, by = "child_id") %>%
  
  dplyr::mutate(review_period_indicator = if_else(!is.na(first_review_in_period),"Y","N"),
                review_timely_indicator = if_else(first_review_in_period <= next_review_due, "Y","N"),
                review_timely_days = interval(next_review_due, first_review_in_period) %/% days(1)
                ) %>%
  # Added by Haritha 4/8/2019 In order to get new column permanency_review_indicator in to the file 
  
  dplyr::left_join(permanency_review_indicator, by = "child_id") %>%

  dplyr::mutate(permanency_review_indicator = permanency_review_indicator)%>%
  
  dplyr::left_join(conference_complete_date, by = "child_id") %>%

  dplyr::mutate(conference_complete_date = conference_complete_date)%>%
  
  # Changes ended - Haritha
  
  save_files(
    Sys.Date(),
   currentq_start,
    period_end_date,
    'msa_6.4.a_fostercarereviews_due_period_details',
    'msa_6.4.a'
  ) 

msa_6.4.a_delay_summary <- msa_6.4.a_population %>%
  dplyr::filter(review_timely_days > 0|is.na(review_timely_days)) %>%
  dplyr::summarise(
    `Children not Receiving a Review` = sum(review_period_indicator == "N"),
    `Children Receiving Review less than 30 Days Late` = sum(review_timely_days < 30, na.rm = T),
    `Children Receiving Review 30 to 60 Days Late` = sum(review_timely_days >= 30 & review_timely_days <= 60, na.rm = T),
    `Chidlren Receiving Review 61+ Days Late` = sum(review_timely_days >= 61, na.rm = T)
      )
  

case_reviews_county_summary <- msa_6.4.a_population %>%
  dplyr::group_by(region, county) %>%
  case_reviews_summarise('msa_6.4.a_Custody_Case_reviews_county_Summary')

case_reviews_region_summary <- msa_6.4.a_population %>%
  dplyr::group_by(region) %>%
  case_reviews_summarise('msa_6.4.a_Custody_Case_reviews_region_Summary')

case_reviews_state_summary <- msa_6.4.a_population %>%
  case_reviews_summarise('msa_6.4.a_Custody_Case_reviews_State_Summary')  %>%
  dplyr::ungroup()
```

```{r msa_6_4_b, include=FALSE}
court_reviews_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
     `Children Due for Court Hearing During the Period` = n(),
      `Children Receiving Timely Court Hearing` = sum(review_timely_days <= 0, na.rm = T),
      `Children Receiving Untimely Court Hearing` = sum(review_timely_days > 0, na.rm = T),
      `Children Not Receiving Court Hearing` = sum(is.na(review_timely_days)),
      `% Children Receiving Timely Court Hearing` = round((`Children Receiving Timely Court Hearing`/`Children Due for Court Hearing During the Period`)*100, 2),
      `% Children Receiving Untimely Court Hearing` =  round((`Children Receiving Untimely Court Hearing`/`Children Due for Court Hearing During the Period`)*100, 2),
      `% Children Not Receiving Court Hearing` = round(( `Children Not Receiving Court Hearing`/`Children Due for Court Hearing During the Period`)*100, 2)) %>%
    save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_6.4.b')
}

court_reviews_expanded <- custody_children(currentq_start, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
    dplyr::filter(
    `custody_start` %m+% months(12) <= period_end_date,
    (`custody_start` %m+% months(12) <= `custody_end` | is.na(`custody_end`))) %>%
  dplyr::left_join((
    court_events(arbitrarystart, period_end_date) %>%
      dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
      dplyr::select_all(tolower) %>%
      dplyr::filter(
        `event_type` %in% c(
          'Permanency Hearing', 
          'Six Month Review', 
          'Dispositional'
        )) %>%
  dplyr::rename(
        `custody_tracking_number` = `court_tracking_number`,
        `review_type` = `event_type`,
        `review_date` = `order_effective`)), by = "child_id") %>%
  dplyr::arrange(`review_date`) %>%
  save_files(
    Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.4.b_custody_court_reviews_expanded_details',
    'msa_6.4.b') 

all_court_events <- court_events(arbitrarystart, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::rename(
        `custody_tracking_number` = `court_tracking_number`,
        `review_type` = `event_type`,
        `review_date` = `order_effective`)

prior_period_court_reviews <-court_reviews_expanded %>%
  dplyr::filter(review_date <= currentq_start,
                review_type %in% c('Permanency Hearing', 'Six Month Review', 'Dispositional'),
                review_date >= custody_start) %>%
  dplyr::group_by(child_id) %>%
  dplyr::mutate(last_review_before_period = as.Date(max(review_date))) %>%
  dplyr::select(child_id, last_review_before_period) %>%
  dplyr::distinct(child_id, .keep_all = TRUE)

current_period_court_reviews <- court_reviews_expanded %>%
   dplyr::filter(review_date >= currentq_start,
                review_type %in% c('Permanency Hearing', 'Six Month Review', 'Dispositional'),
                review_date >= custody_start) %>%
  dplyr::group_by(child_id) %>%
  dplyr::mutate(period_review_date = as.Date(min(review_date))) %>%
  dplyr::distinct(child_id, .keep_all = TRUE) %>%
  dplyr::select(child_id, court_event_id, review_type, review_date)
  
msa_6.4.b_population <- custody_children(currentq_start, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::filter(
    `custody_start` %m+% months(12) <= period_end_date,
    (`custody_start` %m+% months(12) <= `custody_end` | is.na(`custody_end`))) %>%
  dplyr::left_join(prior_period_court_reviews) %>%
  dplyr::mutate(next_review_due = if_else(is.na(last_review_before_period), custody_start %m+% months(12), last_review_before_period %m+% months(12))) %>%
  dplyr::left_join(current_period_court_reviews) %>%
  dplyr::mutate(review_period_indicator = if_else(!is.na(review_date),"Y","N"),
                review_timely_days = interval(next_review_due, review_date) %/% days(1)) %>%
  dplyr::filter(next_review_due <= period_end_date, 
                (is.na(custody_end)|custody_end >= next_review_due)) %>%
  save_files(Sys.Date(),
    msa_start,
    period_end_date,
    'msa_6.4.b_custody_court_reviews_period_details',
    'msa_6.4.b') 

msa_6.4.b_dqc_1 <- msa_6.4.b_population %>%
  dplyr::anti_join(current_period_court_reviews, by = "child_id")

msa_6.4.b_dqc_2 <- current_period_court_reviews %>%
  dplyr::anti_join(msa_6.4.b_population, by = "child_id")

msa_6.4.b_delay_summary <- msa_6.4.b_population %>%
  dplyr::filter(review_timely_days > 0) %>%
  dplyr::summarise(
    `Children Receiving Court Hearing Less Than 30 Days Late` = sum(review_timely_days < 30, na.rm = T),
    `Children Receiving Court Hearing 30 to 60 Days Late` = sum(review_timely_days >= 30 & review_timely_days <=60, na.rm = T),
    `Children Receiving Court Hearing More than 61+ Days Late` = sum(review_timely_days >= 61, na.rm = T)
      )
 
court_reviews_county_summary <- msa_6.4.b_population %>% 
  dplyr::group_by(`region`, `county`) %>% 
  court_reviews_summarise('Custody_Court_Reviews_county_Summary')

court_reviews_region_summary <-msa_6.4.b_population %>% dplyr::group_by(`region`) %>%
  court_reviews_summarise('Custody_Court_Reviews_region_Summary')

court_reviews_state_summary <- msa_6.4.b_population %>%
  dplyr::group_by() %>%
  court_reviews_summarise('Custody_Court_Reviews_State_Summary')  %>%
  dplyr::ungroup()
```

```{r msa_6_5_a, eval=FALSE, include=FALSE}
# perm_outcomes_summarise <- function(data, filename) {
#   data %>%
#     dplyr::summarise(
#       `Total Children` = n(),
#       `# Permanency in 12 Months` = sum(as.integer(`Permanency in 12 Months`)),
#       `% Permanency in 12 Months` = round(
#         (`# Permanency in 12 Months`/`Total Children`)*100, 
#         2
#       ),
#       `# Permanency Not Achieved` = `Total Children` - `# Permanency in 12 Months`,
#       `% Permanency Not Achieved` = 100 - `% Permanency in 12 Months`,
#       `Median Months in Custody` = median(`Months in Custody`, na.rm = T)
#     ) %>%
#     save_files(Sys.Date(),prior_year_start, prior_year_end, filename, 'msa_6_5_a')
# }
# 
# perm_outcomes <- custody_child_rr_outcomes(ec_year_start, prior_year_end) %>%
#   dplyr::select(`run_date`:`Legally Free Date`) %>%
#   dplyr::mutate(
#     `Entered in Period` = `custody_start` >= ec_year_start & 
#       `custody_start` <= ec_year_end,
#     `Stayed Through Period` = `custody_start` <= ec_year_start &
#       (is.na(custody_end) | custody_end >= prior_year_start)
#   ) %>%
#   dplyr::filter(`Entered in Period` | `Stayed Through Period`) %>%
#   dplyr::mutate(
#     `Days in Custody` = difftime(
#       pmin(custody_end, prior_year_end, na.rm = T),
#       `custody_start`,
#       units = 'days'
#     ),
#     `Months in Custody at Measurement Date` = floor(as.period(interval(
#       `custody_start`,
#       pmin(custody_end, prior_year_start, na.rm = T)
#     ))/months(1)),
#     Cohort = as.character(cut(
#       `Months in Custody at Measurement Date`,
#       breaks = c(0, 11, 23, Inf),
#       labels = c(
#         'Entry Cohort', 
#         'First Day Cohort, In Care 12-23 Months', 
#         'First Day Cohort, In Care 24+ Months'
#       ),
#       include.lowest = T
#     )),
#     Cohort = dplyr::if_else(
#       `custody_start` == ec_year_start,
#       'Entry Cohort',
#       Cohort
#     ),
#     Cohort = factor(Cohort),
#     `Trial Home Visit` = stringr::str_detect(
#       `Most Recent Placement Type`, 
#       'Own Home'
#     ) & !is.na(
#       `Most Recent Placement Type`
#     ),
#     `Days in Current Placement` = floor(interval(
#         `placement_start`,
#         pmin(custody_end, lubridate::today(), na.rm = T)
#       )/days(1)),
#     `THV Over 30 Days and Reunified` = `Trial Home Visit` &
#       `Days in Current Placement` > 30 &
#       stringr::str_detect(`Service Outcome`, 'Reunify') &
#       custody_end <= lubridate::today(),
#     `Adjusted Custody End Date` = dplyr::if_else(
#       `THV Over 30 Days and Reunified`,
#       `placement_start` %m+% months(1),
#       custody_end
#     ),
#     `Months in Custody` = dplyr::if_else(
#       Cohort == 'Entry Cohort',
#       floor(as.period(interval(
#         `custody_start`,
#         `Adjusted Custody End Date`
#       ))/months(1)),
#       floor(as.period(interval(
#         prior_year_start,
#         `Adjusted Custody End Date`
#       ))/months(1))
#     ),
#     `Service Outcome` = dplyr::if_else(
#       `Adjusted Custody End Date` >= prior_year_end | is.na(`Adjusted Custody End Date`),
#       as.character('Remaining in Care'),
#       as.character(`Service Outcome`)
#     ),
#     `Achieved Permanency` = `Service Outcome` %in% c(
#         'Reunify with parents/caretaker', 
#         'Guardianship', 
#         'Adoption'
#     ),
#     `Permanency in 12 Months` = `Months in Custody` < 12 & 
#       `Achieved Permanency`,
#     
#     `Service Outcome` = factor(
#       `Service Outcome`,
#       levels = sort(unique(`Service Outcome`))
#     )
#   ) %>%
#   dplyr::group_by(`child_id`) %>% 
#   dplyr::filter(
#     `custody_sequence_number` == min(`custody_sequence_number`),
#     `Adjusted Custody End Date` >= prior_year_start | 
#       is.na(`Adjusted Custody End Date`) |
#       Cohort == 'Entry Cohort'
#   ) %>%
#   dplyr::ungroup() %>%
#   dplyr::filter(`Days in Custody` >= 8) %>% #Remove short stayers from the analysis
#   dplyr::rename(`Final Living Arrangment` = `Most Recent Placement Type`) %>%
#   save_files(
#     period_censor_date,
#     prior_year_start, 
#     prior_year_end, 
#     'Permanency_Outcomes_Details', 
#     'msa_6_5_a'
#   )
# 
# perm_outcomes_county_summary <- perm_outcomes %>%
#   dplyr::group_by(region, county, Cohort) %>%
#   perm_outcomes_summarise('Permanency_Outcomes_county_Summary')
# 
# perm_outcomes_region_summary <- perm_outcomes %>%
#   dplyr::group_by(region, Cohort) %>%
#   perm_outcomes_summarise('Permanency_Outcomes_region_Summary')
# 
# perm_outcomes_state_summary <- perm_outcomes %>%
#   dplyr::group_by(Cohort) %>%
#   perm_outcomes_summarise('Permanency_Outcomes_State_Summary')
```

```{sql msa_7.5_startup_funds, connection=con, output.var='msa_7.5_IL_STARTUP_all'}
SELECT [SUPP_SERVICE_ID]
      ,[SUPP_ISP_ID]
      ,[SUPP_PERS_ID]
      ,[SUPP_RESOURCE_ID]
      ,ct.[CODE_SHORT_DESC]
      ,[SUPP_AVAILABILITY]
      ,[SUPP_START_DATE]
      ,[SUPP_END_DATE]
      ,[SUPP_REQUIRED_DATE]
      ,[SUPP_STATUS]
      ,[SUPP_AMNT_REQUEST]
      ,[SUPP_ASWS_ACTN]
      ,[SUPP_ASWS_DATE]
      ,[SUPP_SO_ID]
      ,[SUPP_SO_ACTN]
      ,[SUPP_SO_DATE]
      ,[SUPP_UNITS]
      ,[SUPP_COST_UNIT]
      ,[SUPP_FUND]
      ,[SUPP_COR_COUNTY]
      ,[SUPP_PO_NMBR]
      ,[SUPP_LAST_UPDATE_ID]
      ,[SUPP_INTAKE_ID]
      ,[SUPP_CHECK_TYPE]
      ,[SUPP_COS_COUNTY]
      ,[SUPP_PAY_STATUS]
   FROM MW_SUPP_SRVC,  MW_CODE_TABLE ct
     where SUPP_SERVICE_CODE = '4050'
	 and ct.CODE_TABLE_NAME = 'EXPCODE'
	 and ct.CODE_TABLE_VALUE = SUPP_SERVICE_CODE
```

```{sql msa_7.6_etv_funds, connection=con, output.var='msa_7.6_etv_funds_all'}
SELECT [SUPP_SERVICE_ID]
      ,[SUPP_ISP_ID]
      ,[SUPP_PERS_ID]
      ,[SUPP_RESOURCE_ID]
      ,ct.[CODE_SHORT_DESC]
      ,[SUPP_AVAILABILITY]
      ,[SUPP_START_DATE]
      ,[SUPP_END_DATE]
      ,[SUPP_REQUIRED_DATE]
      ,[SUPP_STATUS]
      ,[SUPP_AMNT_REQUEST]
      ,[SUPP_ASWS_ACTN]
      ,[SUPP_ASWS_DATE]
      ,[SUPP_SO_ID]
      ,[SUPP_SO_ACTN]
      ,[SUPP_SO_DATE]
      ,[SUPP_UNITS]
      ,[SUPP_COST_UNIT]
      ,[SUPP_FUND]
      ,[SUPP_COR_COUNTY]
      ,[SUPP_PO_NMBR]
      ,[SUPP_LAST_UPDATE_ID]
      ,[SUPP_INTAKE_ID]
      ,[SUPP_CHECK_TYPE]
      
      ,[SUPP_COS_COUNTY]
      ,[SUPP_PAY_STATUS]
   FROM MW_SUPP_SRVC,  MW_CODE_TABLE ct
     where SUPP_SERVICE_CODE = '4250'
	 and ct.CODE_TABLE_NAME = 'EXPCODE'
	 and ct.CODE_TABLE_VALUE = SUPP_SERVICE_CODE
```


```{sql msa_7.3_il_skills_groups, connection=con, include=FALSE, output.var='msa_7.3_il_skills_all'}
declare @skill_codes table(
	[Skill Code] varchar(5),
	[Skill Number] int,
	[Description] varchar(50)
);
-- Table containing all skills groups per child
declare @skills_groups table(
	[Child ID] int,
	[Skills Group Sequence] int,
	[Skills Group Date] date,
	[Description] varchar(50),
	primary key([Child ID], [Skills Group Sequence])
);
-- Table containing all IL services per child
declare @il_services table(
	[Child ID] int,
	[Service Sequence] int,
	[Service Date] date,
	[Description] varchar(50),
	primary key([Child ID], [Service Sequence])
);
-- Table containing each child's most recent skill or service
declare @recent_skills_services table(
	[Child ID] int not null,
	[Skill or Service Date] date,
	[Skill or Service] varchar(50)
);

insert into @skill_codes
values	('135CR', 1, 'Community Resources/Transportation'),
	('135CM', 2, 'Communication/Social Development'),
	('135EM', 3, 'Employment'),
	('135MM', 4, 'Money Management'),
	('135PS', 5, 'Descision Making/Study Skills'),
	('135HS', 6, 'Housing'),
	('135DL', 7, 'Daily Living Skills'),
	('135SF', 8, 'Self Care'),
	('135YL', 9, 'Youth Law Issues'),
	('135RE', 10, 'Relationship')


insert into @skills_groups
select EVHI_EVAL_ID as 'Child ID',
	ROW_NUMBER() over (
		partition by EVHI_EVAL_ID
		order by EVHI_TL_DATE_SKILLS_GR_DT
	) as 'Skills Group Sequence',
	EVHI_TL_DATE_SKILLS_GR_DT as 'Skills Group Date',
	sc.Description
from MW_EVAL_HISTORY evhi,
	MW_EVAL_HISTORY_B_SKIL evski,
	@skill_codes sc
where evhi.EVHI_EVAL_TYPE = 'PLAN'
	and evski.ISN = evhi.ISN
	and sc.[Skill Number] = evski.EVHI_TL_DATE_SKILLS_GROUP_TAB_IND
--	and EVHI_TL_DATE_SKILLS_GR_DT <= '20180630'
--	and EVHI_TL_DATE_SKILLS_GR_DT >= '20180101'
order by 3

select * from @skills_groups
```

```{r 7.1_youtth_transition_pop, include=FALSE}
a <- custody_child_demographics(date_filter = T, expanded_start, period_censor_date) %>%
   dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower)

msa_7.1_expanded_population <- expanded_pop_details %>%
  dplyr::left_join(a) %>%
  dplyr::mutate(age_period_start = age(`date_of_birth`, age.day = msa_7.0_start),
                age_period_end = age(`date_of_birth`, age.day = period_end_date),
                age_exit = age(`date_of_birth`, age.day = custody_end))

msa_7.1_youth_exiting <- msa_7.1_expanded_population %>%
  dplyr::filter(custody_end >= msa_7.0_start,
                custody_end <= period_end_date) %>%
  dplyr::filter(age_exit >= 16) %>%
  dplyr::group_by(child_id) %>%
  dplyr::arrange(child_id, desc(custody_sequence_number)) %>%
  dplyr::distinct(child_id, .keep_all = TRUE) %>%
  dplyr::select(region, county, child_id, person_name,custody_start, custody_end, date_of_birth, medicaid_number, age_exit, service_outcome) %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.0_exits_youth14plus', 'msa_7.0')

childid_list_7.1 <- as.list(msa_7.1_youth_exiting$child_id)

msa_7.1_permplan <- expanded_permplans_details %>%
  dplyr::filter(child_id %in% childid_list_7.1) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::filter(plan_end <= custody_end + 2) %>%
  dplyr::arrange(child_id, custody_sequence_number, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::filter(plan_type == "Permanency") %>%
  dplyr::select(child_id, fsp_id, fsp_approved, plan_type, plan_name) %>%
  dplyr::filter(dplyr::row_number() == 1)

msa_7.1_combined <- msa_7.1_youth_exiting %>%
  dplyr::left_join(msa_7.1_permplan, by = "child_id") %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.0_youth_exting_withplan_atexit', 'msa_7.0') %>%
  dplyr::filter(plan_name == "APPLA") %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.1_youth_transition_indep_period_details', 'msa_7.1')

msa_7.2_population <- msa_7.1_expanded_population %>%
  dplyr::filter(age_period_end >= 14) %>%
  dplyr::filter(custody_end >= period_end_date|is.na(custody_end),
                custody_start <= period_end_date) %>%
  dplyr::select(region, county, child_id, custody_start, custody_end, custody_tracking_number, person_name, date_of_birth, gender, ethnicity, medicaid_number, race, age_period_end) %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.2_youth_age14_period_end_details', 'msa_7.2')


msa_7.3_population <- msa_7.2_population %>%
  dplyr::mutate('Community Resources/Transportation' = " ",
                'Communication/Social Development' = " ",
                'Employment' = " ",
                'Money Management' = " ",
                'Descision Making/Study Skills' = " ",
                'Housing' = " ",
                'Daily Living Skills' = " ",
                'Self Care' = " ",
                'Youth Law Issues' = " ",
                'Relationship' = " ")



msa_7.x_population <- msa_7.1_expanded_population %>%
  dplyr::filter(custody_end >= msa_7.0_start,
                custody_end <= period_end_date) %>%
  dplyr::filter(age_exit >= 18, service_outcome == "Emancipation") %>%
  dplyr::group_by(child_id) %>%
  dplyr::arrange(child_id, desc(custody_sequence_number))


msa_7.5_stipend_summary <- msa_7.5_IL_STARTUP_all %>%
  dplyr::filter(SUPP_SO_ACTN == "A") %>%
  dplyr::group_by(SUPP_PERS_ID) %>%
  dplyr::filter(SUPP_SO_DATE >= msa_7.0_start) %>%
  dplyr::summarise(total_received = sum(SUPP_COST_UNIT))

msa_7.6_etv_summary <- msa_7.6_etv_funds_all %>%
  dplyr::filter(SUPP_SO_ACTN == "A") %>%
  dplyr::group_by(SUPP_PERS_ID) %>%
  dplyr::filter(SUPP_SO_DATE >= as.Date("2017-08-01")) %>%
  dplyr::summarise(total_received = sum(SUPP_COST_UNIT))

msa_7.6_population <- msa_7.x_population %>%
  dplyr::left_join(msa_7.6_etv_summary, by = c("child_id" = "SUPP_PERS_ID")) %>%
  dplyr::mutate(stipend_received = ifelse(total_received >0 , "Y", "N")) %>%
  dplyr::select(region, county, child_id, `person_name`, `date_of_birth`, gender, ethnicity, race, custody_start, custody_end, service_outcome, age_exit, stipend_received, total_received) %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.6_youth_etv_stipend_details', 'msa_7.6')

msa_7.5_population <- msa_7.x_population %>%
  dplyr::left_join(msa_7.5_stipend_summary, by = c("child_id" = "SUPP_PERS_ID")) %>%
  dplyr::mutate(stipend_received = ifelse(total_received >0 , "Y", "N")) %>%
  dplyr::select(region, county, child_id, `person_name`, `date_of_birth`, gender, ethnicity, race, custody_start, custody_end, service_outcome, age_exit, stipend_received, total_received) %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.5_youth_emancipated_stipend_details', 'msa_7.5')


msa_7.8_emancipated <- msa_7.1_expanded_population %>%
  dplyr::filter(custody_end >= msa_7.0_start,
                custody_end <= period_end_date) %>%
  dplyr::filter(age_exit >= 18, service_outcome == "Emancipation") %>%
  dplyr::group_by(child_id) %>%
  dplyr::arrange(child_id, desc(custody_sequence_number), county) %>%
  dplyr::select(region, county, child_id, `person_name`, `date_of_birth`, gender, ethnicity, race, tribal_affil, custody_start, custody_end, age_exit) %>%
  dplyr::mutate(msa_7.8.a = " ",
                msa_7.8.b = " ",
                msa_7.8.c = " ",
                msa_7.8.d = " ",
                msa_7.8.e = " ",
                msa_7.8.f = " ",
                msa_7.8.g = " ",
                msa_7.8.h = " ",
                msa_7.8.i = " ",
                msa_7.8.j = " ",
                msa_7.8.k = " ") %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.8_emancipation_population', 'msa_7.8')

msa_7.0_appla_perm <- expanded_permplans_details %>%
  dplyr::filter(custody_start <= params$end_date & (is.na(custody_end)|custody_end > params$end_date)
                ) %>%
  dplyr::group_by(child_id, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::filter(fsp_approved <= params$end_date) %>%
  dplyr::arrange(child_id, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::filter(plan_type == "Permanency" |is.na(plan_type)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id ) %>%
  dplyr::filter(dplyr::row_number() == 1) %>%
  dplyr::left_join(dob) 

msa_7.8_custody <- msa_7.1_expanded_population %>%
  dplyr::filter(custody_end >= period_end_date|is.na(custody_end)) %>%
  dplyr::filter(age_period_end > 16, age_period_end <= 18) %>%
  dplyr::group_by(child_id) %>%
  dplyr::arrange(child_id, desc(custody_sequence_number)) %>%
  dplyr::distinct(child_id, .keep_all = TRUE) %>%
  dplyr::left_join(msa_7.0_appla_perm, by = "child_id") %>%
  dplyr::filter(age_period_end %in% c("17" ,"18")) %>%
  dplyr::filter(plan_name == "APPLA") %>%
  dplyr::arrange(child_id) %>%
  dplyr::mutate(msa_7.8.a = "",
                msa_7.8.b = "",
                msa_7.8.c = "",
                msa_7.8.d = "",
                msa_7.8.e = "",
                msa_7.8.f = "",
                msa_7.8.g = "",
                msa_7.8.h = "",
                msa_7.8.i = "",
                msa_7.8.j = "",
                msa_7.8.k = "") %>%
  save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.8_appla_population', 'msa_7.8')


# msa_7.8.k_appla_list <- msa_7.1_expanded_population %>%
#   dplyr::left_join(msa_7.0_appla_perm, by = "child_id") %>%
#   dplyr::filter(fsp_approved >= msa_7.0_start, fsp_approved <= period_end_date,
#                 plan_type == "Permanency",
#                 plan_name == "APPLA") %>%
#   dplyr::arrange(child_id, desc(fsp_id), desc(plan_id)) %>%
#   dplyr::distinct(child_id, .keep_all = TRUE) %>%
#   dplyr::filter(age_period_end %in% c(17, 18),
#                 (custody_end.x >= period_end_date|is.na(custody_end.x))) %>%
#   dplyr::mutate(msa_7.8.a = "",
#                 msa_7.8.b = "",
#                 msa_7.8.c = "",
#                 msa_7.8.d = "",
#                 msa_7.8.e = "",
#                 msa_7.8.f = "",
#                 msa_7.8.g = "",
#                 msa_7.8.h = "",
#                 msa_7.8.i = "",
#                 msa_7.8.j = "",
#                 msa_7.8.k = "") %>%
#   save_files(Sys.Date(), msa_7.0_start, period_end_date, 'msa_7.8_appla_population', 'msa_7.8')

```

```{r msa_8_1_a, eval=FALSE, include=FALSE}
initial_medicals_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Total Children` = n(),
      `Initial Medical Exams Timely` = sum(
        `initial_medical_exam_timely` == 'Y'
      ),
      `% Initial Medical Exams Timely` = round(
        (`Initial Medical Exams Timely`/n())*100, 2
      )
    ) %>%
   save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_8.1.a')
}

initial_medicals <- medical_services_table(msa_start, period_end_date) %>%
  dplyr::select(region:`initial_medical_exam_timely`) %>%
  dplyr::filter(`custody_start` >= msa_start, `custody_start` <= period_end_date) %>%
  dplyr::distinct(`child_id`, .keep_all = T) %>%
   dplyr::filter(`custody_start` %m+% days(7) <= `custody_end` | is.na(`custody_end`),
       difftime(period_end_date, `custody_start`, unit = 'days') >= 7) %>%
 save_files(
    Sys.Date(),
    msa_start, 
    period_end_date, 
    'msa_8.1.a_Initial_Medicals_Details', 
    'msa_8.1.a'
  ) %>%
  dplyr::mutate(year_month = format(custody_start, "%m-%Y" )) %>%
  dplyr::group_by(year_month) 

initial_medicals_county_summary <- initial_medicals %>%
  dplyr::group_by(year_month, region, county) %>%
  initial_medicals_summarise('Initial_Medicals_County_Summary')

initial_medicals_region_summary <- initial_medicals %>%
  dplyr::group_by(year_month, region) %>%
  initial_medicals_summarise('Initial_Medicals_Region_Summary')

initial_medicals_state_summary <- initial_medicals %>%
  dplyr::group_by(year_month) %>%
  initial_medicals_summarise('Initial_Medicals_State_Summary')  %>%
  dplyr::ungroup()

msa_8.1a_compare <- initial_medicals %>%
  dplyr::anti_join(expanded_pop_details %>% dplyr::filter(custody_start >= msa_start, custody_start <= period_end_date), by = c("child_id" = "child_id"))

library(xlsx)
write.xlsx(as.data.frame(initial_medicals), file="initial_medicals.xlsx", sheetName="sheet1", row.names=FALSE)
write.xlsx(as.data.frame(initial_medicals_state_summary), file="initial_medicals.xlsx", sheetName="sheet2", append=TRUE, row.names=FALSE)
```

```{r msa_8_1_b, eval=FALSE, include=FALSE}
comprehensive_medicals_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Total Children` = n(),
      `First Comp Medical Exams Timely` = sum(`first_comp_medical_timely` == 'Y'),
      `% First Comp Medical Exams Timely` = round(
        (`First Comp Medical Exams Timely`/n())*100, 2
      )
    ) %>%
   save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_8.1.b')
}

comprehensive_medicals <- medical_services_table(msa_start, period_end_date) %>%
  dplyr::select(
   region:custody_sequence_number,
    first_comp_medical_due_date:first_comp_medical_timely
  ) %>%
  dplyr::filter(custody_start >= msa_start, 
                custody_start <= period_end_date,
                custody_start %m+% days(60) <= custody_end | is.na(custody_end),
       difftime(period_end_date, custody_start, unit = 'days') >= 60) %>%
 save_files(Sys.Date(),
    msa_start, 
    period_end_date, 
    'msa_8.1.b_Comprehensive_Medicals_Details', 
    'msa_8.1.b'
  ) %>%
  dplyr::mutate(year_month = paste(lubridate::month(custody_start),lubridate::year(custody_start),sep="-")) %>%
  dplyr::filter(lubridate::year(custody_start) == 2018) %>%
  dplyr::group_by(year_month) 

comprehensive_medicals_county_summary <- comprehensive_medicals %>%
  dplyr::group_by(region, county) %>%
  comprehensive_medicals_summarise('Comprehensive_Medicals_County_Summary')

comprehensive_medicals_region_summary <- comprehensive_medicals %>%
  dplyr::group_by(region) %>%
  comprehensive_medicals_summarise('Comprehensive_Medicals_Region_Summary')

comprehensive_medicals_state_summary <- comprehensive_medicals %>%
  dplyr::group_by() %>%
  comprehensive_medicals_summarise('Comprehensive_Medicals_State_Summary')  %>%
  dplyr::ungroup()

write.xlsx(as.data.frame(comprehensive_medicals), file="comprehensive_medicals.xlsx", sheetName="sheet1", row.names=FALSE)
write.xlsx(as.data.frame(comprehensive_medicals_state_summary), file="comprehensive_medicals.xlsx", sheetName="sheet2", append=TRUE, row.names=FALSE)
```

```{r msa_8_1_c, eval=FALSE, include=FALSE}
epsdt_exams_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Total Children` = n(),
      `Required EPSDT 1` = sum(!is.na(`epsdt_1_due_date`)),
      `EPSDT 1 Timely` = sum(`EPSDT 1 Timely` == 'Y', na.rm = T),
      `Required EPSDT 2` = sum(!is.na(`epsdt_2_due_date`)),
      `EPSDT 2 Timely` = sum(`EPSDT 2 Timely` == 'Y', na.rm = T),
      `Required EPSDT 3` = sum(!is.na(`epsdt_3_due_date`)),
      `EPSDT 3 Timely` = sum(`EPSDT 3 Timely` == 'Y', na.rm = T),
      `Required EPSDT 4` = sum(!is.na(`epsdt_4_due_date`)),
      `EPSDT 4 Timely` = sum(`EPSDT 4 Timely` == 'Y', na.rm = T),
      `Required EPSDT 5` = sum(!is.na(`epsdt_5_due_date`)),
      `EPSDT 5 Timely` = sum(`EPSDT 5 Timely` == 'Y', na.rm = T),
      `Required EPSDT 6` = sum(!is.na(`epsdt_6_due_date`)),
      `EPSDT 6 Timely` = sum(`EPSDT 6 Timely` == 'Y', na.rm = T),
      `Required EPSDT 7` = sum(!is.na(`epsdt_7_due_date`)),
      `EPSDT 7 Timely` = sum(`EPSDT 7 Timely` == 'Y', na.rm = T),
      `Required EPSDT 8` = sum(!is.na(`epsdt_8_due_date`)),
      `EPSDT 8 Timely` = sum(`EPSDT 8 Timely` == 'Y', na.rm = T),
      `Required EPSDT 9` = sum(!is.na(`epsdt_9_due_date`)),
      `EPSDT 9 Timely` = sum(`EPSDT 9 Timely` == 'Y', na.rm = T),
      `Required EPSDT 10` = sum(!is.na(`epsdt_10_due_date`)),
      `EPSDT 10 Timely` = sum(`EPSDT 10 Timely` == 'Y', na.rm = T),
      `Required EPSDT 11` = sum(!is.na(`epsdt_11_due_date`)),
      `EPSDT 11 Timely` = sum(`EPSDT 11 Timely` == 'Y', na.rm = T),
      `Any EPSDT Exam Required` = sum(!is.na(`epsdt_screenings_timely`)),
      `EPSDT Exams Timely` = sum(`epsdt_screenings_timely` == 'Y', na.rm = T),
      `% EPSDT Exams Timely` = round(
        (`EPSDT Exams Timely`/`Any EPSDT Exam Required`)*100, 2
      )
    ) %>%
   save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_8.1.c')
}

epsdt_exams <- medical_services_table(msa_start, period_end_date) %>%
  dplyr::select(
    region:`custody_sequence_number`,
    dplyr::contains('EPSDT')
  ) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::filter(child_dob %m+% months(30) >= msa_start) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_8.1.c_epsdt_msa_details', 'msa_8.1.c')

epsdt_exams_due <- epsdt_exams %>%
  tidyr::gather(key = "exam", value = "due_date",ends_with("due_date")) %>%
  dplyr::select(child_id, exam, due_date) %>%
  dplyr::filter(due_date >= period_start_date)

epsdt_exams_rec <- epsdt_exams %>%
  tidyr::gather(key = "exam", value = "exam_date",ends_with("exam_date")) %>%
  dplyr::select(child_id, exam, exam_date) %>%
  dplyr::filter(exam_date >= period_start_date)
  
level_key <- list(epsdt_1_due_date = "3-5 days", 
                  epsdt_2_due_date = "Birth - 1 month",
                  epsdt_3_due_date = "2 months",
                  epsdt_4_due_date = "4 months",
                  epsdt_5_due_date = "6 months",
                  epsdt_6_due_date = "9 months",
                  epsdt_7_due_date = "12 months",
                  epsdt_8_due_date = "15 months",
                  epsdt_9_due_date = "18 months",
                  epsdt_10_due_date = "24 months",
                  epsdt_11_due_date = "30 months")
epsdt_exams_due$exam <- dplyr::recode(epsdt_exams_due$exam, !!!level_key)

level_key <- list(epsdt_1_exam_date = "3-5 days", 
                  epsdt_2_exam_date = "Birth - 1 month",
                  epsdt_3_exam_date = "2 months",
                  epsdt_4_exam_date = "4 months",
                  epsdt_5_exam_date = "6 months",
                  epsdt_6_exam_date = "9 months",
                  epsdt_7_exam_date = "12 months",
                  epsdt_8_exam_date = "15 months",
                  epsdt_9_exam_date = "18 months",
                  epsdt_10_exam_date = "24 months",
                  epsdt_11_exam_date = "30 months")
epsdt_exams_rec$exam <- dplyr::recode(epsdt_exams_rec$exam, !!!level_key)

epsdt_tableau <- epsdt_exams %>%
  dplyr::select(region:custody_sequence_number) %>%
  dplyr::left_join(epsdt_exams_due) %>%
  dplyr::left_join(epsdt_exams_rec) %>%
  dplyr::filter(!is.na(exam)) %>%
  dplyr::group_by(exam) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_8.1.c_epsdt_period', 'msa_8.1.c')

epsdt_exams_summary <- epsdt_exams %>%
  dplyr::select(region:custody_sequence_number) %>%
  dplyr::left_join(epsdt_exams_due) %>%
  dplyr::left_join(epsdt_exams_rec) %>%
  dplyr::filter(!is.na(exam)) %>%
  dplyr::group_by(exam) %>%
  dplyr::summarise(children_due = n(),
                   children_rec = sum(!is.na(exam_date)),
                   `%_children_rec` = round(children_rec/children_due*100,2))  %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_8.1.c_epsdt_msa_summary', 'msa_8.1.c')

epsdt_exams_summary$exam <- as.factor(epsdt_exams_summary$exam)
epsdt_exams_summary$exam <- factor(epsdt_exams_summary$exam, levels = c("3-5 days", 
                "Birth - 1 month","2 months","4 months","6 months","9 months","12 months","15 months","18 months","24 months","30 months"))



```

```{r msa_8_1_d, eval=FALSE, include=FALSE}
followup_medicals_summarise <- function(data, filename) {
  data %>%
    dplyr::summarise(
      `Total Children` = n(),
      `Required Followup Exams` = sum(
        !is.na(`Last 2 Yearly Medical Exams Timely`)
      ),
      `Followup Exams Completed` = sum(
        `Last 2 Yearly Medical Exams Timely` == 'Y', na.rm = T
      ),
      `% Followup Exams Completed` = round(
        (`Followup Exams Completed`/`Required Followup Exams`)*100, 2
      )
    ) %>%
   save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_8_1_d')
}

# followup_medicals <- medical_services_table(msa_start, period_end_date) %>%
#   dplyr::select(
#     Region:`Custody Sequence Number`,
#     `Last Yearly Medical Due Date`:`Last 2 Yearly Medical Exams Timely`
#   ) %>%
#  save_files(Sys.Date(),
#     msa_start,
#     period_end_date,
#     'Medical_Followup_Exams_Details',
#     'msa_8.1.d'
#   )


all_medicals_expanded <- medicals_custody_child(msa_start, period_end_date) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
  dplyr::filter(child_dob %m+% months(30) < msa_start)
 
prior_period_followup_medical <- all_medicals_expanded %>%
  dplyr::filter(exam_date < msa_start, exam_type %in% c("EPSDT", "Medical", "Initial Health Screening")) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::mutate(last_medical_before_period = as.Date(max(exam_date))) %>%
  dplyr::distinct(child_id, custody_sequence_number, last_medical_before_period)

current_period_medicals <- all_medicals_expanded %>%
  dplyr::filter(exam_date >= msa_start, exam_type %in% c("EPSDT", "Medical")) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::mutate(most_recent_medical = as.Date(max(exam_date))) %>%
  dplyr::select(child_id, custody_sequence_number, most_recent_medical) %>%
  dplyr::distinct(child_id, custody_sequence_number, .keep_all =T)

age <- custody_child_demographics(date_filter = T, msa_start, period_end_date) %>% dplyr::select(`child_id`, `date_of_birth`)

msa_8.1.cd <- custody_children(msa_start, period_end_date) %>%
  dplyr::left_join(age) %>%
  dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
  dplyr::select_all(tolower) %>%
    dplyr::filter(
    date_of_birth %m+% months(30) < msa_start,
    `custody_start` %m+% months(12) <= period_end_date,
    (`custody_start` %m+% months(12) <= `custody_end` | is.na(`custody_end`))) %>%
  dplyr::left_join(prior_period_followup_medical) %>%
  dplyr::group_by(child_id, custody_sequence_number) %>%
  dplyr::mutate(next_medical_due = if_else(is.na(last_medical_before_period), custody_start %m+% months(12), last_medical_before_period %m+% months(12))) %>%
  dplyr::left_join(current_period_medicals) %>%
  dplyr::mutate(review_period_indicator = if_else(!is.na(most_recent_medical),"Y","N"),
                review_timely_days = interval(next_medical_due, most_recent_medical) %/% days(1)) %>%
  dplyr::filter(next_medical_due <= period_end_date, 
                (is.na(custody_end)|custody_end >= next_medical_due)) %>%
  dplyr::ungroup() %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_8.1.cd_timelymedical_yearly_details', 'msa_8.1.c')

msa_8.1.cd_summary <- msa_8.1.cd %>%
  dplyr::summarise(
    `Children Due for Medical` = n(),
    `Children Receiving Medical Timely` = sum(review_timely_days <= 0, na.rm = T),
    `Children Receiving Medical Late` = sum(review_timely_days > 0, na.rm = T),
    `% Timely` = round(`Children Receiving Medical Timely`/`Children Due for Medical`*100,2),
    `% Untimely` = round(`Children Receiving Medical Late`/`Children Due for Medical`*100,2))  %>%
  dplyr::ungroup() %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_8.1.cd_timelymedical_yearly_summary', 'msa_8.1.c')
  
  
# followup_medicals_state_summary <- followup_medicals %>%
#   dplyr::group_by() %>%
#   followup_medicals_summarise('Medical_Followup_Exams_State_Summary')
```

```{r msa_8_1_e, eval=FALSE, include=FALSE}
dental_exams_summarise <- function(data, filename) {
  data  %>%
    dplyr::summarise(
      `Total Children` = n(),
      `Initial Dental Exams Due` = sum(!is.na(`initial_dental_due_date`),
      `Initial Dental Exams Timely` = sum(
        `Initial Dental Timely` == 'Y', 
        na.rm = T
      ),
      `% Initial Dental Exams Timely` = round(
        (`Initial Dental Exams Timely`/`Initial Dental Exams Due`)*100, 2
      ),
      `Initial Prior to Custody` = sum(
        `Initial Dental Prior to Custody` == 'Y',
        na.rm = T
      ),
      `% Initial Prior to Custody` = round(
        (`Initial Prior to Custody`/`Initial Dental Exams Due`)*100, 2
      ),
      `Followup Dentals Required` = sum(!is.na(`Last 2 Dental Exams Timely`)),
      `Followup Dentals Conducted` = sum(
        `Last 2 Dental Exams Timely` == 'Y',
        na.rm = T
      ),
      `% Followup Dentals Conducted` = round(
        (`Followup Dentals Conducted`/`Followup Dentals Required`)*100, 2
      )
    )) %>%
   save_files(Sys.Date(),msa_start, period_end_date, filename, 'msa_8_1_e')
}

dental_exams <- medical_services_table(msa_start, period_end_date) %>%
  dplyr::select(
    region:`custody_sequence_number`,
    dplyr::contains('Dental')
  )  

initial_dental <- dental_exams %>%
  dplyr::filter(custody_start >= msa_start, 
                custody_start <= period_end_date,
                custody_start %m+% days(90) <= custody_end | is.na(custody_end),
                difftime(period_end_date, custody_start, unit = 'days') >= 90,
                `initial_dental_due_date` >= msa_start,
                `initial_dental_due_date` <= period_end_date,
                `initial_dental_prior_to_custody` == "N"
       ) %>%
 save_files(Sys.Date(),
    msa_start,
    period_end_date,
    'Dental_Exams_Details',
    'msa_8.1.e'
  )
initial_dental_summary <- initial_dental %>%
  dplyr::summarise(`Total Childen with Initial Dental Exam Due` = n(),
                   `Total Receiving Initial Dental` = sum(!is.na(`initial_dental_exam_date`)),
                   `Total Receiving Timely Initial Dental` = sum(`initial_dental_timely` == "Y"),
                   `% Receiving Initial Dental` = round(`Total Receiving Initial Dental`/`Total Childen with Initial Dental Exam Due`*100,2),
                   `% Receiving Timely Initial Dental` = round(`Total Receiving Timely Initial Dental`/`Total Childen with Initial Dental Exam Due` * 100, 2))  %>%
  dplyr::ungroup() %>%
 save_files(Sys.Date(),
    msa_start,
    period_end_date,
    'Dental_Exams_summary',
    'msa_8.1.e'
  )

# dental_exams_county_summary <- dental_exams %>%
#   dplyr::group_by(region, county) %>%
#   dental_exams_summarise('Dental_Exams_County_Summary')
# 
# dental_exams_region_summary <- dental_exams %>%
#   dplyr::group_by(Region) %>%
#   dental_exams_summarise('Dental_Exams_Region_Summary')
# 
# dental_exams_state_summary <- dental_exams %>%
#   dplyr::group_by() %>%
#   dental_exams_summarise('Dental_Exams_State_Summary')


```

```{r education}
school_age_children <- custody_children(msa_start, quarter2_end) %>%
  dplyr::left_join(custody_child_demographics(), by = c("child_id" = "child_id", "custody_sequence_number")) %>%
  dplyr::select(1:9, 18) %>%
  dplyr::filter(`date_of_birth` %m+% years(5) <= msa_start) %>%
  save_files(Sys.Date(), msa_start, quarter2_end, 'msa_8.2.b_8.2.c_schoolage_Children', 'msa_8.2.b')

msa_8.2c_educational_needs <- custody_children(msa_start, quarter2_end) %>%
  dplyr::left_join(custody_child_demographics(), by = c("child_id" = "child_id", "custody_sequence_number")) %>%
  dplyr::select(1:9, 18) %>%
  dplyr::filter(`date_of_birth` %m+% years(3) <= msa_start,
                `date_of_birth` %m+% years(5) > msa_start) %>%
 save_files(Sys.Date(), msa_start, quarter2_end, 'msa_8.2c_children_3to5', 'msa_8.2.b')
```


```{r msa_9.6}
msa_9.6_base <- function(from = Sys.Date(), to = Sys.Date()) {
  db_con <- con
  paste(
    'exec mdcpsde_gen_msa_96_base',
    paste0('\'', gsub('-', '', from), '\','),
      paste0('\'', gsub('-', '', to), '\'')
    ) %>%
    DBI::dbGetQuery(db_con, .) 

}

msa_9.6 <- msa_9.6_base(msa_start, period_end_date) %>%
   dplyr::select_all(~gsub("\\s+|\\.", "_", .)) %>%
    dplyr::select_all(tolower)

most_recent_permplan <- expanded_permplans_details %>%
  dplyr::filter(custody_start <= period_end_date & (is.na(custody_end)|custody_end > msa_start)
                ) %>%
  dplyr::group_by(child_id, custody_sequence_number, fsp_id, plan_id, plan_sequence_number) %>%
  dplyr::filter(fsp_approved <= params$end_date|is.na(fsp_approved)) %>%
  dplyr::arrange(child_id, custody_sequence_number, desc(fsp_id), desc(plan_id), desc(plan_sequence_number)) %>%
  dplyr::filter(plan_type == "Permanency" |is.na(plan_type)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(child_id) %>%
  dplyr::filter(dplyr::row_number() == 1) %>%
  dplyr::select(child_id, custody_sequence_number, fsp_id, plan_id, plan_name)

msa_9.6_final <- msa_9.6 %>%
  dplyr::left_join(most_recent_permplan) %>%
  dplyr::rename(most_recent_placement = facility_type,
                most_recent_plan = plan_name
                ) %>%
  save_files(Sys.Date(), msa_start, period_end_date, 'msa_9.6_details', 'msa_9.6')
```


```{r overall_summary}

library(xlsx)


summary_datas <- list(population_summary, quarter_region_summary, outcomes_period_total, overview_permplan_graph, permplan_qend_summary,ane_reports_received_statewide_summary, mic_investigations_timeliness_statewide_summary,mic_investigations_placements_summary,
home_limits_over_quarter_state_summary,msa_4_2_specialneeds_summary,msa_4_3_leastrestrictive_qend,msa_4_4_50MileRadius_statewide_summary,siblings_placed_together_state_summary,cc_placements_state_summary,monthly_child_contacts_state_summary,thv_contacts_state_summary,foster_parent_contacts_state_summary,initial_fsp_submitted_state_summary_currentq,initial_permplan_approved_state_currentq_summary, msa_6.3.a.1_perm_plan, msa_6.3.a.1_conc_plan,  reun_parent_contacts_state_summary, msa_6.3.a.3_unique_children,msa_6.3.d.1_perm_plan, msa_6.3.d.1_perm_plan, msa_6.3.e_appla_perm, msa_6.3.e_appla_concurrent, thv_approval_state_summary,adoption_assn_state_summary,tpr_17_of_22_state_summary, case_reviews_state_summary,court_reviews_state_summary,initial_medicals_state_summary, comprehensive_medicals_state_summary, epsdt_exams_summary)


wb <- createWorkbook()
sheetnames <- paste0("Sheet", seq_along(summary_datas))
sheets <- lapply(sheetnames, createSheet, wb = wb)
void <- Map(addDataFrame, summary_datas, sheets)
saveWorkbook(wb, file = "q5_summary_data.xlsx")
# summary_datas <- list(population_summary, quarter_region_summary, outcomes_period_total, overview_permplan_graph, permplan_qend_summary,ane_reports_received_statewide_summary, mic_investigations_timeliness_statewide_summary,mic_investigations_placements_summary,
# sub_mic_contacts_state_summary, mic_rate_custody,home_limits_over_quarter_state_summary,msa_4_2_specialneeds_summary,msa_4_3_leastrestrictive_qend,msa_4_4_50MileRadius_statewide_summary,siblings_placed_together_state_summary,cc_placements_state_summary,emergency_placements_state_summary,monthly_child_contacts_state_summary,thv_contacts_state_summary,foster_parent_contacts_state_summary,initial_fsp_submitted_state_summary_currentq,initial_permplan_approved_state_currentq_summary, msa_6.3.a.1_perm_plan, msa_6.3.a.1_conc_plan,  reun_parent_contacts_state_summary, msa_6.3.a.3_unique_children,msa_6.3.d.1_perm_plan, msa_6.3.d.1_perm_plan, msa_6.3.e_appla_perm, msa_6.3.e_appla_concurrent, thv_approval_state_summary,adoption_assn_state_summary,tpr_17_of_22_state_summary, case_reviews_state_summary,court_reviews_state_summary,initial_medicals_state_summary, comprehensive_medicals_state_summary, epsdt_exams_summary, msa_8.1.cd_summary)
# 
# 
# wb <- createWorkbook()
# sheetnames <- paste0("Sheet", seq_along(summary_datas))
# sheets <- lapply(sheetnames, createSheet, wb = wb)
# void <- Map(addDataFrame, summary_datas, sheets)
# saveWorkbook(wb, file = "q3_summay_data.xlsx")
```
